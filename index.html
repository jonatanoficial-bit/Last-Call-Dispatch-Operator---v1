<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Last Call Dispatch Operator ‚Äî Fase 2 (Despacho Manual Realista)</title>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1020;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.18);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.48);
      --ok: #22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --accent:#60a5fa;
      --accent2:#a78bfa;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--txt);
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(96,165,250,.15), transparent 55%),
        radial-gradient(900px 700px at 85% 35%, rgba(167,139,250,.14), transparent 60%),
        radial-gradient(900px 700px at 60% 90%, rgba(239,68,68,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 55%, var(--bg0));
      min-height:100vh;
    }
    .topbar{
      position: sticky; top:0; z-index: 50;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(10,14,28,.92), rgba(10,14,28,.65));
      border-bottom: 1px solid var(--stroke);
    }
    .topbar-inner{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 14px; max-width: 1400px; margin: 0 auto;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width: 220px; }
    .logo{
      width: 34px; height:34px; border-radius: 10px;
      background:
        radial-gradient(circle at 30% 30%, rgba(96,165,250,.85), rgba(167,139,250,.45)),
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.04));
      border: 1px solid var(--stroke2);
      box-shadow: var(--shadow);
    }
    .brand h1{ font-size: 14px; margin:0; line-height: 1.1; letter-spacing: .3px; }
    .brand .sub{ font-size: 11px; color: var(--muted); margin-top: 2px; }

    .topstats{ display:flex; gap:10px; flex-wrap: wrap; justify-content:flex-end; }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--stroke);
      font-size: 12px; color: var(--muted);
    }
    .pill strong{ color: var(--txt); font-weight: 700; }
    .dot{ width: 8px; height: 8px; border-radius: 999px; background: var(--muted2); }
    .dot.ok{ background: var(--ok); }

    .wrap{ max-width: 1400px; margin: 0 auto; padding: 14px; }
    .grid{ display:grid; grid-template-columns: 420px 1fr; gap: 14px; }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px 12px 10px 12px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), transparent);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd h2{
      margin:0; font-size: 12px; letter-spacing: .35px; text-transform: uppercase;
      color: rgba(255,255,255,.78); display:flex; align-items:center; gap:8px;
    }
    .tag{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.75);
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      white-space: nowrap;
    }
    .body{ padding: 12px; }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .field label{ display:block; font-size: 11px; color: var(--muted); margin-bottom: 6px; }
    select, button{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      color: var(--txt);
      padding: 10px 10px;
      font-size: 14px;
      outline: none;
    }
    .btnrow{ display:flex; gap:10px; margin-top: 10px; }
    .btn{
      cursor:pointer;
      border: 1px solid var(--stroke2);
      background:
        radial-gradient(120% 120% at 30% 20%, rgba(96,165,250,.18), rgba(167,139,250,.08)),
        rgba(255,255,255,.05);
      transition: transform .08s ease, filter .15s ease, opacity .15s ease;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,.05);
      border-color: var(--stroke);
      font-weight: 600;
      color: rgba(255,255,255,.86);
    }
    .btn.danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.35);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .split{ display:grid; grid-template-columns: 1fr; gap: 12px; }

    .callbox{
      background: rgba(0,0,0,.24);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .calltop{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding: 10px 10px; border-bottom: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
    }
    .calltop .left{ display:flex; gap:10px; align-items:center; min-width: 0; }
    .avatar{
      width: 36px; height:36px; border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), rgba(255,255,255,.06)),
        linear-gradient(180deg, rgba(96,165,250,.25), rgba(167,139,250,.12));
      border: 1px solid var(--stroke2);
    }
    .callmeta{ min-width: 0; }
    .callmeta .title{
      font-size: 13px; margin:0; white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
    }
    .callmeta .small{
      font-size: 11px; color: var(--muted); margin-top: 2px; font-family: var(--mono);
    }
    .timer{
      display:flex; align-items:center; gap:8px;
      font-family: var(--mono); font-size: 12px; color: rgba(255,255,255,.85);
      white-space: nowrap;
    }
    .bar{
      width: 86px; height: 8px; border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%;
      background: linear-gradient(90deg, rgba(34,197,94,.9), rgba(245,158,11,.9), rgba(239,68,68,.9));
      border-radius: 999px;
      width: 0%;
    }
    .transcript{
      padding: 10px; min-height: 150px; max-height: 220px;
      overflow:auto; font-size: 13px; line-height: 1.4;
    }
    .line{ margin: 0 0 10px 0; color: rgba(255,255,255,.88); }
    .line .who{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.65);
      margin-bottom: 4px;
      display:block;
    }
    .choices{
      display:grid; gap: 8px; padding: 10px;
      border-top: 1px solid var(--stroke);
      background: rgba(255,255,255,.03);
    }
    .choice{
      text-align:left;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--stroke);
      padding: 10px 10px;
      border-radius: 14px;
      cursor:pointer;
      transition: filter .15s ease, transform .08s ease;
      color: rgba(255,255,255,.9);
      font-weight: 650;
    }
    .choice:hover{ filter: brightness(1.06); }
    .choice:active{ transform: translateY(1px); }

    .feed{ display:grid; gap: 10px; }
    .list{ display:grid; gap: 8px; }
    .item{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap: 10px; padding: 10px 10px;
      border-radius: 16px; border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      cursor:pointer;
    }
    .item:hover{ border-color: rgba(255,255,255,.18); }
    .item .a{ min-width:0; }
    .item .t{
      margin:0; font-size: 13px;
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
    }
    .item .s{ margin-top: 4px; font-size: 11px; color: var(--muted); font-family: var(--mono); }
    .sev{
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      color: rgba(255,255,255,.82);
      white-space: nowrap;
    }
    .sev.low{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .sev.med{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .sev.high{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

    .mapcard{
      height: calc(100vh - 100px);
      min-height: 620px;
      display:flex;
      flex-direction:column;
    }

    .mapwrap{
      flex: 1;
      position: relative;
      min-height: 460px;
      background: rgba(0,0,0,.18);
      border-top: 1px solid rgba(255,255,255,.06);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    canvas#mapCanvas{
      width: 100%;
      height: 100%;
      display:block;
      touch-action: none;
    }
    .mapOverlay{
      position:absolute;
      left: 10px; top: 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      pointer-events:none;
    }
    .mini{
      pointer-events:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      border-radius: 14px;
      padding: 8px 10px;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.86);
      max-width: min(620px, 88vw);
    }

    .bottomDock{
      padding: 10px;
      border-top: 1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .dockCol{
      background: rgba(0,0,0,.22);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 10px;
    }
    .dockCol h3{
      margin:0 0 8px 0;
      font-size: 11px;
      letter-spacing: .35px;
      text-transform: uppercase;
      color: rgba(255,255,255,.75);
    }
    .muted{ color: var(--muted); font-size: 12px; line-height: 1.35; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap: wrap; }

    .chip{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.85);
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      white-space: nowrap;
      user-select:none;
    }
    .chip.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .chip.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .chip.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }
    .chip.busy{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .chip.sel{ border-color: rgba(96,165,250,.45); background: rgba(96,165,250,.14); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 999px;
      padding: 10px 14px;
      color: rgba(255,255,255,.92);
      font-size: 13px;
      box-shadow: var(--shadow);
      max-width: min(720px, 92vw);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-2px); }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .mapcard{ height: auto; min-height: 520px; }
      .mapwrap{ min-height: 420px; }
    }
    @media (max-width: 520px){
      .controls{ grid-template-columns: 1fr; }
      .bottomDock{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
      .topstats{ justify-content:flex-start; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Last Call Dispatch Operator</h1>
          <div class="sub">Fase 2 ‚Äî Despacho manual realista (m√∫ltiplas unidades + pend√™ncias)</div>
        </div>
      </div>

      <div class="topstats">
        <div class="pill"><span class="dot" id="dotShift"></span> Turno: <strong id="shiftState">OFF</strong></div>
        <div class="pill">Tempo: <strong id="shiftClock">00:00</strong></div>
        <div class="pill">Pontua√ß√£o: <strong id="score">0</strong></div>
        <div class="pill">N√≠vel: <strong id="lvl">1</strong> <span style="opacity:.6">‚Ä¢</span> XP: <strong id="xp">0</strong></div>
        <div class="pill">Cr√©ditos: <strong id="money">0</strong></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <h2>Central</h2>
          <span class="tag" id="regionTag">BR ‚Ä¢ SP</span>
        </div>

        <div class="body">
          <div class="controls">
            <div class="field">
              <label>Cidade</label>
              <select id="city">
                <option value="saopaulo">S√£o Paulo (BR)</option>
                <option value="nyc">New York (EUA)</option>
              </select>
            </div>
            <div class="field">
              <label>Ag√™ncia</label>
              <select id="agency">
                <option value="police">Pol√≠cia</option>
                <option value="fire">Bombeiros/Resgate</option>
                <option value="mixed">Central Integrada (911/112/CIOSP)</option>
              </select>
            </div>
          </div>

          <div class="btnrow">
            <button class="btn" id="btnStart">Iniciar turno</button>
            <button class="btn secondary" id="btnNextCall" disabled>For√ßar nova chamada</button>
          </div>
          <div class="btnrow">
            <button class="btn secondary" id="btnClearSave">Resetar carreira (local)</button>
            <button class="btn danger" id="btnEnd" disabled>Encerrar turno</button>
          </div>

          <div style="height:12px"></div>

          <div class="split">
            <!-- CALL -->
            <div class="callbox">
              <div class="calltop">
                <div class="left">
                  <div class="avatar"></div>
                  <div class="callmeta">
                    <p class="title" id="callTitle">Sem chamada ativa</p>
                    <div class="small" id="callSmall">Aguardando‚Ä¶</div>
                  </div>
                </div>
                <div class="timer">
                  <span id="callTimerTxt">--:--</span>
                  <div class="bar"><i id="callTimerBar"></i></div>
                </div>
              </div>

              <div class="transcript" id="transcript">
                <p class="line" style="color:rgba(255,255,255,.65);margin:0">
                  Inicie um turno para come√ßar a receber chamadas.
                </p>
              </div>

              <div class="choices" id="choices"></div>
            </div>

            <!-- QUEUE + INCIDENTS -->
            <div class="feed">
              <div>
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;">
                  <div style="font-size:12px; color:rgba(255,255,255,.78); text-transform:uppercase; letter-spacing:.35px;">Fila de Chamadas</div>
                  <span class="tag" id="queueTag">0</span>
                </div>
                <div class="list" id="queueList"></div>
              </div>

              <div>
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin: 8px 0;">
                  <div style="font-size:12px; color:rgba(255,255,255,.78); text-transform:uppercase; letter-spacing:.35px;">Ocorr√™ncias Ativas</div>
                  <span class="tag" id="incTag">0</span>
                </div>
                <div class="list" id="incList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card mapcard">
        <div class="hd">
          <h2>Mapa e Despacho (Manual)</h2>
          <span class="tag" id="dispatchHint">Selecione uma ocorr√™ncia</span>
        </div>

        <div class="mapwrap" id="mapWrap">
          <canvas id="mapCanvas"></canvas>
          <div class="mapOverlay">
            <div class="mini" id="mapMini">
              üó∫Ô∏è Arraste para mover ‚Ä¢ pin√ßa/scroll para zoom ‚Ä¢ toque nos √≠cones para selecionar
            </div>
            <div class="mini" id="mapMini2">
              Fluxo realista: selecione ocorr√™ncia ‚Üí escolha unidade ‚Üí despache ‚Üí envie refor√ßo se necess√°rio
            </div>
          </div>
        </div>

        <div class="bottomDock">
          <div class="dockCol">
            <h3>Unidades</h3>
            <div class="muted" id="unitHelp">Selecione uma ocorr√™ncia para ver quais unidades fazem sentido.</div>
            <div style="height:8px"></div>
            <div class="row" id="unitChips"></div>
          </div>

          <div class="dockCol">
            <h3>Despacho</h3>
            <div class="muted" id="dispatchPanel">Nenhuma ocorr√™ncia selecionada.</div>
            <div style="height:10px"></div>
            <div class="btnrow" style="margin:0">
              <button class="btn" id="btnDispatch" disabled>Despachar unidade selecionada</button>
              <button class="btn secondary" id="btnUnselect" disabled>Limpar sele√ß√£o</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     *  Utilities
     ************************/
    const $ = (id)=>document.getElementById(id);
    function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
    function rnd(a,b){ return a + Math.random()*(b-a); }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function fmtMMSS(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = String(Math.floor(sec/60)).padStart(2,'0');
      const s = String(sec%60).padStart(2,'0');
      return `${m}:${s}`;
    }
    function toast(msg){
      const t = $('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>t.classList.remove('show'), 2200);
    }
    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    /***********************
     *  Career (localStorage)
     ************************/
    const SAVE_KEY = 'lcdo_save_v3_manual_dispatch';
    function loadCareer(){
      try{
        const raw = localStorage.getItem(SAVE_KEY);
        if(!raw) return { lvl:1, xp:0, money:0 };
        const d = JSON.parse(raw);
        return { lvl: d.lvl||1, xp:d.xp||0, money:d.money||0 };
      }catch(e){
        return { lvl:1, xp:0, money:0 };
      }
    }
    function saveCareer(){ localStorage.setItem(SAVE_KEY, JSON.stringify(CAREER)); }
    function xpNeededForNext(lvl){ return 120 + (lvl-1)*60; }
    function addXP(amount){
      CAREER.xp += amount;
      while(CAREER.xp >= xpNeededForNext(CAREER.lvl)){
        CAREER.xp -= xpNeededForNext(CAREER.lvl);
        CAREER.lvl++;
        toast(`Promo√ß√£o! Voc√™ alcan√ßou o n√≠vel ${CAREER.lvl}.`);
      }
      CAREER.xp = Math.max(0, CAREER.xp);
      saveCareer();
      renderHUD();
    }
    function addMoney(amount){
      CAREER.money = Math.max(0, CAREER.money + amount);
      saveCareer();
      renderHUD();
    }
    let CAREER = loadCareer();

    /***********************
     *  Cities & Units
     ************************/
    const CITIES = {
      saopaulo: {
        label: "S√£o Paulo",
        regionTag: "BR ‚Ä¢ SP",
        bounds: { latMin: -23.72, latMax: -23.40, lngMin: -46.82, lngMax: -46.45 },
        units: [
          { id:'sp_p1', name:'Patrulha (√Årea)', type:'police', tags:['police','patrol'], speed: 1.00 },
          { id:'sp_rota', name:'ROTA (T√°tico)', type:'police', tags:['police','tactical','swat'], speed: 1.05 },
          { id:'sp_gate', name:'GATE (Anti-bomba)', type:'police', tags:['police','bomb','tactical'], speed: 0.95 },
          { id:'sp_aguia', name:'√Åguia (Helic√≥ptero)', type:'police', tags:['police','air','tactical'], speed: 1.35 },
          { id:'sp_choque', name:'Choque (Controle)', type:'police', tags:['police','riot','tactical'], speed: 0.95 },
          { id:'sp_resgate', name:'Resgate (Bombeiros)', type:'fire', tags:['fire','rescue'], speed: 1.00 },
          { id:'sp_ab', name:'Auto Bomba (Inc√™ndio)', type:'fire', tags:['fire','firetruck'], speed: 0.95 },
          { id:'sp_amb', name:'Ambul√¢ncia', type:'medic', tags:['medic','ems'], speed: 1.05 },
        ]
      },
      nyc: {
        label: "New York City",
        regionTag: "USA ‚Ä¢ NYC",
        bounds: { latMin: 40.55, latMax: 40.92, lngMin: -74.25, lngMax: -73.70 },
        units: [
          { id:'ny_patrol', name:'Patrol (Area)', type:'police', tags:['police','patrol'], speed: 1.00 },
          { id:'ny_swat', name:'SWAT', type:'police', tags:['police','swat','tactical'], speed: 1.05 },
          { id:'ny_fbi', name:'Federal Task (FBI)', type:'police', tags:['police','investigation','tactical'], speed: 1.00 },
          { id:'ny_bomb', name:'Bomb Squad', type:'police', tags:['police','bomb','tactical'], speed: 0.95 },
          { id:'ny_ems', name:'EMS Ambulance', type:'medic', tags:['medic','ems'], speed: 1.05 },
          { id:'ny_engine', name:'Fire Engine', type:'fire', tags:['fire','firetruck'], speed: 0.95 },
          { id:'ny_rescue', name:'Rescue Unit', type:'fire', tags:['fire','rescue'], speed: 1.00 },
        ]
      }
    };

    // Cat√°logo
    const INCIDENT_CATALOG = {
      prank: [
        { key:'trote_crianca', title:'Poss√≠vel trote', sev:'low', needs:['triage'], script:"(risos) Oi mo√ßo‚Ä¶ tem um le√£o no meu quarto‚Ä¶", tips:"Sinais de trote: inconsist√™ncia, risos, hist√≥ria absurda." },
        { key:'ligacao_muda', title:'Liga√ß√£o muda', sev:'low', needs:['triage'], script:"‚Ä¶(sil√™ncio)‚Ä¶ respira√ß√£o‚Ä¶ depois desliga.", tips:"Tente confirmar local e tipo. Se sem resposta, encerre e registre." },
      ],
      police_low: [
        { key:'perturbacao', title:'Perturba√ß√£o do sossego', sev:'low', needs:['police','patrol'], script:"Tem som alto no vizinho, t√° imposs√≠vel dormir.", tips:"Coletar endere√ßo e orientar a evitar confronto direto." },
        { key:'suspeito', title:'Pessoa suspeita rondando', sev:'low', needs:['police','patrol'], script:"Tem um cara olhando as casas e mexendo nos port√µes.", tips:"Pedir descri√ß√£o, dire√ß√£o, roupa, se h√° arma vis√≠vel." },
      ],
      police_med: [
        { key:'roubo', title:'Roubo em andamento', sev:'med', needs:['police','patrol'], script:"Est√£o tentando arrombar a porta aqui!", tips:"Orientar a se esconder, manter sil√™ncio, n√£o confrontar." },
        { key:'viol_dom', title:'Viol√™ncia dom√©stica', sev:'med', needs:['police','patrol'], script:"Meu marido t√° agressivo, tenho medo‚Ä¶", tips:"Perguntar se h√° armas, crian√ßas, local seguro." },
      ],
      police_high: [
        { key:'tiros', title:'Disparos / situa√ß√£o armada', sev:'high', needs:['police','tactical'], script:"Tem tiro! Eu ouvi v√°rios tiros agora!", tips:"Abrigo imediato. Escalona com t√°tico/elite." },
        { key:'bomba', title:'Suspeita de artefato explosivo', sev:'high', needs:['police','bomb'], script:"Tem uma mochila abandonada e t√° fazendo barulho estranho.", tips:"Isolar √°rea, n√£o tocar, anti-bomba." },
      ],
      fire_low: [
        { key:'fuma√ßa', title:'Fuma√ßa em apartamento', sev:'low', needs:['fire','firetruck'], script:"T√° saindo fuma√ßa da cozinha, acho que queimou panela.", tips:"Orientar desligar g√°s/energia se seguro, evacuar se piorar." },
        { key:'elevador', title:'Pessoa presa no elevador', sev:'low', needs:['fire','rescue'], script:"Travou o elevador com gente dentro!", tips:"Manter calma, evitar for√ßar portas." },
      ],
      fire_med: [
        { key:'acidente_ferragens', title:'Acidente com v√≠timas presas', sev:'med', needs:['fire','rescue','medic','ems'], script:"Bateu forte e tem gente presa no carro!", tips:"Resgate + ambul√¢ncia. N√£o mexer em coluna." },
        { key:'incendio', title:'Inc√™ndio residencial', sev:'med', needs:['fire','firetruck'], script:"Pegou fogo no quarto, t√° espalhando!", tips:"Evacuar, fechar portas, n√£o usar elevador." },
      ],
      fire_high: [
        { key:'parada', title:'Parada card√≠aca', sev:'high', needs:['medic','ems'], script:"Ele caiu e n√£o responde! N√£o t√° respirando!", tips:"Compress√µes imediatas + ambul√¢ncia urgente." },
        { key:'parto', title:'Parto de emerg√™ncia', sev:'high', needs:['medic','ems'], script:"A beb√™ t√° vindo! N√£o d√° tempo!", tips:"Preparar toalhas limpas, manter calma, ambul√¢ncia." },
      ]
    };

    function buildScenarioPool(agency){
      const pool = [];
      pool.push(...INCIDENT_CATALOG.prank);
      if(agency === 'police'){
        pool.push(...INCIDENT_CATALOG.police_low, ...INCIDENT_CATALOG.police_med, ...INCIDENT_CATALOG.police_high);
      } else if(agency === 'fire'){
        pool.push(...INCIDENT_CATALOG.fire_low, ...INCIDENT_CATALOG.fire_med, ...INCIDENT_CATALOG.fire_high);
      } else {
        pool.push(
          ...INCIDENT_CATALOG.police_low, ...INCIDENT_CATALOG.police_med, ...INCIDENT_CATALOG.police_high,
          ...INCIDENT_CATALOG.fire_low, ...INCIDENT_CATALOG.fire_med, ...INCIDENT_CATALOG.fire_high
        );
      }
      return pool;
    }

    /***********************
     *  Game state
     ************************/
    const GAME = {
      running: false,
      cityKey: 'saopaulo',
      agency: 'police',
      score: 0,

      shiftElapsed: 0,
      shiftDuration: 8 * 60,  // 8min (prototype)
      lastCallAt: 0,

      scenarioPool: [],

      queue: [],
      activeCall: null,
      incidents: [],
      selectedIncidentId: null,

      units: [],
      tickHandle: null,
    };

    let selectedUnitId = null;
    let _id = 1;
    function nextId(prefix){ return `${prefix}_${_id++}`; }

    function addScore(delta){
      GAME.score = Math.max(-999, GAME.score + delta);
      renderHUD();
    }

    function resetOperationalState(){
      GAME.score = 0;
      GAME.shiftElapsed = 0;
      GAME.lastCallAt = 0;
      GAME.queue = [];
      GAME.activeCall = null;
      GAME.incidents = [];
      GAME.selectedIncidentId = null;
      selectedUnitId = null;
      renderAll();
    }

    function buildUnitsForCity(){
      const c = CITIES[GAME.cityKey];
      const b = c.bounds;

      GAME.units = c.units.map(u => ({
        ...u,
        lat: rnd(b.latMin, b.latMax),
        lng: rnd(b.lngMin, b.lngMax),
        status: 'idle', // idle / enroute / onscene
        busyUntil: 0,
        target: null
      }));
    }

    function randomLocation(){
      const b = CITIES[GAME.cityKey].bounds;
      return { lat: rnd(b.latMin, b.latMax), lng: rnd(b.lngMin, b.lngMax) };
    }

    /***********************
     *  Call system + Typewriter
     ************************/
    function setCallHeader(title, small){
      $('callTitle').textContent = title;
      $('callSmall').textContent = small;
    }

    function renderTranscript(call){
      const el = $('transcript');
      el.innerHTML = '';
      for(const L of call.transcript){
        const p = document.createElement('p');
        p.className = 'line';
        const who = document.createElement('span');
        who.className = 'who';
        who.textContent = L.who;
        const msg = document.createElement('span');
        msg.textContent = L.text;
        p.appendChild(who);
        p.appendChild(msg);
        el.appendChild(p);
      }
      el.scrollTop = el.scrollHeight;
    }

    function typewriterAppend(call, who, text, done){
      const el = $('transcript');
      const p = document.createElement('p');
      p.className = 'line';
      const whoEl = document.createElement('span');
      whoEl.className = 'who';
      whoEl.textContent = who;
      const msgEl = document.createElement('span');
      msgEl.textContent = '';
      p.appendChild(whoEl);
      p.appendChild(msgEl);
      el.appendChild(p);
      el.scrollTop = el.scrollHeight;

      let i = 0;
      const speed = 12;

      if(call.typing){ clearInterval(call.typing); call.typing = null; }
      call.typing = setInterval(()=>{
        i++;
        msgEl.textContent = text.slice(0, i);
        el.scrollTop = el.scrollHeight;
        if(i >= text.length){
          clearInterval(call.typing);
          call.typing = null;
          call.transcript.push({ who, text });
          renderTranscript(call);
          if(done) done();
        }
      }, speed);
    }

    function addLine(call, who, text, typed=true, done){
      if(!call) return;
      if(call.typing){ clearInterval(call.typing); call.typing = null; }
      if(!typed){
        call.transcript.push({ who, text });
        renderTranscript(call);
        if(done) done();
        return;
      }
      typewriterAppend(call, who, text, done);
    }

    function updateCallTimerUI(call){
      if(!call){
        $('callTimerTxt').textContent = '--:--';
        $('callTimerBar').style.width = '0%';
        return;
      }
      $('callTimerTxt').textContent = fmtMMSS(call.timeLeft);
      const pct = 100 * (call.timeLeft / call.duration);
      $('callTimerBar').style.width = `${clamp(pct,0,100)}%`;
    }

    function fakeAddressForCity(cityKey){
      if(cityKey==='saopaulo'){
        return pick([
          "Av. Paulista, pr√≥ximo ao MASP.",
          "Rua da Consola√ß√£o, perto do metr√¥.",
          "Marginal Tiet√™, sentido Castelo Branco.",
          "Av. Rebou√ßas, esquina com uma farm√°cia.",
          "Av. 23 de Maio, perto do viaduto."
        ]);
      }
      return pick([
        "5th Avenue near Central Park.",
        "Broadway, close to Times Square.",
        "Brooklyn, near the bridge entrance.",
        "Queens, near a subway station.",
        "Lower Manhattan, near Wall Street."
      ]);
    }

    function dangerLineFromScenario(sc){
      if(sc.key.includes('bomba')) return "Tem gente perto‚Ä¶ e ningu√©m sabe o que √©!";
      if(sc.key.includes('tiros')) return "Tem risco sim! Eu t√¥ escondido!";
      if(sc.key.includes('incendio')) return "Tem fuma√ßa forte e chamas!";
      if(sc.key.includes('parada')) return "Ele n√£o respira!";
      if(sc.key.includes('acidente')) return "Tem feridos e gritos‚Ä¶";
      if(sc.needs.includes('triage')) return "Ah‚Ä¶ era brincadeira‚Ä¶";
      return "N√£o sei‚Ä¶ t√¥ com medo!";
    }

    function instructionForScenario(sc){
      if(sc.key.includes('parada')){
        return "Inicie compress√µes no centro do peito: r√°pidas e firmes. Continue at√© a ambul√¢ncia chegar.";
      }
      if(sc.key.includes('parto')){
        return "Mantenha a pessoa confort√°vel. Prepare toalhas limpas. Apoie e aguarde a equipe m√©dica.";
      }
      if(sc.key.includes('incendio') || sc.key.includes('fuma√ßa')){
        return "Saia do local com seguran√ßa. N√£o use elevador. Se houver fuma√ßa, fique baixo e feche portas ao sair.";
      }
      if(sc.key.includes('acidente')){
        return "N√£o mova a v√≠tima. Sinalize o local e aguarde resgate. Se poss√≠vel, desligue o motor em seguran√ßa.";
      }
      if(sc.key.includes('tiros')){
        return "Procure abrigo e fique longe de janelas. N√£o confronte. S√≥ fale se for seguro.";
      }
      if(sc.needs.includes('triage')){
        return "Se n√£o h√° emerg√™ncia, n√£o ocupe a linha. Trotes colocam vidas em risco.";
      }
      return "Mantenha a calma, afaste-se do risco e aguarde as equipes.";
    }

    /***********************
     *  Queue / Calls
     ************************/
    function enqueueCall(){
      const scenario = pick(GAME.scenarioPool);
      const loc = randomLocation();

      const call = {
        id: nextId('call'),
        scenario,
        loc,
        createdAt: GAME.shiftElapsed,
        duration: scenario.sev==='high' ? 120 : (scenario.sev==='med' ? 100 : 80),
        timeLeft: scenario.sev==='high' ? 120 : (scenario.sev==='med' ? 100 : 80),
        collected: { addressKnown:false, natureKnown:false, dangerKnown:false },
        transcript: [],
        typing: null
      };
      GAME.queue.push(call);
      renderQueue();
      $('queueTag').textContent = String(GAME.queue.length);
      toast('‚òéÔ∏è Nova chamada na fila.');
    }

    function popNextCall(){
      if(GAME.activeCall) return;
      const call = GAME.queue.shift();
      if(!call) return;
      GAME.activeCall = call;
      $('queueTag').textContent = String(GAME.queue.length);
      renderQueue();
      startCallIntro(call);
    }

    function startCallIntro(call){
      const cityKey = GAME.cityKey;
      const agency = GAME.agency;

      let greeting = "Central, qual sua emerg√™ncia?";
      if(cityKey==='saopaulo'){
        if(agency==='police') greeting = "190, Pol√≠cia Militar. Qual sua emerg√™ncia?";
        else if(agency==='fire') greeting = "193, Bombeiros. Qual sua emerg√™ncia?";
        else greeting = "CIOSP (Central Integrada). Qual sua emerg√™ncia?";
      } else {
        if(agency==='police' || agency==='mixed') greeting = "911, what's your emergency?";
        else greeting = "911 Fire/Rescue, what's your emergency?";
      }

      setCallHeader(`Chamada ‚Äî ${CITIES[cityKey].label}`, `ID ${call.id} ‚Ä¢ Prioridade ${call.scenario.sev.toUpperCase()}`);
      call.transcript = [];
      renderTranscript(call);

      addLine(call, "OPERADOR", greeting, true, ()=>{
        addLine(call, "CHAMADOR", call.scenario.script, true, ()=>{
          renderChoicesForCall(call);
        });
      });
    }

    function endActiveCall(note){
      if(!GAME.activeCall) return;
      if(GAME.activeCall.typing){ clearInterval(GAME.activeCall.typing); GAME.activeCall.typing=null; }
      $('choices').innerHTML = '';
      $('callTitle').textContent = 'Sem chamada ativa';
      $('callSmall').textContent = note || 'Aguardando‚Ä¶';
      GAME.activeCall = null;
      updateCallTimerUI(null);

      if(GAME.queue.length){
        setTimeout(()=>popNextCall(), 400);
      }
    }

    function renderChoices(buttons){
      const box = $('choices');
      box.innerHTML = '';
      for(const b of buttons){
        const btn = document.createElement('button');
        btn.className = 'choice';
        btn.textContent = b.label;
        btn.onclick = b.onClick;
        box.appendChild(btn);
      }
    }

    // üî• NOVO: incident agora tem "pend√™ncias" e m√∫ltiplas unidades poss√≠veis
    function createIncidentFromCall(call, responsePlan){
      // responsePlan: 'min' | 'std' | 'max' (s√≥ influ√™ncia de pontua√ß√£o inicial)
      const baseNeeds = call.scenario.needs.slice();

      const inc = {
        id: nextId('inc'),
        title: call.scenario.title,
        sev: call.scenario.sev,
        needs: baseNeeds,                   // lista original (o que faz sentido)
        pending: baseNeeds.filter(x=>x!=='triage'), // o que ainda falta cobrir
        assignedUnits: [],                  // ids das unidades enviadas
        loc: { ...call.loc },
        createdAt: GAME.shiftElapsed,
        resolved: false,
        expiresIn: call.scenario.sev==='high' ? 160 : (call.scenario.sev==='med' ? 190 : 230),
        timeLeft:  call.scenario.sev==='high' ? 160 : (call.scenario.sev==='med' ? 190 : 230),
        plan: responsePlan || 'std',
        notes: call.scenario.tips || ''
      };

      GAME.incidents.push(inc);
      $('incTag').textContent = String(GAME.incidents.length);
      renderIncidents();

      // Importante: N√ÉO auto-seleciona ‚Üí fica 100% manual agora
      toast(`üö® Ocorr√™ncia registrada: ${inc.title} (Despacho manual)`);
      return inc;
    }

    function renderChoicesForCall(call){
      if(!call) return;

      const buttons = [];

      buttons.push({
        label: "Perguntar endere√ßo/localiza√ß√£o",
        onClick: ()=>{
          if(call.collected.addressKnown){
            addLine(call,"OPERADOR","Confirme novamente: qual o endere√ßo exato?", true, ()=>{
              addLine(call,"CHAMADOR","√â aqui mesmo‚Ä¶ r√°pido!", true, ()=>{});
            });
            addScore(-1);
            return;
          }
          call.collected.addressKnown = true;
          addLine(call,"OPERADOR","Qual o endere√ßo exato e ponto de refer√™ncia?", true, ()=>{
            addLine(call,"CHAMADOR", fakeAddressForCity(GAME.cityKey), true, ()=>{
              addScore(+6);
              renderChoicesForCall(call);
            });
          });
        }
      });

      buttons.push({
        label: "Perguntar o que est√° acontecendo",
        onClick: ()=>{
          if(call.collected.natureKnown){
            addLine(call,"OPERADOR","O que mais voc√™ consegue perceber agora?", true, ()=>{
              addLine(call,"CHAMADOR","T√° assustador‚Ä¶", true, ()=>{});
            });
            addScore(+1);
            return;
          }
          call.collected.natureKnown = true;
          addLine(call,"OPERADOR","Descreva a emerg√™ncia em uma frase.", true, ()=>{
            addLine(call,"CHAMADOR", call.scenario.title + ".", true, ()=>{
              addScore(+6);
              renderChoicesForCall(call);
            });
          });
        }
      });

      buttons.push({
        label: "Perguntar risco imediato (armas/fogo/feridos)",
        onClick: ()=>{
          if(call.collected.dangerKnown){
            addLine(call,"OPERADOR","Fique em seguran√ßa. Alguma mudan√ßa agora?", true, ()=>{
              addLine(call,"CHAMADOR","T√¥ tentando‚Ä¶", true, ()=>{});
            });
            addScore(+1);
            return;
          }
          call.collected.dangerKnown = true;
          addLine(call,"OPERADOR","Existe risco imediato? Arma, fogo, fuma√ßa, algu√©m inconsciente?", true, ()=>{
            addLine(call,"CHAMADOR", dangerLineFromScenario(call.scenario), true, ()=>{
              addScore(+6);
              renderChoicesForCall(call);
            });
          });
        }
      });

      buttons.push({
        label: "Dar instru√ß√µes de seguran√ßa / primeiros socorros",
        onClick: ()=>{
          addLine(call,"OPERADOR", instructionForScenario(call.scenario), true, ()=>{
            addLine(call,"CHAMADOR","Ok‚Ä¶ vou tentar!", true, ()=>{
              addScore(+8);
              renderChoicesForCall(call);
            });
          });
        }
      });

      // ‚úÖ NOVO: registrar ocorr√™ncia com "plano de resposta" (mas despacho continua manual)
      buttons.push({
        label: "Registrar ocorr√™ncia (resposta M√çNIMA) ‚Äî mais arriscado",
        onClick: ()=> registerIncidentPlan(call, 'min')
      });
      buttons.push({
        label: "Registrar ocorr√™ncia (resposta PADR√ÉO) ‚Äî recomendado",
        onClick: ()=> registerIncidentPlan(call, 'std')
      });
      buttons.push({
        label: "Registrar ocorr√™ncia (resposta M√ÅXIMA) ‚Äî mais unidades/seguran√ßa",
        onClick: ()=> registerIncidentPlan(call, 'max')
      });

      buttons.push({
        label: "Encerrar / classificar como trote (se aplic√°vel)",
        onClick: ()=>{
          if(call.scenario.needs.includes('triage')){
            addLine(call,"OPERADOR","Sem emerg√™ncia confirmada. Encerrando e registrando a liga√ß√£o.", true, ()=>{
              addScore(+8);
              addXP(8);
              endActiveCall("Liga√ß√£o encerrada (trote/sem confirma√ß√£o).");
            });
          } else {
            addLine(call,"OPERADOR","Vou encerrar a liga√ß√£o.", true, ()=>{
              addScore(-18);
              addXP(1);
              endActiveCall("Erro: liga√ß√£o encerrada indevidamente.");
            });
          }
        }
      });

      renderChoices(buttons);
    }

    function registerIncidentPlan(call, plan){
      const goodInfo = (call.collected.addressKnown || call.collected.natureKnown);
      if(!goodInfo){
        addLine(call,"OPERADOR","Preciso do endere√ßo e do que est√° acontecendo para registrar.", true, ()=>{
          addScore(-3);
          renderChoicesForCall(call);
        });
        return;
      }
      const inc = createIncidentFromCall(call, plan);

      // Pontua√ß√£o inicial depende do plano (s√≥ para refor√ßar realismo: mandar m√≠nimo pode dar b√¥nus de custo, mas risco maior depois)
      if(plan==='min') addScore(+6);
      if(plan==='std') addScore(+10);
      if(plan==='max') addScore(+8);

      addLine(call,"OPERADOR","Entendido. Vou registrar e despachar unidades. Permane√ßa na linha se poss√≠vel.", true, ()=>{
        endActiveCall(`Ocorr√™ncia registrada: ${inc.title}. Agora fa√ßa o DESPACHO manual na lista/mapa.`);
        toast('Agora selecione a ocorr√™ncia na lista e escolha as unidades para despachar.');
      });
    }

    /***********************
     *  Dispatch logic (Manual + Pend√™ncias)
     ************************/
    const SERVICE_NEEDS = new Set(['police','fire','medic']);
    function unitCovers(unit, need){
      // need pode ser service ('police') ou capability ('tactical','bomb','ems','rescue','firetruck','patrol'...)
      if(SERVICE_NEEDS.has(need)){
        return unit.tags.includes(need);
      }
      // compatibilidades especiais
      if(need==='tactical') return unit.tags.includes('tactical') || unit.tags.includes('swat');
      return unit.tags.includes(need);
    }

    function computeRemaining(inc){
      const remaining = [];
      for(const need of inc.needs){
        if(need==='triage') continue;
        // j√° coberto por alguma unidade enviada?
        const covered = inc.assignedUnits.some(uid=>{
          const u = GAME.units.find(x=>x.id===uid);
          return u ? unitCovers(u, need) : false;
        });
        if(!covered) remaining.push(need);
      }
      inc.pending = remaining;
      return remaining;
    }

    function selectIncident(incId){
      GAME.selectedIncidentId = incId;
      const inc = GAME.incidents.find(x=>x.id===incId);
      if(!inc) return;
      computeRemaining(inc);
      $('dispatchHint').textContent = `Selecionada: ${inc.title}`;
      $('btnDispatch').disabled = false;
      $('btnUnselect').disabled = false;
      renderUnits();         // agora filtra melhor
      renderDispatchPanel();
      toast(`Ocorr√™ncia selecionada: ${inc.title}`);
    }

    function selectUnitForDispatch(unitId){
      selectedUnitId = unitId;
      renderUnits();
      renderDispatchPanel();
      toast('Unidade selecionada.');
    }

    function dispatchSelected(){
      const inc = GAME.incidents.find(x=>x.id===GAME.selectedIncidentId);
      if(!inc){ toast('Selecione uma ocorr√™ncia.'); return; }
      if(!selectedUnitId){ toast('Selecione uma unidade.'); return; }

      const unit = GAME.units.find(u=>u.id===selectedUnitId);
      if(!unit){ toast('Unidade inv√°lida.'); return; }
      if(unit.status !== 'idle'){ toast('Unidade ocupada.'); return; }

      // j√° enviou essa unidade?
      if(inc.assignedUnits.includes(unit.id)){
        toast('Essa unidade j√° foi enviada para essa ocorr√™ncia.');
        return;
      }

      // a unidade precisa cobrir pelo menos UMA pend√™ncia, sen√£o √© desperd√≠cio
      computeRemaining(inc);
      const coversSomething = inc.pending.some(need => unitCovers(unit, need));

      // Permite mandar mesmo assim, mas penaliza bastante
      unit.status = 'enroute';
      unit.target = { incId: inc.id, toLat: inc.loc.lat, toLng: inc.loc.lng, ok: coversSomething };

      inc.assignedUnits.push(unit.id);
      computeRemaining(inc);

      if(coversSomething){
        addScore(+10);
        toast('Despacho OK (cobre pend√™ncias).');
      } else {
        addScore(-12);
        toast('Despacho ruim: unidade n√£o cobre pend√™ncias (desperd√≠cio).');
      }

      renderUnits();
      renderIncidents();
      renderDispatchPanel();
    }

    function clearSelection(){
      GAME.selectedIncidentId = null;
      selectedUnitId = null;
      $('dispatchHint').textContent = 'Selecione uma ocorr√™ncia';
      $('btnDispatch').disabled = true;
      $('btnUnselect').disabled = true;
      renderUnits();
      renderDispatchPanel();
    }

    function resolveIncident(inc){
      if(!inc || inc.resolved) return;

      computeRemaining(inc);

      // Se ainda faltam pend√™ncias, n√£o resolve (exige despacho completo)
      if(inc.pending.length > 0){
        toast('‚ö†Ô∏è Ocorr√™ncia ainda tem pend√™ncias. Envie refor√ßo/unidades corretas.');
        addScore(-4);
        return;
      }

      inc.resolved = true;

      const urgency = inc.sev==='high' ? 3 : (inc.sev==='med' ? 2 : 1);
      const timeFactor = inc.timeLeft / inc.expiresIn;
      const fast = timeFactor > 0.55;

      // avalia√ß√£o com base em plano + tempo
      let scoreDelta = 0, xpDelta=0, moneyDelta=0;
      let outcome = "Resolvido.";

      scoreDelta += 18 * urgency;
      xpDelta += 12 * urgency;
      moneyDelta += 8 * urgency;

      if(inc.plan==='min') {
        // barato, mas arriscado ‚Äî se resolveu r√°pido d√° b√¥nus, se n√£o, pequena penaliza√ß√£o
        scoreDelta += fast ? +6 : -4;
      } else if(inc.plan==='max'){
        // mais unidades ‚Äî custo
        moneyDelta -= 2 * urgency;
        scoreDelta += fast ? +2 : +0;
      }

      outcome = fast ? "Sucesso r√°pido. √ìtimo despacho." : "Sucesso. Despacho conclu√≠do.";

      addScore(Math.round(scoreDelta));
      addXP(Math.round(xpDelta));
      addMoney(Math.round(moneyDelta));

      // remove ocorr√™ncia
      GAME.incidents = GAME.incidents.filter(x=>x.id !== inc.id);
      $('incTag').textContent = String(GAME.incidents.length);

      if(GAME.selectedIncidentId === inc.id) clearSelection();
      renderIncidents();

      toast(`üìÑ Relat√≥rio: ${outcome}`);
    }

    /***********************
     *  Lists render
     ************************/
    function renderQueue(){
      const list = $('queueList');
      list.innerHTML = '';
      if(!GAME.queue.length){
        const div = document.createElement('div');
        div.className = 'muted';
        div.textContent = 'Sem chamadas na fila.';
        list.appendChild(div);
        return;
      }
      for(const c of GAME.queue.slice(0,6)){
        const it = document.createElement('div');
        it.className = 'item';
        it.onclick = ()=>{
          if(GAME.activeCall){ toast('Finalize a chamada atual antes de atender outra.'); return; }
          GAME.queue = [c, ...GAME.queue.filter(x=>x.id!==c.id)];
          popNextCall();
        };
        it.innerHTML = `
          <div class="a">
            <p class="t">${escapeHTML(c.scenario.title)}</p>
            <div class="s">ID ${escapeHTML(c.id)} ‚Ä¢ ${escapeHTML(CITIES[GAME.cityKey].label)}</div>
          </div>
          <span class="sev ${c.scenario.sev==='high'?'high':(c.scenario.sev==='med'?'med':'low')}">${escapeHTML(c.scenario.sev.toUpperCase())}</span>
        `;
        list.appendChild(it);
      }
    }

    function renderIncidents(){
      const list = $('incList');
      list.innerHTML = '';
      if(!GAME.incidents.length){
        const div = document.createElement('div');
        div.className = 'muted';
        div.textContent = 'Sem ocorr√™ncias ativas.';
        list.appendChild(div);
        return;
      }
      for(const inc of GAME.incidents.slice(0,10)){
        computeRemaining(inc);

        const it = document.createElement('div');
        it.className = 'item';
        it.onclick = ()=> selectIncident(inc.id);

        const pendingTxt = inc.pending.length ? `Pend√™ncias: ${inc.pending.join(', ')}` : `Pend√™ncias: OK`;
        const sentTxt = inc.assignedUnits.length ? `Enviado: ${inc.assignedUnits.length} unid.` : 'Enviado: 0 unid.';

        it.innerHTML = `
          <div class="a">
            <p class="t">${escapeHTML(inc.title)}</p>
            <div class="s">ID ${escapeHTML(inc.id)} ‚Ä¢ ‚è± ${fmtMMSS(inc.timeLeft)} ‚Ä¢ ${escapeHTML(sentTxt)} ‚Ä¢ ${escapeHTML(pendingTxt)}</div>
          </div>
          <span class="sev ${inc.sev==='high'?'high':(inc.sev==='med'?'med':'low')}">${escapeHTML(inc.sev.toUpperCase())}</span>
        `;
        list.appendChild(it);
      }
      renderDispatchPanel();
    }

    function renderUnits(){
      const wrap = $('unitChips');
      wrap.innerHTML = '';

      const inc = GAME.incidents.find(x=>x.id===GAME.selectedIncidentId);
      if(!inc){
        $('unitHelp').textContent = 'Selecione uma ocorr√™ncia para ver quais unidades fazem sentido.';
      } else {
        computeRemaining(inc);
        $('unitHelp').textContent = inc.pending.length
          ? `Pend√™ncias: ${inc.pending.join(', ')} ‚Äî escolha unidades que cubram isso.`
          : 'Todas as pend√™ncias cobertas. (Voc√™ ainda pode enviar refor√ßo.)';
      }

      for(const u of GAME.units){
        let cls = 'chip ' + (u.status==='idle'?'ok':'busy');
        if(selectedUnitId === u.id) cls += ' sel';

        let useful = false;
        if(inc && u.status==='idle'){
          useful = inc.pending.some(need => unitCovers(u, need));
        }

        const chip = document.createElement('span');
        chip.className = cls + (inc ? (useful ? '' : ' warn') : '');
        chip.textContent = `${u.name}`;
        chip.onclick = ()=>{
          if(!GAME.selectedIncidentId){ toast('Selecione uma ocorr√™ncia primeiro.'); return; }
          selectUnitForDispatch(u.id);
        };
        wrap.appendChild(chip);
      }
    }

    function renderDispatchPanel(){
      const inc = GAME.incidents.find(x=>x.id===GAME.selectedIncidentId);
      if(!inc){
        $('dispatchPanel').textContent = 'Nenhuma ocorr√™ncia selecionada.';
        $('btnDispatch').disabled = true;
        $('btnUnselect').disabled = true;
        return;
      }
      computeRemaining(inc);

      const needs = inc.needs.map(t=>`<span class="chip">${escapeHTML(t)}</span>`).join(' ');
      const pending = inc.pending.length
        ? inc.pending.map(t=>`<span class="chip bad">${escapeHTML(t)}</span>`).join(' ')
        : `<span class="chip ok">OK</span>`;

      const unit = selectedUnitId ? GAME.units.find(u=>u.id===selectedUnitId) : null;

      const unitLine = unit
        ? `<div style="margin-top:8px"><strong>Unidade selecionada:</strong> ${escapeHTML(unit.name)}
            <span class="chip ${unit.status==='idle'?'ok':'busy'}">${escapeHTML(unit.status)}</span>
          </div>`
        : `<div style="margin-top:8px; opacity:.85">Escolha uma unidade (chips) para despachar.</div>`;

      const sentList = inc.assignedUnits.length
        ? inc.assignedUnits.map(uid=>{
            const u = GAME.units.find(x=>x.id===uid);
            return `<span class="chip">${escapeHTML(u ? u.name : uid)}</span>`;
          }).join(' ')
        : `<span class="chip warn">Nenhuma unidade enviada</span>`;

      $('dispatchPanel').innerHTML = `
        <div>
          <strong>Ocorr√™ncia:</strong> ${escapeHTML(inc.title)}
          <span class="sev ${inc.sev==='high'?'high':(inc.sev==='med'?'med':'low')}">${escapeHTML(inc.sev.toUpperCase())}</span>
        </div>

        <div style="margin-top:8px"><strong>Requisitos (o que faz sentido):</strong> ${needs}</div>
        <div style="margin-top:8px"><strong>Pend√™ncias (o que falta cobrir):</strong> ${pending}</div>

        <div style="margin-top:8px"><strong>Unidades enviadas:</strong> ${sentList}</div>

        ${unitLine}

        <div style="margin-top:8px; opacity:.8; font-family: var(--mono); font-size: 12px;">
          Tempo restante: ${fmtMMSS(inc.timeLeft)} ‚Ä¢ Plano: ${escapeHTML(inc.plan.toUpperCase())}
        </div>

        <div style="margin-top:8px; opacity:.78; font-size: 12px;">
          <strong>Dica:</strong> ${escapeHTML(inc.notes || '‚Äî')}
        </div>
      `;

      $('btnDispatch').disabled = false;
      $('btnUnselect').disabled = false;
    }

    function renderHUD(){
      $('score').textContent = String(GAME.score);
      $('shiftClock').textContent = fmtMMSS(GAME.shiftElapsed);
      $('lvl').textContent = String(CAREER.lvl);
      $('xp').textContent = String(CAREER.xp);
      $('money').textContent = String(CAREER.money);
      $('shiftState').textContent = GAME.running ? 'ON' : 'OFF';
      $('dotShift').className = 'dot ' + (GAME.running ? 'ok' : '');
    }

    function renderAll(){
      renderHUD();
      renderQueue();
      renderIncidents();
      renderUnits();
      renderDispatchPanel();
    }

    /***********************
     *  Main loop
     ************************/
    function startShift(){
      if(GAME.running) return;

      GAME.running = true;
      GAME.cityKey = $('city').value;
      GAME.agency = $('agency').value;

      $('regionTag').textContent = CITIES[GAME.cityKey].regionTag;
      GAME.scenarioPool = buildScenarioPool(GAME.agency);

      buildUnitsForCity();
      resetOperationalState();

      $('btnStart').disabled = true;
      $('btnEnd').disabled = false;
      $('btnNextCall').disabled = false;

      enqueueCall();
      enqueueCall();
      popNextCall();

      if(GAME.tickHandle) clearInterval(GAME.tickHandle);
      GAME.tickHandle = setInterval(tick, 250);

      toast('Turno iniciado.');
      renderAll();
    }

    function endShift(){
      if(!GAME.running) return;

      GAME.running = false;
      clearInterval(GAME.tickHandle);
      GAME.tickHandle = null;

      $('btnStart').disabled = false;
      $('btnEnd').disabled = true;
      $('btnNextCall').disabled = true;

      endActiveCall("Turno encerrado.");
      clearSelection();

      const reward = Math.max(0, Math.floor(GAME.score / 10));
      addMoney(reward);
      addXP(Math.max(0, Math.floor(GAME.score / 12)));

      toast(`Turno encerrado. B√¥nus: ${reward} cr√©ditos.`);
      renderAll();
    }

    function tick(){
      if(!GAME.running) return;

      GAME.shiftElapsed += 0.25;

      if(GAME.shiftElapsed >= GAME.shiftDuration){
        endShift();
        return;
      }

      // Call generation
      const baseInterval = 18;
      const lvlFactor = clamp(1 - (CAREER.lvl-1)*0.03, 0.72, 1.0);
      const interval = baseInterval * lvlFactor;

      if(GAME.shiftElapsed - GAME.lastCallAt >= interval){
        GAME.lastCallAt = GAME.shiftElapsed;
        enqueueCall();
        if(Math.random() < 0.18) enqueueCall();
        if(!GAME.activeCall) popNextCall();
      }

      // Active call timer
      if(GAME.activeCall){
        GAME.activeCall.timeLeft -= 0.25;
        if(GAME.activeCall.timeLeft <= 0){
          addScore(-10);
          addXP(1);
          endActiveCall("Chamada perdida por demora.");
        } else {
          updateCallTimerUI(GAME.activeCall);
        }
      }

      // incidents timer
      for(const inc of GAME.incidents){
        inc.timeLeft -= 0.25;
      }
      for(const inc of [...GAME.incidents]){
        if(inc.timeLeft <= 0){
          addScore(inc.sev==='high' ? -30 : (inc.sev==='med' ? -18 : -8));
          addXP(2);
          toast('Ocorr√™ncia piorou/expirou. Penaliza√ß√£o.');
          GAME.incidents = GAME.incidents.filter(x=>x.id !== inc.id);
          $('incTag').textContent = String(GAME.incidents.length);
          if(GAME.selectedIncidentId === inc.id) clearSelection();
        }
      }

      // Move units
      for(const u of GAME.units){
        if(u.status === 'enroute' && u.target){
          const speed = u.speed;
          const step = 0.0009 * speed;
          const dLat = u.target.toLat - u.lat;
          const dLng = u.target.toLng - u.lng;
          const dist = Math.hypot(dLat, dLng);

          if(dist < step){
            u.lat = u.target.toLat;
            u.lng = u.target.toLng;
            u.status = 'onscene';

            const inc = GAME.incidents.find(x=>x.id===u.target.incId);
            // tempo de cena varia
            const onscene = inc ? (inc.sev==='high' ? 12 : (inc.sev==='med' ? 14 : 10)) : 10;
            u.busyUntil = GAME.shiftElapsed + onscene;

            toast(`Unidade chegou: ${u.name}`);
          } else {
            u.lat += (dLat / dist) * step;
            u.lng += (dLng / dist) * step;
          }
        }

        if(u.status === 'onscene' && GAME.shiftElapsed >= u.busyUntil){
          // quando uma unidade termina, tentamos resolver a ocorr√™ncia (MAS s√≥ resolve se pend√™ncias == 0)
          const inc = GAME.incidents.find(x=>x.id===u.target?.incId);
          if(inc){
            resolveIncident(inc);
          }

          // unidade volta a ficar dispon√≠vel
          u.status = 'idle';
          u.target = null;
          u.busyUntil = 0;
          renderUnits();
        }
      }

      renderHUD();
      renderIncidents();
    }

    /***********************
     *  Canvas Map (offline)
     ************************/
    const MAP = {
      canvas: null,
      ctx: null,
      dpr: 1,
      w: 0,
      h: 0,
      zoom: 1.0,
      panX: 0,
      panY: 0,
      dragging: false,
      lastX: 0,
      lastY: 0,
      pinch: false,
      pinchDist: 0,
      pinchZoomStart: 1.0,
    };

    function cityBounds(){
      return CITIES[GAME.cityKey].bounds;
    }
    function worldToNorm(lat, lng){
      const b = cityBounds();
      const nx = (lng - b.lngMin) / (b.lngMax - b.lngMin);
      const ny = (lat - b.latMin) / (b.latMax - b.latMin);
      return { nx, ny };
    }
    function normToScreen(nx, ny){
      const x = (nx - 0.5) * MAP.w * MAP.zoom + MAP.w/2 + MAP.panX;
      const y = (-(ny - 0.5)) * MAP.h * MAP.zoom + MAP.h/2 + MAP.panY;
      return { x, y };
    }
    function worldToScreen(lat, lng){
      const { nx, ny } = worldToNorm(lat, lng);
      return normToScreen(nx, ny);
    }

    function resizeCanvas(){
      const c = MAP.canvas;
      const rect = c.getBoundingClientRect();
      MAP.dpr = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
      MAP.w = Math.max(1, Math.floor(rect.width));
      MAP.h = Math.max(1, Math.floor(rect.height));
      c.width = Math.floor(MAP.w * MAP.dpr);
      c.height = Math.floor(MAP.h * MAP.dpr);
      MAP.ctx.setTransform(MAP.dpr, 0, 0, MAP.dpr, 0, 0);
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    function drawMap(){
      const ctx = MAP.ctx;
      ctx.clearRect(0, 0, MAP.w, MAP.h);

      const grad = ctx.createLinearGradient(0,0, MAP.w, MAP.h);
      grad.addColorStop(0, 'rgba(96,165,250,0.08)');
      grad.addColorStop(0.5,'rgba(0,0,0,0.15)');
      grad.addColorStop(1,'rgba(239,68,68,0.06)');
      ctx.fillStyle = 'rgba(0,0,0,0.25)';
      ctx.fillRect(0,0,MAP.w,MAP.h);
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,MAP.w,MAP.h);

      const gridStep = 48 * MAP.zoom;
      ctx.save();
      ctx.translate(MAP.panX % gridStep, MAP.panY % gridStep);
      ctx.strokeStyle = 'rgba(255,255,255,0.06)';
      ctx.lineWidth = 1;
      for(let x=0; x<MAP.w+gridStep; x+=gridStep){
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,MAP.h); ctx.stroke();
      }
      for(let y=0; y<MAP.h+gridStep; y+=gridStep){
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(MAP.w,y); ctx.stroke();
      }
      ctx.restore();

      ctx.fillStyle = 'rgba(255,255,255,0.82)';
      ctx.font = '700 13px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.fillText(`${CITIES[GAME.cityKey].label} ‚Ä¢ Zoom ${MAP.zoom.toFixed(2)}`, 12, MAP.h - 14);

      // linhas unidade->alvo
      for(const u of GAME.units){
        if(u.status === 'enroute' && u.target){
          const a = worldToScreen(u.lat, u.lng);
          const b = worldToScreen(u.target.toLat, u.target.toLng);
          ctx.strokeStyle = u.target.ok ? 'rgba(34,197,94,0.80)' : 'rgba(245,158,11,0.80)';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.moveTo(a.x, a.y);
          ctx.lineTo(b.x, b.y);
          ctx.stroke();
        }
      }

      // ocorr√™ncias
      for(const inc of GAME.incidents){
        const p = worldToScreen(inc.loc.lat, inc.loc.lng);
        const r = 10;
        const col = inc.sev==='high' ? 'rgba(239,68,68,0.95)' : (inc.sev==='med' ? 'rgba(245,158,11,0.95)' : 'rgba(34,197,94,0.95)');

        if(GAME.selectedIncidentId === inc.id){
          ctx.fillStyle = 'rgba(96,165,250,0.22)';
          ctx.beginPath();
          ctx.arc(p.x, p.y, r+10, 0, Math.PI*2);
          ctx.fill();
        }

        ctx.fillStyle = col;
        ctx.strokeStyle = 'rgba(255,255,255,0.25)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(p.x, p.y, r, 0, Math.PI*2);
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = 'rgba(255,255,255,0.85)';
        ctx.font = '11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
        ctx.fillText(fmtMMSS(inc.timeLeft), p.x + 14, p.y + 4);

        computeRemaining(inc);
        if(inc.pending.length){
          ctx.fillStyle = 'rgba(255,255,255,0.75)';
          ctx.font = '11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
          ctx.fillText(`FALTA: ${inc.pending.join(',')}`, p.x + 14, p.y + 18);
        }
      }

      // unidades
      for(const u of GAME.units){
        const p = worldToScreen(u.lat, u.lng);
        const s = 16;
        let col = 'rgba(96,165,250,0.95)';
        if(u.type==='fire') col = 'rgba(251,113,133,0.95)';
        if(u.type==='medic') col = 'rgba(52,211,153,0.95)';

        if(selectedUnitId === u.id){
          ctx.fillStyle = 'rgba(167,139,250,0.22)';
          roundRect(ctx, p.x-(s/2)-8, p.y-(s/2)-8, s+16, s+16, 10);
          ctx.fill();
        }

        ctx.fillStyle = col;
        ctx.strokeStyle = 'rgba(255,255,255,0.25)';
        ctx.lineWidth = 2;
        roundRect(ctx, p.x-(s/2), p.y-(s/2), s, s, 6);
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = 'rgba(0,0,0,0.75)';
        ctx.font = '900 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
        const letter = u.type==='police' ? 'P' : (u.type==='fire' ? 'F' : 'M');
        ctx.fillText(letter, p.x-4, p.y+4);

        if(u.status !== 'idle'){
          ctx.fillStyle = 'rgba(255,255,255,0.85)';
          ctx.font = '11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
          ctx.fillText(u.status, p.x + 12, p.y - 8);
        }
      }

      requestAnimationFrame(drawMap);
    }

    function hitTest(x, y){
      for(const inc of [...GAME.incidents].reverse()){
        const p = worldToScreen(inc.loc.lat, inc.loc.lng);
        const dx = x - p.x, dy = y - p.y;
        if(Math.hypot(dx,dy) <= 14) return { kind:'incident', id: inc.id };
      }
      for(const u of [...GAME.units].reverse()){
        const p = worldToScreen(u.lat, u.lng);
        if(Math.abs(x-p.x) <= 12 && Math.abs(y-p.y) <= 12) return { kind:'unit', id: u.id };
      }
      return null;
    }

    function setupCanvasMap(){
      MAP.canvas = $('mapCanvas');
      MAP.ctx = MAP.canvas.getContext('2d', { alpha: true });

      const ro = new ResizeObserver(()=>{ resizeCanvas(); });
      ro.observe($('mapWrap'));

      resizeCanvas();
      MAP.zoom = 1.05;
      MAP.panX = 0;
      MAP.panY = 0;

      MAP.canvas.addEventListener('pointerdown', (e)=>{
        MAP.canvas.setPointerCapture(e.pointerId);
        MAP.dragging = true;
        MAP.lastX = e.clientX;
        MAP.lastY = e.clientY;
      });
      MAP.canvas.addEventListener('pointermove', (e)=>{
        if(!MAP.dragging) return;
        const dx = e.clientX - MAP.lastX;
        const dy = e.clientY - MAP.lastY;
        MAP.lastX = e.clientX;
        MAP.lastY = e.clientY;
        MAP.panX += dx;
        MAP.panY += dy;
      });
      MAP.canvas.addEventListener('pointerup', (e)=>{
        if(!MAP.dragging) return;
        MAP.dragging = false;

        const rect = MAP.canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left);
        const y = (e.clientY - rect.top);
        const hit = hitTest(x, y);
        if(hit){
          if(hit.kind==='incident'){
            selectIncident(hit.id);
          } else if(hit.kind==='unit'){
            if(!GAME.selectedIncidentId){
              toast('Selecione uma ocorr√™ncia primeiro.');
            } else {
              selectUnitForDispatch(hit.id);
            }
          }
        }
      });

      MAP.canvas.addEventListener('wheel', (e)=>{
        e.preventDefault();
        const delta = -e.deltaY;
        const factor = delta > 0 ? 1.08 : 0.92;
        MAP.zoom = clamp(MAP.zoom * factor, 0.65, 2.6);
      }, { passive:false });

      MAP.canvas.addEventListener('touchstart', (e)=>{
        if(e.touches.length === 2){
          MAP.pinch = true;
          MAP.pinchDist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );
          MAP.pinchZoomStart = MAP.zoom;
        }
      }, { passive:true });

      MAP.canvas.addEventListener('touchmove', (e)=>{
        if(MAP.pinch && e.touches.length === 2){
          const dist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );
          const ratio = dist / (MAP.pinchDist || dist);
          MAP.zoom = clamp(MAP.pinchZoomStart * ratio, 0.65, 2.6);
        }
      }, { passive:true });

      MAP.canvas.addEventListener('touchend', (e)=>{
        if(e.touches.length < 2){
          MAP.pinch = false;
        }
      }, { passive:true });

      requestAnimationFrame(drawMap);
    }

    /***********************
     *  UI wiring
     ************************/
    function wire(){
      $('btnStart').onclick = startShift;
      $('btnEnd').onclick = endShift;

      $('btnNextCall').onclick = ()=>{
        if(!GAME.running){ toast('Inicie o turno primeiro.'); return; }
        enqueueCall();
        if(!GAME.activeCall) popNextCall();
      };

      $('btnDispatch').onclick = dispatchSelected;
      $('btnUnselect').onclick = clearSelection;

      $('city').onchange = ()=>{
        if(GAME.running){
          toast('Para trocar cidade, encerre o turno.');
          $('city').value = GAME.cityKey;
          return;
        }
        GAME.cityKey = $('city').value;
        $('regionTag').textContent = CITIES[GAME.cityKey].regionTag;
      };

      $('agency').onchange = ()=>{
        if(GAME.running){
          toast('Para trocar ag√™ncia, encerre o turno.');
          $('agency').value = GAME.agency;
          return;
        }
      };

      $('btnClearSave').onclick = ()=>{
        localStorage.removeItem(SAVE_KEY);
        CAREER = loadCareer();
        toast('Carreira resetada.');
        renderHUD();
      };
    }

    /***********************
     *  Boot
     ************************/
    $('city').value = 'saopaulo';
    $('agency').value = 'police';
    $('regionTag').textContent = CITIES.saopaulo.regionTag;

    wire();
    setupCanvasMap();
    renderAll();

    setTimeout(()=>toast('Fase 2: Ocorr√™ncia agora exige despacho MANUAL e pode precisar de m√∫ltiplas unidades.'), 650);
  </script>
</body>
</html>