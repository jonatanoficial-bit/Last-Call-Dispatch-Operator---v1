<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Last Call Dispatch Operator</title>

<style>
  :root{
    --bg:#0b0e13;
    --panel:#141a24;
    --panel2:#101521;
    --line:#1f2a3a;
    --text:#e9edf3;
    --muted:#9fb0c7;
    --accent:#4fd1c5;
    --accent2:#63b3ed;
    --danger:#ef4444;
    --warn:#f59e0b;
    --ok:#22c55e;
    --btn:#2563eb;
    --btn2:#1d4ed8;
    --ghost:#2b3b56;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(1200px 700px at 20% 0%, #101a2a 0%, var(--bg) 55%);
    color:var(--text);
  }
  header{
    padding:10px 12px;
    background: linear-gradient(180deg, #0f172a 0%, #0b1222 100%);
    border-bottom:1px solid var(--line);
    position:sticky; top:0; z-index:5;
  }
  .topbar{
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    flex-wrap:wrap;
  }
  .brand{
    font-weight:900;
    letter-spacing:0.4px;
    color:var(--accent);
    display:flex; align-items:center; gap:10px;
  }
  .chip{
    font-size:12px;
    color:#cfe7ff;
    border:1px solid #233047;
    background: rgba(20,26,36,0.7);
    padding:4px 8px;
    border-radius:999px;
  }
  .controls{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }
  select, input{
    background:#0f172a;
    border:1px solid #233047;
    color:var(--text);
    padding:8px 10px;
    border-radius:12px;
    outline:none;
    font-size:14px;
  }
  button{
    border:none;
    background: var(--btn);
    color:#fff;
    padding:10px 12px;
    border-radius:12px;
    font-weight:800;
    cursor:pointer;
    font-size:14px;
    transition: transform .05s ease, background .15s ease, opacity .15s ease;
  }
  button:active{ transform: scale(0.98); }
  button:hover{ background: var(--btn2); }
  button:disabled{
    opacity:0.5;
    cursor:not-allowed;
  }
  .btn-ghost{
    background: transparent;
    border:1px solid var(--ghost);
    color: var(--text);
  }
  .btn-ghost:hover{ background: rgba(99,179,237,0.10); }
  .btn-danger{ background:#b91c1c; }
  .btn-danger:hover{ background:#991b1b; }
  .btn-ok{ background:#15803d; }
  .btn-ok:hover{ background:#166534; }

  main{
    padding:12px;
    display:grid;
    grid-template-columns: 1.05fr 0.95fr;
    gap:12px;
    max-width: 1240px;
    margin: 0 auto;
  }
  @media (max-width: 920px){
    main{ grid-template-columns: 1fr; }
  }

  .panel{
    background: linear-gradient(180deg, rgba(20,26,36,0.98), rgba(14,18,26,0.98));
    border:1px solid var(--line);
    border-radius:18px;
    overflow:hidden;
    box-shadow: 0 12px 30px rgba(0,0,0,0.22);
  }
  .panel-header{
    padding:10px 12px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    background: rgba(12,16,24,0.75);
  }
  .panel-header h3{
    margin:0;
    font-size:13px;
    color: var(--accent2);
    letter-spacing:0.6px;
    text-transform: uppercase;
  }
  .panel-body{ padding:12px; }

  .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (max-width: 520px){
    .grid2{ grid-template-columns:1fr; }
  }

  .statrow{
    display:flex; gap:10px; flex-wrap:wrap;
  }
  .stat{
    flex: 1;
    min-width: 150px;
    background: rgba(8,12,18,0.55);
    border:1px solid #202b40;
    border-radius:16px;
    padding:10px;
  }
  .stat .k{ font-size:12px; color:var(--muted); }
  .stat .v{ font-size:16px; font-weight:900; margin-top:3px; }
  .v .small{ font-size:12px; font-weight:800; color:var(--muted); }

  .divider{
    height:1px;
    background: rgba(255,255,255,0.08);
    margin:10px 0;
  }

  /* Call UI */
  .callbox{
    background: rgba(7,10,16,0.55);
    border:1px solid #202b40;
    border-radius:16px;
    padding:12px;
  }
  .calltitle{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; margin-bottom:10px;
    flex-wrap:wrap;
  }
  .badge{
    font-size:12px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid #2b3b56;
    color:#dbeafe;
    background: rgba(37,99,235,0.12);
    font-weight:900;
    letter-spacing:0.3px;
  }
  .badge.badge-danger{ border-color: rgba(239,68,68,0.35); background: rgba(239,68,68,0.12); }
  .badge.badge-warn{ border-color: rgba(245,158,11,0.35); background: rgba(245,158,11,0.12); }
  .badge.badge-ok{ border-color: rgba(34,197,94,0.35); background: rgba(34,197,94,0.12); }

  #callText{
    min-height: 140px;
    white-space: pre-wrap;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;
    font-size: 14px;
    line-height: 1.35;
  }

  .options{
    display:flex;
    flex-direction: column;
    gap:8px;
    margin-top:10px;
  }
  .optbtn{
    text-align:left;
    background: rgba(37,99,235,0.18);
    border:1px solid rgba(99,179,237,0.35);
    color:#eaf3ff;
  }
  .optbtn:hover{ background: rgba(37,99,235,0.25); }

  .hint{
    font-size:12px;
    color: var(--muted);
    background: rgba(99,179,237,0.08);
    border:1px solid rgba(99,179,237,0.20);
    padding:10px;
    border-radius:16px;
  }

  /* Dispatch lists */
  .subtle{
    font-size:12px;
    color: var(--muted);
  }
  .list{
    display:flex;
    flex-direction: column;
    gap:8px;
  }
  .card{
    background: rgba(8,12,18,0.55);
    border:1px solid #202b40;
    border-radius:16px;
    padding:10px;
    display:flex;
    gap:10px;
    align-items:flex-start;
    justify-content:space-between;
  }
  .card.sel{
    outline: 2px solid rgba(79,209,197,0.35);
    border-color: rgba(79,209,197,0.25);
  }
  .card.locked{
    opacity:0.55;
    filter: grayscale(0.25);
  }
  .left{
    display:flex;
    flex-direction: column;
    gap:3px;
    min-width:0;
  }
  .title{
    font-weight:950;
    font-size:14px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .meta{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    font-size:12px;
    color:var(--muted);
  }
  .pill{
    font-size:12px;
    padding:3px 9px;
    border-radius:999px;
    border:1px solid #2b3b56;
    background: rgba(16,21,33,0.55);
    color:#dbeafe;
    font-weight:800;
  }
  .pill.ok{ border-color: rgba(34,197,94,0.35); background: rgba(34,197,94,0.10); color:#d1fae5;}
  .pill.warn{ border-color: rgba(245,158,11,0.35); background: rgba(245,158,11,0.12); color:#ffedd5;}
  .pill.danger{ border-color: rgba(239,68,68,0.35); background: rgba(239,68,68,0.12); color:#ffe4e6;}
  .right{
    display:flex;
    flex-direction: column;
    gap:6px;
    align-items:flex-end;
    flex-shrink:0;
  }
  .minirow{
    display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;
  }
  .tinybtn{
    padding:8px 10px;
    font-size:13px;
    border-radius:12px;
  }

  /* Unit selection checkbox-ish */
  .check{
    width:18px; height:18px;
    border-radius:6px;
    border:1px solid #2b3b56;
    background: rgba(16,21,33,0.55);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    font-weight:950;
    color:#dbeafe;
  }
  .check.on{
    border-color: rgba(79,209,197,0.55);
    background: rgba(79,209,197,0.14);
    color:#d1fae5;
  }

  /* Map placeholder */
  .map{
    height: 230px;
    border-radius:18px;
    border:1px solid #202b40;
    background:
      radial-gradient(800px 300px at 10% 10%, rgba(79,209,197,0.15), transparent 60%),
      radial-gradient(800px 300px at 80% 30%, rgba(99,179,237,0.12), transparent 55%),
      linear-gradient(180deg, rgba(8,12,18,0.75), rgba(8,12,18,0.55));
    position: relative;
    overflow:hidden;
  }
  .map::before{
    content:"";
    position:absolute; inset:-40px;
    background:
      repeating-linear-gradient(90deg, rgba(255,255,255,0.04) 0, rgba(255,255,255,0.04) 1px, transparent 1px, transparent 22px),
      repeating-linear-gradient(0deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 22px);
    opacity:0.65;
    transform: rotate(-2deg);
  }
  .maphud{
    position:absolute; inset:0;
    display:flex; flex-direction:column;
    justify-content:space-between;
    padding:10px;
  }
  .maptop{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .maptitle{
    font-weight:950;
    letter-spacing:0.5px;
    color:#dbeafe;
  }
  .mapzone{
    font-size:12px;
    color: var(--muted);
  }
  .mappins{
    position:absolute; left:0; right:0; top:0; bottom:0;
    pointer-events:none;
  }
  .pin{
    position:absolute;
    width:12px; height:12px;
    border-radius:999px;
    background: rgba(239,68,68,0.95);
    box-shadow: 0 0 0 6px rgba(239,68,68,0.14);
    animation: pulse 1.4s infinite;
  }
  .pin.ok{
    background: rgba(34,197,94,0.95);
    box-shadow: 0 0 0 6px rgba(34,197,94,0.14);
  }
  @keyframes pulse{
    0%{ transform: scale(1); opacity:1; }
    70%{ transform: scale(1.08); opacity:0.95; }
    100%{ transform: scale(1); opacity:1; }
  }

  .log{
    max-height: 190px;
    overflow:auto;
    border-radius:16px;
    border:1px solid #202b40;
    background: rgba(7,10,16,0.55);
    padding:10px;
    font-size:12px;
    color: #c9d6ea;
    line-height:1.35;
    white-space: pre-wrap;
  }

  .filters{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    margin-bottom:8px;
  }
  .tabs{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .tab{
    padding:8px 10px;
    border-radius:999px;
    border:1px solid #2b3b56;
    background: rgba(16,21,33,0.55);
    color:#dbeafe;
    font-size:12px;
    font-weight:900;
    cursor:pointer;
    user-select:none;
  }
  .tab.on{
    border-color: rgba(79,209,197,0.55);
    background: rgba(79,209,197,0.14);
    color:#d1fae5;
  }
  .recbox{
    background: rgba(8,12,18,0.55);
    border:1px solid #202b40;
    border-radius:16px;
    padding:10px;
    margin-top:10px;
  }
  .recline{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    padding:8px 0;
    border-top:1px solid rgba(255,255,255,0.06);
  }
  .recline:first-child{ border-top:none; }
  .recl{
    display:flex; flex-direction:column; gap:2px; min-width:0;
  }
  .recl .nm{
    font-weight:950; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  .recl .why{ font-size:12px; color:var(--muted); }
  .xpbar{
    height:10px;
    border-radius:999px;
    border:1px solid #2b3b56;
    background: rgba(16,21,33,0.55);
    overflow:hidden;
    margin-top:6px;
  }
  .xpfill{
    height:100%;
    background: rgba(79,209,197,0.45);
    width:0%;
  }
</style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <span>Last Call Dispatch Operator</span>
      <span class="chip" id="buildTag">FASE 3 ‚Äî Multi-Despacho + Carreira</span>
    </div>

    <div class="controls">
      <select id="citySelect" title="Cidade / cen√°rio">
        <option value="sao_paulo">S√£o Paulo (BR)</option>
        <option value="new_york">New York (USA)</option>
      </select>

      <button id="startShiftBtn">Iniciar Turno</button>
      <button id="endShiftBtn" class="btn-danger" disabled>Encerrar Turno</button>
      <button id="newCallBtn" class="btn-ghost" disabled>Nova Chamada</button>
      <button id="resetCareerBtn" class="btn-ghost" title="Apaga progresso salvo no aparelho">Reset Carreira</button>
    </div>
  </div>
</header>

<main>

  <!-- LEFT: Calls + Career -->
  <section class="panel">
    <div class="panel-header">
      <h3>Atendimento + Carreira</h3>
      <div class="subtle" id="callStatus">Turno n√£o iniciado</div>
    </div>

    <div class="panel-body">
      <div class="statrow">
        <div class="stat">
          <div class="k">Pontua√ß√£o (turno)</div>
          <div class="v" id="scoreEl">0</div>
        </div>
        <div class="stat">
          <div class="k">Reputa√ß√£o (turno)</div>
          <div class="v" id="repEl">50 <span class="small">/100</span></div>
        </div>
        <div class="stat">
          <div class="k">Patente (turno)</div>
          <div class="v" id="rankEl">Recruta</div>
        </div>
        <div class="stat">
          <div class="k">Tempo de turno</div>
          <div class="v" id="shiftTimeEl">--:--</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="statrow">
        <div class="stat">
          <div class="k">Carreira ‚Äî N√≠vel</div>
          <div class="v" id="careerLevelEl">1</div>
          <div class="xpbar" aria-label="XP">
            <div class="xpfill" id="careerXpFill"></div>
          </div>
          <div class="subtle" id="careerXpText" style="margin-top:6px;">XP: 0/100</div>
        </div>
        <div class="stat">
          <div class="k">Carreira ‚Äî Cr√©ditos</div>
          <div class="v" id="careerCreditsEl">0</div>
          <div class="subtle" id="careerUnlockHint" style="margin-top:6px;">Desbloqueios por n√≠vel: T√°tica, Anti-bomba, A√©reo‚Ä¶</div>
        </div>
        <div class="stat">
          <div class="k">Carreira ‚Äî Melhor Pontua√ß√£o</div>
          <div class="v" id="careerBestEl">0</div>
          <div class="subtle" id="careerCityBestEl" style="margin-top:6px;">SP: 0 ‚Ä¢ NY: 0</div>
        </div>
        <div class="stat">
          <div class="k">Carreira ‚Äî Conclus√µes</div>
          <div class="v" id="careerStatsEl">0</div>
          <div class="subtle" id="careerFailEl" style="margin-top:6px;">Falhas: 0</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="callbox">
        <div class="calltitle">
          <div>
            <span class="badge" id="callBadge">SEM CHAMADA</span>
          </div>
          <div class="subtle" id="callTimerEl">Tempo de chamada: --</div>
        </div>

        <div id="callText">Inicie o turno para come√ßar a operar.</div>

        <div class="options" id="options"></div>

        <div class="divider"></div>

        <div class="hint" id="callHint">
          Dica: Em casos graves, primeiro garanta seguran√ßa do chamador e local. Depois despache a unidade CERTA.
        </div>
      </div>

    </div>
  </section>

  <!-- RIGHT: Dispatch -->
  <section class="panel">
    <div class="panel-header">
      <h3>Despacho</h3>
      <div class="subtle" id="dispatchStatus">Aguardando turno</div>
    </div>

    <div class="panel-body">
      <div class="map" id="mapBox">
        <div class="maphud">
          <div class="maptop">
            <div>
              <div class="maptitle" id="mapTitle">Cidade</div>
              <div class="mapzone" id="mapZone">Zonas</div>
            </div>
            <div class="pill" id="activeIncidentsPill">0 incidentes</div>
          </div>

          <div class="subtle">
            Mapa estilizado (placeholder). Pr√≥xima fase: mapa real (Leaflet/OSM) sem quebrar a arquitetura.
          </div>
        </div>

        <div class="mappins" id="pins"></div>
      </div>

      <div class="divider"></div>

      <div class="grid2">
        <div>
          <div class="subtle" style="margin-bottom:8px;">Fila de incidentes (selecione 1)</div>
          <div class="list" id="incidentList"></div>

          <div class="recbox" id="recommendBox" style="display:none;">
            <div style="font-weight:950; color:#dbeafe; margin-bottom:6px;">Recomendado (1 toque para selecionar)</div>
            <div id="recommendList"></div>
          </div>
        </div>

        <div>
          <div class="filters">
            <div class="tabs" id="unitTabs">
              <div class="tab on" data-role="all">TODAS</div>
              <div class="tab" data-role="police">POL√çCIA</div>
              <div class="tab" data-role="fire">BOMBEIROS</div>
              <div class="tab" data-role="ems">EMS</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <label class="subtle" style="display:flex; gap:6px; align-items:center;">
                <input type="checkbox" id="onlyAvailableChk" checked />
                Dispon√≠vel
              </label>
              <input id="unitSearch" placeholder="Buscar unidade‚Ä¶" />
            </div>
          </div>

          <div class="subtle" style="margin-bottom:8px;">
            Unidades (toque para marcar v√°rias). Selecionadas: <b id="selCount">0</b>
          </div>

          <div class="list" id="unitList"></div>

          <div class="divider"></div>

          <div class="controls" style="justify-content:space-between;">
            <button id="clearUnitsBtn" class="btn-ghost">Limpar Sele√ß√£o</button>
            <button id="dispatchBtn" disabled>Despachar Selecionadas</button>
          </div>

          <div class="hint" id="dispatchHint" style="margin-top:10px;">
            Regra AAA: incidentes podem exigir 2+ unidades. Ex.: acidente com preso ‚Üí Resgate + Ambul√¢ncia.
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="subtle" style="margin-bottom:8px;">Registro Operacional</div>
      <div class="log" id="logEl"></div>
    </div>
  </section>

</main>

<script>
/* ==========================
   Utils
========================== */
const $ = (id) => document.getElementById(id);
const now = () => Date.now();
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
const pad2 = (n) => String(n).padStart(2, "0");
function formatMMSS(ms){
  const s = Math.max(0, Math.floor(ms / 1000));
  const m = Math.floor(s / 60);
  const ss = s % 60;
  return `${pad2(m)}:${pad2(ss)}`;
}
function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

/* ==========================
   Tiny Audio (no assets)
========================== */
let audioEnabled = true;
function beep(freq=700, dur=60, type="square", gain=0.02){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, dur);
  }catch(e){}
}
function ringOnce(){
  if(!audioEnabled) return;
  beep(880, 90, "sine", 0.03);
  setTimeout(()=>beep(880, 90, "sine", 0.03), 150);
  setTimeout(()=>beep(880, 90, "sine", 0.03), 300);
}
function tickType(){
  if(!audioEnabled) return;
  beep(1200, 18, "square", 0.008);
}

/* ==========================
   Typewriter
========================== */
let typingHandle = null;
function typeText(el, text, speed=16, onDone=null){
  if(typingHandle) clearInterval(typingHandle);
  el.textContent = "";
  let i = 0;
  typingHandle = setInterval(()=>{
    el.textContent += text.charAt(i);
    if(text.charAt(i) !== " " && text.charAt(i) !== "\n") tickType();
    i++;
    if(i >= text.length){
      clearInterval(typingHandle);
      typingHandle = null;
      if(onDone) onDone();
    }
  }, speed);
}

/* ==========================
   Career Persistence
========================== */
const CAREER_KEY = "lcdo_career_v1";

function defaultCareer(){
  return {
    level: 1,
    xp: 0,
    xpToNext: 100,
    credits: 0,
    bestScore: 0,
    cityBest: { sao_paulo: 0, new_york: 0 },
    totalResolved: 0,
    totalFailed: 0
  };
}

function loadCareer(){
  try{
    const raw = localStorage.getItem(CAREER_KEY);
    if(!raw) return defaultCareer();
    const parsed = JSON.parse(raw);
    // safe merge
    const base = defaultCareer();
    return {
      ...base,
      ...parsed,
      cityBest: { ...base.cityBest, ...(parsed.cityBest||{}) }
    };
  }catch(e){
    return defaultCareer();
  }
}

function saveCareer(){
  try{
    localStorage.setItem(CAREER_KEY, JSON.stringify(career));
  }catch(e){}
}

function resetCareer(){
  career = defaultCareer();
  saveCareer();
  log("Carreira resetada (progresso apagado do aparelho).");
  renderCareer();
  loadCity(state.cityKey);
}

function gainXP(amount){
  career.xp += Math.max(0, amount);
  while(career.xp >= career.xpToNext){
    career.xp -= career.xpToNext;
    career.level += 1;
    // escalate requirement a bit
    career.xpToNext = Math.floor(career.xpToNext * 1.18 + 30);
    career.credits += 25; // bonus per level
    log(`‚≠ê Subiu de n√≠vel! Agora: N√≠vel ${career.level}. Novos desbloqueios dispon√≠veis.`);
  }
  saveCareer();
  renderCareer();
}

function awardShiftRewards(){
  // based on score and performance
  const baseXP = Math.floor(state.score * 0.55) + state.resolved * 8;
  const penalty = state.failed * 6;
  const xp = Math.max(0, baseXP - penalty);
  const credits = Math.max(0, Math.floor(state.score * 0.25) + state.resolved * 3 - state.failed * 2);

  career.credits += credits;
  career.totalResolved += state.resolved;
  career.totalFailed += state.failed;

  if(state.score > career.bestScore) career.bestScore = state.score;
  if(state.score > (career.cityBest[state.cityKey]||0)) career.cityBest[state.cityKey] = state.score;

  gainXP(xp); // calls save+render inside
  saveCareer();

  return { xp, credits };
}

/* ==========================
   Game Data
========================== */
const CITY_CONFIG = {
  sao_paulo: {
    name: "S√£o Paulo",
    zones: ["Centro","Norte","Sul","Leste","Oeste"],
    unitTemplates: [
      // unlockLevel: 1 basic
      { id:"sp_area_1", name:"Pol√≠cia de √Årea A-01", role:"police", tags:["patrol","area"], speed:1.00, riskHandle:1, cost:1, zone:"Centro", unlockLevel:1 },
      { id:"sp_area_2", name:"Pol√≠cia de √Årea A-02", role:"police", tags:["patrol","area"], speed:1.05, riskHandle:1, cost:1, zone:"Leste", unlockLevel:1 },

      // level 3 tactical
      { id:"sp_rota",   name:"ROTA (Resposta T√°tica)", role:"police", tags:["tactical","highrisk"], speed:1.15, riskHandle:3, cost:3, zone:"Oeste", unlockLevel:3 },

      // level 4 bomb/crises
      { id:"sp_gate",   name:"GATE (Anti-bomba/Crises)", role:"police", tags:["bomb","hostage","highrisk","tactical"], speed:0.95, riskHandle:4, cost:4, zone:"Centro", unlockLevel:4 },

      // level 3 riot
      { id:"sp_choque", name:"Choque (Dist√∫rbios)", role:"police", tags:["riot","highrisk","tactical"], speed:0.90, riskHandle:3, cost:3, zone:"Norte", unlockLevel:3 },

      // level 5 air
      { id:"sp_aguia",  name:"√Åguia (Helic√≥ptero)", role:"police", tags:["air","pursuit","highrisk","tactical"], speed:1.35, riskHandle:3, cost:5, zone:"Sul", unlockLevel:5 },

      // fire/ems unlock 2
      { id:"sp_resgate",name:"Bombeiros Resgate R-01", role:"fire", tags:["rescue","extrication","fire"], speed:0.95, riskHandle:2, cost:3, zone:"Centro", unlockLevel:2 },
      { id:"sp_ambul",  name:"Ambul√¢ncia (Suporte B√°sico)", role:"ems", tags:["medical","ems"], speed:1.05, riskHandle:2, cost:2, zone:"Leste", unlockLevel:2 }
    ]
  },
  new_york: {
    name: "New York",
    zones: ["Downtown","Uptown","Queens","Brooklyn","Bronx"],
    unitTemplates: [
      { id:"ny_patrol_1", name:"NYPD Patrol P-12", role:"police", tags:["patrol","area"], speed:1.05, riskHandle:1, cost:1, zone:"Downtown", unlockLevel:1 },
      { id:"ny_patrol_2", name:"NYPD Patrol P-21", role:"police", tags:["patrol","area"], speed:1.00, riskHandle:1, cost:1, zone:"Brooklyn", unlockLevel:1 },

      { id:"ny_swat",     name:"SWAT (High Risk)", role:"police", tags:["tactical","highrisk","hostage"], speed:1.10, riskHandle:4, cost:4, zone:"Queens", unlockLevel:3 },
      { id:"ny_fbi",      name:"FBI Liaison (Federal)", role:"police", tags:["federal","organized","highrisk"], speed:0.95, riskHandle:3, cost:4, zone:"Downtown", unlockLevel:4 },
      { id:"ny_sheriff",  name:"Sheriff Unit (Warrants)", role:"police", tags:["warrants","area"], speed:0.90, riskHandle:2, cost:2, zone:"Bronx", unlockLevel:2 },

      { id:"ny_ems",      name:"EMS Ambulance E-08", role:"ems", tags:["medical","ems"], speed:1.10, riskHandle:3, cost:3, zone:"Uptown", unlockLevel:2 },
      { id:"ny_fire",     name:"Fire Engine F-03", role:"fire", tags:["fire","rescue"], speed:1.00, riskHandle:3, cost:3, zone:"Queens", unlockLevel:2 }
    ]
  }
};

// Incident requirements are now evaluated across MULTIPLE UNITS.
const CALL_POOL = [
  {
    id:"prank_kid",
    severity:"trote",
    title:"Poss√≠vel trote",
    intro: (city) => `Central de emerg√™ncia, ${city.name}.`,
    first: "√î mo√ßo... tem um dinossauro na rua aqui üòÇ",
    steps: [
      {
        text: "O chamador parece rindo e n√£o fornece informa√ß√µes coerentes.",
        options: [
          { label:"Confirmar endere√ßo e natureza real", effect:{quality:+1}, next:1 },
          { label:"Despachar patrulha imediatamente", effect:{quality:-2}, end:"Voc√™ despachou sem confirmar. Recurso desperdi√ßado." }
        ]
      },
      {
        text: "Ele muda a hist√≥ria e d√° um endere√ßo inexistente.",
        options: [
          { label:"Encerrar por trote e registrar", end:"Trote identificado. Boa triagem." },
          { label:"Insistir e manter na linha", effect:{quality:-1}, end:"Tempo perdido. Outras chamadas podem ficar sem resposta." }
        ]
      }
    ],
    incident: (city) => ({
      type:"trote",
      zone: pick(city.zones),
      required: {
        anyOfTags: ["triage", "patrol"], // qualquer patrulha serve (ideal √© encerrar sem despacho)
        mustHaveTags: [],               // nada obrigat√≥rio
        minRiskHandle: 0,
        minUnits: 0
      },
      baseUrgency: 0.7
    })
  },

  {
    id:"noise_neighbor",
    severity:"leve",
    title:"Perturba√ß√£o do sossego",
    intro: (city) => `Central de emerg√™ncia, ${city.name}. Qual sua ocorr√™ncia?`,
    first: "Meu vizinho t√° com som alto desde cedo. N√£o consigo dormir.",
    steps: [
      {
        text: "Ocorr√™ncia sem risco imediato. Precisa triagem e registro.",
        options: [
          { label:"Coletar endere√ßo e orientar", effect:{quality:+2}, next:1 },
          { label:"Enviar unidade t√°tica", effect:{quality:-2}, end:"Resposta exagerada. Custo alto sem necessidade." }
        ]
      },
      {
        text: "O chamador confirma que n√£o h√° amea√ßa ou armas.",
        options: [
          { label:"Registrar como baixa prioridade", end:"Registrado. Orienta√ß√£o correta." },
          { label:"Mandar resolver sozinho", effect:{quality:-1}, end:"Postura inadequada. Reputa√ß√£o caiu." }
        ]
      }
    ],
    incident: (city) => ({
      type:"police_low",
      zone: pick(city.zones),
      required: {
        anyOfTags: ["patrol","area"],
        mustHaveTags: [],
        minRiskHandle: 1,
        minUnits: 1
      },
      baseUrgency: 1.0
    })
  },

  {
    id:"traffic_injury",
    severity:"media",
    title:"Acidente com feridos (poss√≠vel preso)",
    intro:(city)=>`Central de emerg√™ncia, ${city.name}. Diga o que aconteceu.`,
    first:"Teve uma colis√£o e uma pessoa t√° sangrando!",
    steps:[
      {
        text:"Confirme localiza√ß√£o e n√∫mero de v√≠timas.",
        options:[
          { label:"Perguntar endere√ßo e n¬∫ de feridos", effect:{quality:+2}, next:1 },
          { label:"Mandar aguardar e desligar", effect:{quality:-3}, end:"Erro: risco de vida sem orienta√ß√£o." }
        ]
      },
      {
        text:"H√° 2 v√≠timas. Uma presa no carro e outra consciente com sangramento.",
        options:[
          { label:"Orientar compress√£o no sangramento e manter calma", effect:{quality:+2}, next:2 },
          { label:"Focar s√≥ na descri√ß√£o do carro", effect:{quality:-1}, next:2 }
        ]
      },
      {
        text:"Cheiro de combust√≠vel aumentou. Pode haver risco de inc√™ndio.",
        options:[
          { label:"Orientar afastar curiosos e desligar igni√ß√£o", effect:{quality:+2}, end:"Boa orienta√ß√£o. Agora despache RESGATE + AMBUL√ÇNCIA." },
          { label:"Ignorar e pedir sil√™ncio", effect:{quality:-2}, end:"Orienta√ß√£o fraca. Risco aumentou." }
        ]
      }
    ],
    incident:(city)=>({
      type:"accident_extrication",
      zone: pick(city.zones),
      required: {
        // precisa: 1 resgate/extrication + 1 ems/medical (m√≠nimo 2 unidades)
        anyOfTags: ["rescue","extrication","medical","ems"],
        mustHaveTags: ["extrication","ems"],
        minRiskHandle: 2,
        minUnits: 2
      },
      baseUrgency: 1.5
    })
  },

  {
    id:"shots_fired",
    severity:"grave",
    title:"Disparos / amea√ßa armada",
    intro:(city)=>`Central de emerg√™ncia, ${city.name}. Qual sua emerg√™ncia?`,
    first:"SOCORRO! Tem algu√©m atirando aqui perto!",
    steps:[
      {
        text:"Voc√™ ouve gritos ao fundo. Prioridade: seguran√ßa do chamador + local.",
        options:[
          { label:"Orientar: se abrigue e diga o local", effect:{quality:+2}, next:1 },
          { label:"Pedir que confronte o suspeito", effect:{quality:-4}, end:"Erro grav√≠ssimo. Risco extremo." }
        ]
      },
      {
        text:"O chamador relata suspeito armado e poss√≠veis feridos.",
        options:[
          { label:"Perguntar descri√ß√£o e dire√ß√£o", effect:{quality:+2}, next:2 },
          { label:"Mandar desligar e correr", effect:{quality:-2}, next:2 }
        ]
      },
      {
        text:"Situa√ß√£o piora: 'Ele entrou no pr√©dio!'",
        options:[
          { label:"Manter na linha e refor√ßar seguran√ßa", effect:{quality:+2}, end:"Ok. Despache unidade T√ÅTICA imediatamente." },
          { label:"Insistir em detalhes irrelevantes", effect:{quality:-2}, end:"Tempo perdido. Chance de v√≠timas aumentou." }
        ]
      }
    ],
    incident:(city)=>({
      type:"active_threat",
      zone: pick(city.zones),
      required: {
        anyOfTags: ["tactical","highrisk"],
        mustHaveTags: ["tactical"],
        minRiskHandle: 3,
        minUnits: 1
      },
      baseUrgency: 1.8
    })
  },

  {
    id:"house_fire",
    severity:"grave",
    title:"Inc√™ndio residencial",
    intro:(city)=>`Central de emerg√™ncia, ${city.name}. Fale agora.`,
    first:"Minha cozinha t√° pegando fogo! Tem fuma√ßa por tudo!",
    steps:[
      {
        text:"Risco alto. Prioridade: evacua√ß√£o e seguran√ßa.",
        options:[
          { label:"Orientar evacuar e N√ÉO usar elevador", effect:{quality:+2}, next:1 },
          { label:"Mandar jogar √°gua sem avaliar", effect:{quality:-2}, next:1 }
        ]
      },
      {
        text:"O chamador diz que h√° uma crian√ßa no quarto.",
        options:[
          { label:"Orientar sair e fechar portas ao sair", effect:{quality:+2}, end:"Orienta√ß√£o correta. Despache BOMBEIROS." },
          { label:"Mandar voltar sozinho", effect:{quality:-4}, end:"Erro grave: risco de morte." }
        ]
      }
    ],
    incident:(city)=>({
      type:"fire",
      zone: pick(city.zones),
      required: {
        anyOfTags: ["fire","rescue"],
        mustHaveTags: ["fire"],
        minRiskHandle: 2,
        minUnits: 1
      },
      baseUrgency: 1.9
    })
  },

  {
    id:"suspicious_package",
    severity:"media",
    title:"Objeto suspeito (poss√≠vel bomba)",
    intro:(city)=>`Central de emerg√™ncia, ${city.name}.`,
    first:"Tem uma mochila abandonada na esta√ß√£o. Ouvi um bip‚Ä¶",
    steps:[
      {
        text:"Voc√™ precisa isolar √°rea e evitar p√¢nico.",
        options:[
          { label:"Orientar afastar pessoas e manter dist√¢ncia", effect:{quality:+2}, next:1 },
          { label:"Mandar algu√©m abrir a mochila", effect:{quality:-4}, end:"Erro cr√≠tico. Risco alt√≠ssimo." }
        ]
      },
      {
        text:"O chamador confirma que o objeto est√° pr√≥ximo de grande fluxo.",
        options:[
          { label:"Manter dist√¢ncia e aguardar equipe especializada", effect:{quality:+2}, end:"Boa decis√£o. Despache ANTI-BOMBA." },
          { label:"Enviar patrulha comum apenas", effect:{quality:-2}, end:"Resposta inadequada para amea√ßa de bomba." }
        ]
      }
    ],
    incident:(city)=>({
      type:"bomb_threat",
      zone: pick(city.zones),
      required: {
        anyOfTags: ["bomb","tactical","highrisk"],
        mustHaveTags: ["bomb"],
        minRiskHandle: 4,
        minUnits: 1
      },
      baseUrgency: 1.6
    })
  }
];

const SEVERITY = {
  trote: { badge:"TROTE", pill:"warn", deadlineMs: 45_000, baseScore: 6,  repDeltaOk:+2, repDeltaBad:-4 },
  leve:  { badge:"LEVE",  pill:"ok",   deadlineMs: 65_000, baseScore: 10, repDeltaOk:+3, repDeltaBad:-6 },
  media: { badge:"M√âDIO", pill:"warn", deadlineMs: 55_000, baseScore: 18, repDeltaOk:+4, repDeltaBad:-10 },
  grave: { badge:"GRAVE", pill:"danger",deadlineMs: 45_000, baseScore: 28, repDeltaOk:+6, repDeltaBad:-18 }
};

function computeRank(score, rep){
  if(rep < 20) return "Em avalia√ß√£o";
  if(score < 40) return "Recruta";
  if(score < 120) return "Operador";
  if(score < 240) return "S√™nior";
  return "Supervisor";
}

/* ==========================
   State
========================== */
let career = loadCareer();

const state = {
  cityKey: "sao_paulo",
  shiftActive: false,
  shiftStart: 0,
  shiftDurationMs: 10 * 60 * 1000,

  score: 0,
  rep: 50,

  callActive: false,
  callStart: 0,
  callTimerHandle: null,
  callQuality: 0,
  currentCall: null,

  incidents: [],
  units: [],
  selectedIncidentId: null,
  selectedUnitIds: new Set(),

  resolved: 0,
  failed: 0,

  // unit filters
  unitRoleFilter: "all",
  onlyAvailable: true,
  unitSearch: ""
};

let incidentCounter = 1;

/* ==========================
   UI Elements
========================== */
const citySelect = $("citySelect");
const startShiftBtn = $("startShiftBtn");
const endShiftBtn = $("endShiftBtn");
const newCallBtn = $("newCallBtn");
const resetCareerBtn = $("resetCareerBtn");

const scoreEl = $("scoreEl");
const repEl = $("repEl");
const rankEl = $("rankEl");
const shiftTimeEl = $("shiftTimeEl");

const callStatus = $("callStatus");
const dispatchStatus = $("dispatchStatus");

const callBadge = $("callBadge");
const callTimerEl = $("callTimerEl");
const callTextEl = $("callText");
const optionsEl = $("options");
const callHint = $("callHint");

const careerLevelEl = $("careerLevelEl");
const careerXpFill = $("careerXpFill");
const careerXpText = $("careerXpText");
const careerCreditsEl = $("careerCreditsEl");
const careerBestEl = $("careerBestEl");
const careerCityBestEl = $("careerCityBestEl");
const careerStatsEl = $("careerStatsEl");
const careerFailEl = $("careerFailEl");

const mapTitle = $("mapTitle");
const mapZone = $("mapZone");
const activeIncidentsPill = $("activeIncidentsPill");
const pinsEl = $("pins");

const incidentListEl = $("incidentList");
const unitListEl = $("unitList");
const dispatchBtn = $("dispatchBtn");
const clearUnitsBtn = $("clearUnitsBtn");

const logEl = $("logEl");

const unitTabs = $("unitTabs");
const onlyAvailableChk = $("onlyAvailableChk");
const unitSearchEl = $("unitSearch");
const selCountEl = $("selCount");

const recommendBox = $("recommendBox");
const recommendList = $("recommendList");
const dispatchHint = $("dispatchHint");

/* ==========================
   Logging
========================== */
function log(msg){
  const t = new Date().toLocaleTimeString();
  logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
}

/* ==========================
   Career Render
========================== */
function renderCareer(){
  careerLevelEl.textContent = career.level;
  careerCreditsEl.textContent = career.credits;
  careerBestEl.textContent = career.bestScore;
  careerCityBestEl.textContent = `SP: ${career.cityBest.sao_paulo||0} ‚Ä¢ NY: ${career.cityBest.new_york||0}`;
  careerStatsEl.textContent = career.totalResolved;
  careerFailEl.textContent = `Falhas: ${career.totalFailed}`;
  const pct = clamp(Math.floor((career.xp / career.xpToNext) * 100), 0, 100);
  careerXpFill.style.width = pct + "%";
  careerXpText.textContent = `XP: ${career.xp}/${career.xpToNext}`;

  $("careerUnlockHint").textContent =
    career.level < 2 ? "N√≠vel 2: EMS + Bombeiros" :
    career.level < 3 ? "N√≠vel 3: Unidades t√°ticas (ROTA/SWAT/Choque)" :
    career.level < 4 ? "N√≠vel 4: Anti-bomba (GATE) / Federal (FBI)" :
    career.level < 5 ? "N√≠vel 5: A√©reo (√Åguia)" :
    "Desbloqueios m√°ximos nesta vers√£o (pr√≥xima fase: upgrades e compra).";
}

/* ==========================
   City Load with Unlocks
========================== */
function loadCity(cityKey){
  state.cityKey = cityKey;
  const city = CITY_CONFIG[cityKey];
  mapTitle.textContent = city.name;
  mapZone.textContent = `Zonas: ${city.zones.join(" ‚Ä¢ ")}`;

  state.units = city.unitTemplates.map(u => ({
    ...u,
    status: "dispon√≠vel",
    busyUntil: 0,
    locked: career.level < u.unlockLevel
  }));

  state.selectedIncidentId = null;
  state.selectedUnitIds = new Set();

  renderUnits();
  renderIncidents();
  renderPins();
  renderRecommend();

  log(`Cen√°rio carregado: ${city.name}. (Carreira n√≠vel ${career.level})`);
}

/* ==========================
   Rendering
========================== */
function renderStats(){
  scoreEl.textContent = state.score;
  repEl.textContent = `${state.rep} /100`;
  rankEl.textContent = computeRank(state.score, state.rep);
  selCountEl.textContent = state.selectedUnitIds.size;
}

function renderShiftTime(){
  if(!state.shiftActive){
    shiftTimeEl.textContent = "--:--";
    return;
  }
  const remain = (state.shiftStart + state.shiftDurationMs) - now();
  shiftTimeEl.textContent = formatMMSS(remain);
  if(remain <= 0){
    endShift("Tempo do turno acabou.");
  }
}

function severityBadge(sev){
  const s = SEVERITY[sev];
  callBadge.textContent = s.badge;
  callBadge.className = "badge " + (s.pill === "danger" ? "badge-danger" : s.pill === "warn" ? "badge-warn" : "badge-ok");
}

function reqHintText(incident){
  const r = incident.required;
  const must = r.mustHaveTags || [];
  const minUnits = r.minUnits || 1;

  let parts = [];
  if(must.includes("extrication") && must.includes("ems")){
    parts.push("Precisa: Resgate/Desencarceramento + Ambul√¢ncia (m√≠n. 2 unidades)");
  }
  if(must.includes("fire")){
    parts.push("Precisa: Bombeiros (Fire)");
  }
  if(must.includes("bomb")){
    parts.push("Precisa: Anti-bomba (GATE/SWAT-bomb)");
  }
  if(must.includes("tactical")){
    parts.push("Precisa: T√°tica (ROTA/SWAT)");
  }
  if(r.minRiskHandle >= 4) parts.push("Risco: Alt√≠ssimo (n√≠vel 4+)");
  else if(r.minRiskHandle >= 3) parts.push("Risco: Alto (n√≠vel 3+)");
  else if(r.minRiskHandle >= 2) parts.push("Risco: M√©dio (n√≠vel 2+)");

  if(parts.length === 0){
    parts.push(`M√≠nimo: ${minUnits} unidade(s) apropriada(s).`);
  }
  return parts.join(" ‚Ä¢ ");
}

function renderIncidents(){
  incidentListEl.innerHTML = "";

  if(state.incidents.length === 0){
    const empty = document.createElement("div");
    empty.className = "subtle";
    empty.textContent = "Nenhum incidente aguardando despacho.";
    incidentListEl.appendChild(empty);
  }else{
    state.incidents
      .slice()
      .sort((a,b)=>a.deadlineAt-b.deadlineAt)
      .forEach(inc=>{
        const card = document.createElement("div");
        card.className = "card" + (state.selectedIncidentId === inc.id ? " sel" : "");
        card.onclick = ()=>{
          state.selectedIncidentId = inc.id;
          // limpa sele√ß√£o anterior (pra evitar despachar errado)
          state.selectedUnitIds = new Set();
          renderIncidents();
          renderUnits();
          renderRecommend();
          updateDispatchButton();
        };

        const left = document.createElement("div");
        left.className = "left";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = inc.title;

        const meta = document.createElement("div");
        meta.className = "meta";

        const sevPill = document.createElement("span");
        sevPill.className = "pill " + (inc.severity==="grave"?"danger":inc.severity==="media"?"warn":inc.severity==="leve"?"ok":"warn");
        sevPill.textContent = inc.severity.toUpperCase();

        const zonePill = document.createElement("span");
        zonePill.className = "pill";
        zonePill.textContent = inc.zone;

        const statusPill = document.createElement("span");
        statusPill.className = "pill";
        statusPill.textContent = inc.status;

        meta.appendChild(sevPill);
        meta.appendChild(zonePill);
        meta.appendChild(statusPill);

        const req = document.createElement("div");
        req.className = "subtle";
        req.textContent = reqHintText(inc);

        const right = document.createElement("div");
        right.className = "right";

        const timeLeft = Math.max(0, inc.deadlineAt - now());
        const timePill = document.createElement("span");
        timePill.className = "pill " + (timeLeft < 12_000 ? "danger" : timeLeft < 22_000 ? "warn" : "");
        timePill.textContent = `‚è± ${formatMMSS(timeLeft)}`;

        right.appendChild(timePill);

        left.appendChild(title);
        left.appendChild(meta);
        left.appendChild(req);

        card.appendChild(left);
        card.appendChild(right);

        incidentListEl.appendChild(card);
      });
  }

  activeIncidentsPill.textContent = `${state.incidents.length} incidentes`;
}

function filteredUnits(){
  const q = (state.unitSearch || "").trim().toLowerCase();
  return state.units.filter(u=>{
    if(state.unitRoleFilter !== "all" && u.role !== state.unitRoleFilter) return false;
    if(state.onlyAvailable && u.status !== "dispon√≠vel") return false;
    if(q){
      const hay = `${u.name} ${u.role} ${u.zone} ${u.tags.join(" ")}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });
}

function renderUnits(){
  unitListEl.innerHTML = "";

  const units = filteredUnits();
  if(units.length === 0){
    const empty = document.createElement("div");
    empty.className = "subtle";
    empty.textContent = "Nenhuma unidade encontrada com os filtros.";
    unitListEl.appendChild(empty);
  }else{
    units.forEach(u=>{
      const selected = state.selectedUnitIds.has(u.id);
      const card = document.createElement("div");
      card.className = "card" + (selected ? " sel" : "") + (u.locked ? " locked" : "");
      card.onclick = ()=>{
        if(u.locked){
          log(`üîí Unidade bloqueada: precisa n√≠vel ${u.unlockLevel}.`);
          return;
        }
        if(u.status !== "dispon√≠vel"){
          log("Unidade indispon√≠vel no momento.");
          return;
        }
        if(selected) state.selectedUnitIds.delete(u.id);
        else state.selectedUnitIds.add(u.id);
        renderUnits();
        renderStats();
        updateDispatchButton();
      };

      const left = document.createElement("div");
      left.className = "left";

      const top = document.createElement("div");
      top.style.display = "flex";
      top.style.gap = "8px";
      top.style.alignItems = "center";

      const check = document.createElement("span");
      check.className = "check" + (selected ? " on" : "");
      check.textContent = selected ? "‚úì" : "";
      top.appendChild(check);

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = u.name + (u.locked ? ` (N√≠vel ${u.unlockLevel})` : "");
      top.appendChild(title);

      const meta = document.createElement("div");
      meta.className = "meta";

      const rolePill = document.createElement("span");
      rolePill.className = "pill";
      rolePill.textContent = u.role.toUpperCase();

      const zonePill = document.createElement("span");
      zonePill.className = "pill";
      zonePill.textContent = u.zone;

      const statusPill = document.createElement("span");
      statusPill.className = "pill " + (u.status==="dispon√≠vel" ? "ok" : "warn");
      statusPill.textContent = u.status;

      meta.appendChild(rolePill);
      meta.appendChild(zonePill);
      meta.appendChild(statusPill);

      const right = document.createElement("div");
      right.className = "right";

      const cost = document.createElement("span");
      cost.className = "pill";
      cost.textContent = `Custo ${u.cost}`;

      const risk = document.createElement("span");
      risk.className = "pill";
      risk.textContent = `Risco ${u.riskHandle}`;

      const mini = document.createElement("div");
      mini.className = "subtle";
      mini.textContent = "Tags: " + u.tags.join(", ");

      const mini2 = document.createElement("div");
      mini2.className = "subtle";
      mini2.textContent = u.locked ? `Bloqueado (n√≠vel ${u.unlockLevel})` : `Velocidade ${u.speed.toFixed(2)} ‚Ä¢ Zona ${u.zone}`;

      const row = document.createElement("div");
      row.className = "minirow";
      row.appendChild(cost);
      row.appendChild(risk);

      right.appendChild(row);
      right.appendChild(mini);
      right.appendChild(mini2);

      left.appendChild(top);
      left.appendChild(meta);

      card.appendChild(left);
      card.appendChild(right);

      unitListEl.appendChild(card);
    });
  }
}

function renderPins(){
  pinsEl.innerHTML = "";
  state.incidents.forEach((inc, idx)=>{
    const p = document.createElement("div");
    p.className = "pin" + (inc.status === "resolvido" ? " ok" : "");
    const x = 12 + (idx*19 % 70);
    const y = 25 + (idx*23 % 55);
    p.style.left = x + "%";
    p.style.top  = y + "%";
    pinsEl.appendChild(p);
  });
}

function updateDispatchButton(){
  const inc = state.incidents.find(i=>i.id===state.selectedIncidentId);
  const hasIncident = !!inc && inc.status === "aguardando";
  const selectedUnits = [...state.selectedUnitIds].map(id=>state.units.find(u=>u.id===id)).filter(Boolean);
  const allAvailable = selectedUnits.length > 0 && selectedUnits.every(u => u.status === "dispon√≠vel" && !u.locked);
  const minUnits = inc ? (inc.required.minUnits || 1) : 1;

  const can = state.shiftActive && hasIncident && allAvailable && selectedUnits.length >= minUnits;
  dispatchBtn.disabled = !can;

  if(inc){
    const need = reqHintText(inc);
    dispatchHint.textContent = `Requisito do incidente: ${need}`;
  }else{
    dispatchHint.textContent = "Selecione um incidente para ver recomenda√ß√µes e requisitos.";
  }
}

function renderAll(){
  renderCareer();
  renderStats();
  renderShiftTime();
  renderIncidents();
  renderUnits();
  renderPins();
  renderRecommend();
  updateDispatchButton();
}

/* ==========================
   Recommender
========================== */
function incidentNeeds(inc){
  const must = new Set(inc.required.mustHaveTags || []);
  const minRisk = inc.required.minRiskHandle || 0;

  const flags = {
    needFire: must.has("fire"),
    needBomb: must.has("bomb"),
    needTactical: must.has("tactical"),
    needExtrication: must.has("extrication"),
    needEms: must.has("ems"),
    minRisk
  };
  return flags;
}

function scoreUnitForIncident(unit, inc){
  // higher is better
  const must = inc.required.mustHaveTags || [];
  const any = inc.required.anyOfTags || [];

  let score = 0;
  let why = [];

  if(unit.locked) return { score:-999, why:"Bloqueado na carreira." };
  if(unit.status !== "dispon√≠vel") return { score:-999, why:"Indispon√≠vel." };

  // tag matches
  const tags = new Set(unit.tags);

  let mustHits = 0;
  must.forEach(t=>{
    if(tags.has(t)) mustHits++;
  });

  let anyHits = 0;
  any.forEach(t=>{
    if(tags.has(t)) anyHits++;
  });

  score += mustHits * 30 + anyHits * 8;

  if(mustHits > 0) why.push(`cobre obrigat√≥rio (${mustHits})`);
  if(anyHits > 0) why.push(`cobre √∫til (${anyHits})`);

  // risk capability
  if(unit.riskHandle >= (inc.required.minRiskHandle||0)){
    score += 15;
    why.push(`risco ok (${unit.riskHandle})`);
  }else{
    score -= 30;
    why.push(`risco baixo (${unit.riskHandle})`);
  }

  // zone advantage
  if(unit.zone === inc.zone){
    score += 10;
    why.push("na mesma zona");
  }

  // speed
  score += Math.floor((unit.speed - 1) * 40); // modest bonus
  if(unit.speed > 1.05) why.push("r√°pida");

  // cost penalty (avoid overkill)
  score -= unit.cost * 6;

  // severity sensitivity: in grave, speed & risk matter more
  if(inc.severity === "grave"){
    score += unit.riskHandle * 5;
    score += Math.floor(unit.speed * 8);
  }

  if(why.length === 0) why.push("op√ß√£o padr√£o");

  return { score, why: why.join(" ‚Ä¢ ") };
}

function renderRecommend(){
  const inc = state.incidents.find(i=>i.id===state.selectedIncidentId);
  if(!inc || inc.status !== "aguardando"){
    recommendBox.style.display = "none";
    recommendList.innerHTML = "";
    return;
  }

  // for multi requirements, we show top police/fire/ems candidates
  // and let player tap to select.
  const candidates = state.units
    .map(u => ({ u, ...scoreUnitForIncident(u, inc) }))
    .filter(x => x.score > -500)
    .sort((a,b)=>b.score-a.score);

  if(candidates.length === 0){
    recommendBox.style.display = "none";
    recommendList.innerHTML = "";
    return;
  }

  recommendBox.style.display = "block";
  recommendList.innerHTML = "";

  // show top 4
  candidates.slice(0,4).forEach(item=>{
    const line = document.createElement("div");
    line.className = "recline";

    const left = document.createElement("div");
    left.className = "recl";
    const nm = document.createElement("div");
    nm.className = "nm";
    nm.textContent = item.u.name;

    const why = document.createElement("div");
    why.className = "why";
    why.textContent = item.why;

    left.appendChild(nm);
    left.appendChild(why);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.alignItems = "center";

    const pill = document.createElement("span");
    pill.className = "pill";
    pill.textContent = `Score ${item.score}`;

    const btn = document.createElement("button");
    btn.className = "tinybtn btn-ok";
    btn.textContent = "Selecionar";
    btn.onclick = (e)=>{
      e.stopPropagation();
      if(item.u.locked || item.u.status !== "dispon√≠vel") return;
      // toggle select
      if(state.selectedUnitIds.has(item.u.id)) state.selectedUnitIds.delete(item.u.id);
      else state.selectedUnitIds.add(item.u.id);

      renderUnits();
      renderStats();
      updateDispatchButton();
    };

    right.appendChild(pill);
    right.appendChild(btn);

    line.appendChild(left);
    line.appendChild(right);

    recommendList.appendChild(line);
  });
}

/* ==========================
   Shift Control
========================== */
function startShift(){
  if(state.shiftActive) return;
  state.shiftActive = true;
  state.shiftStart = now();

  state.score = 0;
  state.rep = 50;
  state.resolved = 0;
  state.failed = 0;
  state.incidents = [];
  state.selectedIncidentId = null;
  state.selectedUnitIds = new Set();

  // reset unit statuses (keep lock rules)
  state.units.forEach(u=>{
    u.status = "dispon√≠vel";
    u.busyUntil = 0;
    u.locked = career.level < u.unlockLevel;
  });

  callStatus.textContent = "Turno ativo ‚Äî pronto para atender";
  dispatchStatus.textContent = "Despacho operacional";
  startShiftBtn.disabled = true;
  endShiftBtn.disabled = false;
  newCallBtn.disabled = false;

  log("Turno iniciado. Central operacional.");
  ringOnce();
  typeText(callTextEl, "Turno iniciado.\n\nClique em ‚ÄúNova Chamada‚Äù para atender.\nDepois selecione o incidente e envie 1 ou MAIS unidades.", 14);

  callBadge.textContent = "AGUARDANDO";
  callBadge.className = "badge";
  callTimerEl.textContent = "Tempo de chamada: --";
  optionsEl.innerHTML = "";
  callHint.textContent = "Dica AAA: a liga√ß√£o abre o ticket e voc√™ despacha pela fila. Casos complexos pedem 2+ unidades.";

  renderAll();
}

function endShift(reason="Turno encerrado."){
  if(!state.shiftActive) return;
  state.shiftActive = false;

  startShiftBtn.disabled = false;
  endShiftBtn.disabled = true;
  newCallBtn.disabled = true;
  dispatchBtn.disabled = true;

  state.callActive = false;
  state.currentCall = null;
  optionsEl.innerHTML = "";

  callStatus.textContent = "Turno n√£o iniciado";
  dispatchStatus.textContent = "Aguardando turno";

  const rewards = awardShiftRewards();

  const summary =
`TURNO ENCERRADO
Motivo: ${reason}

Resultados do turno:
- Pontua√ß√£o: ${state.score}
- Reputa√ß√£o: ${state.rep}/100
- Resolvidos: ${state.resolved}
- Falhas: ${state.failed}
- Patente: ${computeRank(state.score, state.rep)}

Recompensas da carreira:
- +${rewards.xp} XP
- +${rewards.credits} Cr√©ditos

Dica:
Suba de n√≠vel para liberar unidades avan√ßadas (T√°tica, Anti-bomba, A√©reo).
`;

  typeText(callTextEl, summary, 12);
  callBadge.textContent = "ENCERRADO";
  callBadge.className = "badge badge-warn";
  callTimerEl.textContent = "Tempo de chamada: --";
  log(reason);

  renderAll();
}

/* ==========================
   Calls -> Incidents
========================== */
function createIncidentFromCall(call){
  const city = CITY_CONFIG[state.cityKey];
  const incSpec = call.incident(city);

  const sevCfg = SEVERITY[call.severity];
  const id = `INC-${incidentCounter++}`;

  const incident = {
    id,
    title: call.title,
    severity: call.severity,
    zone: incSpec.zone,
    required: incSpec.required,
    status: "aguardando",
    createdAt: now(),
    deadlineAt: now() + sevCfg.deadlineMs,
    baseUrgency: incSpec.baseUrgency,
    dispatchedUnitIds: []
  };

  state.incidents.push(incident);
  log(`Incidente criado (${id}): ${incident.title} [${incident.severity}] ‚Äî Zona ${incident.zone}.`);
  renderAll();
}

function startCall(){
  if(!state.shiftActive) return;
  if(state.callActive){
    log("Voc√™ j√° est√° em chamada.");
    return;
  }

  state.callActive = true;
  state.callStart = now();
  state.callQuality = 0;
  state.currentCall = pick(CALL_POOL);

  const city = CITY_CONFIG[state.cityKey];
  ringOnce();

  severityBadge(state.currentCall.severity);

  callStatus.textContent = "Chamada em andamento";
  callTimerEl.textContent = "Tempo de chamada: 00:00";
  optionsEl.innerHTML = "";

  // create ticket immediately
  createIncidentFromCall(state.currentCall);

  const intro = `${state.currentCall.intro(city)}\n\nChamador: ${state.currentCall.first}`;
  typeText(callTextEl, intro, 14, ()=> showCallStep(0));

  callHint.textContent = "A qualidade do atendimento melhora o resultado do incidente. Voc√™ pode despachar enquanto atende.";

  if(state.callTimerHandle) clearInterval(state.callTimerHandle);
  state.callTimerHandle = setInterval(()=>{
    if(!state.callActive){
      clearInterval(state.callTimerHandle);
      state.callTimerHandle = null;
      callTimerEl.textContent = "Tempo de chamada: --";
      return;
    }
    const elapsed = now() - state.callStart;
    callTimerEl.textContent = `Tempo de chamada: ${formatMMSS(elapsed)}`;
    if(elapsed > 80_000){
      state.rep = clamp(state.rep - 1, 0, 100);
      renderStats();
    }
  }, 250);

  renderAll();
}

function showCallStep(stepIndex){
  const call = state.currentCall;
  const step = call.steps[stepIndex];

  optionsEl.innerHTML = "";
  typeText(callTextEl, step.text, 14);

  step.options.forEach(opt=>{
    const b = document.createElement("button");
    b.className = "optbtn";
    b.textContent = opt.label;
    b.onclick = ()=>{
      if(opt.effect && typeof opt.effect.quality === "number"){
        state.callQuality += opt.effect.quality;
      }
      if(typeof opt.next === "number"){
        showCallStep(opt.next);
      }else{
        finishCall(opt.end || "Chamada encerrada.");
      }
    };
    optionsEl.appendChild(b);
  });
}

function finishCall(endText){
  state.callActive = false;
  optionsEl.innerHTML = "";
  state.callQuality = clamp(state.callQuality, -6, 10);

  if(state.callQuality >= 4) state.rep = clamp(state.rep + 1, 0, 100);
  if(state.callQuality <= -2) state.rep = clamp(state.rep - 2, 0, 100);

  callStatus.textContent = "Chamada finalizada ‚Äî despache corretamente";
  typeText(callTextEl, `${endText}\n\nQualidade do atendimento: ${state.callQuality}\n(Dica: selecione o incidente e use a recomenda√ß√£o.)`, 12);

  renderAll();
}

/* ==========================
   Multi-Dispatch Logic
========================== */
function dispatchSelected(){
  const inc = state.incidents.find(i=>i.id===state.selectedIncidentId);
  if(!inc || inc.status !== "aguardando") return;

  // check deadline
  if(now() > inc.deadlineAt){
    failIncident(inc, "Despacho tardio: estourou o prazo.");
    renderAll();
    return;
  }

  const selectedUnits = [...state.selectedUnitIds]
    .map(id=>state.units.find(u=>u.id===id))
    .filter(Boolean);

  const minUnits = inc.required.minUnits || 1;
  if(selectedUnits.length < minUnits){
    log(`Precisa selecionar no m√≠nimo ${minUnits} unidade(s) para este incidente.`);
    return;
  }

  // validate availability and lock
  if(selectedUnits.some(u => u.locked)){
    log("H√° unidade bloqueada na sele√ß√£o. Suba n√≠vel para liberar.");
    return;
  }
  if(selectedUnits.some(u => u.status !== "dispon√≠vel")){
    log("H√° unidade indispon√≠vel na sele√ß√£o.");
    return;
  }

  // mark incident in progress
  inc.status = "em andamento";
  inc.dispatchedUnitIds = selectedUnits.map(u=>u.id);

  // compute combined capability
  const combined = evaluateCombinedCapability(selectedUnits, inc);

  // compute travel time: use fastest selected unit adjusted by zone match
  const baseTravel = (inc.severity==="grave" ? 18_000 : inc.severity==="media" ? 22_000 : inc.severity==="leve" ? 26_000 : 20_000);
  const bestSpeed = Math.max(...selectedUnits.map(u=>u.speed));
  const bestZoneMatch = selectedUnits.some(u=>u.zone === inc.zone) ? 0.85 : 1.12;
  const travel = Math.floor(baseTravel * bestZoneMatch * (1 / bestSpeed));

  // resolve time: depends on severity and capability (better = faster)
  const resolveBase = (inc.severity==="grave" ? 26_000 : inc.severity==="media" ? 20_000 : 16_000);
  const capabilityBoost = clamp(combined.capabilityScore / 40, 0, 0.35); // up to 35% faster
  const resolve = Math.floor(resolveBase * (1 - capabilityBoost));

  // set units busy
  selectedUnits.forEach(u=>{
    u.status = "em atendimento";
    u.busyUntil = now() + travel + resolve;
  });

  // log
  const names = selectedUnits.map(u=>u.name).join(" + ");
  log(`Despacho MULTI: ${names} ‚Üí ${inc.title} (${inc.id}) | ETA ~${formatMMSS(travel)} | Unidades: ${selectedUnits.length}.`);

  // Clear selection for next
  state.selectedUnitIds = new Set();
  renderUnits();
  renderStats();
  updateDispatchButton();

  // outcome later
  setTimeout(()=>{
    if(!state.shiftActive) return;

    // after dispatch, free units
    selectedUnits.forEach(u=>{
      u.status = "dispon√≠vel";
      u.busyUntil = 0;
    });

    const outcome = decideOutcome(combined, inc);
    if(outcome.success){
      resolveIncident(inc, selectedUnits, outcome);
    }else{
      failIncident(inc, outcome.reason);
    }

    renderAll();
  }, travel + resolve);

  renderAll();
}

function evaluateCombinedCapability(units, inc){
  const must = inc.required.mustHaveTags || [];
  const any = inc.required.anyOfTags || [];
  const minRisk = inc.required.minRiskHandle || 0;

  const unionTags = new Set();
  let maxRisk = 0;
  let totalCost = 0;
  let zoneMatch = 0;

  units.forEach(u=>{
    u.tags.forEach(t=>unionTags.add(t));
    maxRisk = Math.max(maxRisk, u.riskHandle);
    totalCost += u.cost;
    if(u.zone === inc.zone) zoneMatch += 1;
  });

  // must tags coverage:
  // special rule: extrication + ems must be covered by possibly different units
  let mustCovered = 0;
  must.forEach(t=>{
    if(unionTags.has(t)) mustCovered += 1;
  });

  // any coverage
  let anyCovered = 0;
  any.forEach(t=>{
    if(unionTags.has(t)) anyCovered += 1;
  });

  // call quality helps
  const infoBonus = clamp(state.callQuality || 0, -6, 10);

  // capability score
  let capabilityScore = 0;
  capabilityScore += mustCovered * 40;
  capabilityScore += anyCovered * 10;
  capabilityScore += (maxRisk >= minRisk ? 20 : -40);
  capabilityScore += zoneMatch > 0 ? 8 : 0;
  capabilityScore += infoBonus * 5;
  capabilityScore -= totalCost * 6; // cost matters, prevents always using elite

  // hard requirements check
  let hardFail = false;
  if(maxRisk < minRisk) hardFail = true;

  // if must includes extrication or ems, ensure present
  if(must.includes("extrication") && !unionTags.has("extrication") && !unionTags.has("rescue")) hardFail = true;
  if(must.includes("ems") && !unionTags.has("ems") && !unionTags.has("medical")) hardFail = true;
  if(must.includes("fire") && !unionTags.has("fire")) hardFail = true;
  if(must.includes("bomb") && !unionTags.has("bomb")) hardFail = true;
  if(must.includes("tactical") && !unionTags.has("tactical")) hardFail = true;

  return {
    unionTags,
    maxRisk,
    totalCost,
    mustCovered,
    anyCovered,
    infoBonus,
    capabilityScore,
    hardFail
  };
}

function decideOutcome(combined, inc){
  if(combined.hardFail){
    return { success:false, reason:"Despacho n√£o atendeu requisitos m√≠nimos (tags/risco). Consequ√™ncias graves." };
  }

  // thresholds by severity
  const threshold =
    inc.severity === "grave" ? 40 :
    inc.severity === "media" ? 18 :
    inc.severity === "leve" ? 6 :
    10;

  const success = combined.capabilityScore >= threshold;

  if(success){
    return { success:true, quality: combined.capabilityScore };
  }

  // not hard fail but below threshold
  return { success:false, reason:`Despacho insuficiente (qualidade ${combined.capabilityScore} < ${threshold}).` };
}

function resolveIncident(inc, units, outcome){
  inc.status = "resolvido";
  state.resolved += 1;

  const sevCfg = SEVERITY[inc.severity];
  const base = sevCfg.baseScore;

  // bonus from quality
  const bonus = clamp(Math.floor((outcome.quality || 0) / 4), 0, 22);
  const gain = base + bonus;

  state.score += gain;
  state.rep = clamp(state.rep + sevCfg.repDeltaOk, 0, 100);

  log(`‚úÖ RESOLVIDO: ${inc.title} (${inc.id}) | +${gain} pontos | Unidades: ${units.length}.`);
}

function failIncident(inc, reason){
  inc.status = "falhou";
  state.failed += 1;

  const loss = inc.severity==="grave" ? 18 : inc.severity==="media" ? 12 : 8;
  state.score = Math.max(0, state.score - loss);
  state.rep = clamp(state.rep + SEVERITY[inc.severity].repDeltaBad, 0, 100);

  let extra = "";
  if(inc.severity==="grave") extra = " Resultado: poss√≠vel √≥bito / dano cr√≠tico.";
  if(inc.severity==="trote") extra = " Resultado: recurso desperdi√ßado por trote.";

  log(`‚ùå FALHA: ${inc.title} (${inc.id}) | -${loss} pontos. ${reason}${extra}`);
}

/* ==========================
   Background Tick
========================== */
function tick(){
  renderShiftTime();

  if(state.shiftActive){
    // deadlines
    state.incidents.forEach(inc=>{
      if(inc.status === "aguardando" && now() > inc.deadlineAt){
        inc.status = "falhou";
        state.failed += 1;

        const loss = inc.severity==="grave" ? 18 : inc.severity==="media" ? 12 : 8;
        state.score = Math.max(0, state.score - loss);
        state.rep = clamp(state.rep + SEVERITY[inc.severity].repDeltaBad, 0, 100);

        log(`‚è± PRAZO ESTOURADO: ${inc.title} (${inc.id}) | -${loss} pontos. Atraso cr√≠tico.`);
      }
    });

    // cleanup
    const keepMs = 55_000;
    state.incidents = state.incidents.filter(inc=>{
      if(inc.status === "aguardando" || inc.status === "em andamento") return true;
      return (now() - inc.createdAt) < keepMs;
    });

    // unit busy reset safeguard
    state.units.forEach(u=>{
      if(u.status === "em atendimento"){
        const rem = u.busyUntil - now();
        if(rem <= 0){
          u.status = "dispon√≠vel";
          u.busyUntil = 0;
        }
      }
      // update lock if leveled up
      u.locked = career.level < u.unlockLevel;
    });

    renderStats();
    renderIncidents();
    renderUnits();
    renderPins();
    renderRecommend();
    updateDispatchButton();
  }

  requestAnimationFrame(tick);
}

/* ==========================
   Event Handlers
========================== */
citySelect.addEventListener("change", ()=>{
  loadCity(citySelect.value);
});

startShiftBtn.addEventListener("click", startShift);
endShiftBtn.addEventListener("click", ()=>endShift("Encerrado manualmente."));
newCallBtn.addEventListener("click", startCall);
dispatchBtn.addEventListener("click", dispatchSelected);
clearUnitsBtn.addEventListener("click", ()=>{
  state.selectedUnitIds = new Set();
  renderUnits();
  renderStats();
  updateDispatchButton();
  log("Sele√ß√£o de unidades limpa.");
});

resetCareerBtn.addEventListener("click", ()=>{
  resetCareer();
});

unitTabs.addEventListener("click", (e)=>{
  const t = e.target.closest(".tab");
  if(!t) return;
  const role = t.dataset.role;
  state.unitRoleFilter = role;

  [...unitTabs.querySelectorAll(".tab")].forEach(x=>x.classList.remove("on"));
  t.classList.add("on");

  renderUnits();
});

onlyAvailableChk.addEventListener("change", ()=>{
  state.onlyAvailable = !!onlyAvailableChk.checked;
  renderUnits();
});

unitSearchEl.addEventListener("input", ()=>{
  state.unitSearch = unitSearchEl.value || "";
  renderUnits();
});

/* ==========================
   Init
========================== */
(function init(){
  renderCareer();
  log("Sistema carregado. Carreira persistente ativa (salva no aparelho).");
  loadCity(citySelect.value);
  renderAll();
  requestAnimationFrame(tick);

  typeText(callTextEl,
`Bem-vindo ao Last Call Dispatch Operator (FASE 3).

‚úÖ Novidades:
- MULTI-DESPACHO (envie 2+ unidades)
- Recomenda√ß√µes autom√°ticas por incidente
- Filtros de unidades (Pol√≠cia/Bombeiros/EMS)
- Carreira persistente (N√≠vel + XP + Cr√©ditos)
- Unidades avan√ßadas DESBLOQUEADAS por n√≠vel

Como jogar:
1) Inicie o turno
2) Clique em ‚ÄúNova Chamada‚Äù
3) Atenda e finalize
4) Selecione o incidente
5) Selecione 1 ou MAIS unidades (toque para marcar)
6) Clique ‚ÄúDespachar Selecionadas‚Äù

Dica:
Acidente com preso = Resgate + Ambul√¢ncia
Amea√ßa armada = T√°tica (ROTA/SWAT)
Bomba = Anti-bomba (GATE) / alto risco
Inc√™ndio = Bombeiros (Fire)
`, 12);
})();
</script>
</body>
</html>