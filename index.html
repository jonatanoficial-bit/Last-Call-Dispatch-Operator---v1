<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Last Call Dispatch Operator — Prototype AAA (Fase 1)</title>

  <!-- Leaflet (CDN) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1020;
      --bg2:#0E1730;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.18);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.48);
      --ok: #22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --accent:#60a5fa;
      --accent2:#a78bfa;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--txt);
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(96,165,250,.15), transparent 55%),
        radial-gradient(900px 700px at 85% 35%, rgba(167,139,250,.14), transparent 60%),
        radial-gradient(900px 700px at 60% 90%, rgba(239,68,68,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 55%, var(--bg0));
      min-height:100vh;
    }

    .topbar{
      position: sticky;
      top:0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(10,14,28,.92), rgba(10,14,28,.65));
      border-bottom: 1px solid var(--stroke);
    }
    .topbar-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 14px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }
    .logo{
      width: 34px; height:34px;
      border-radius: 10px;
      background:
        radial-gradient(circle at 30% 30%, rgba(96,165,250,.85), rgba(167,139,250,.45)),
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.04));
      border: 1px solid var(--stroke2);
      box-shadow: var(--shadow);
    }
    .brand h1{
      font-size: 14px;
      margin:0;
      line-height: 1.1;
      letter-spacing: .3px;
    }
    .brand .sub{
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .topstats{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--stroke);
      font-size: 12px;
      color: var(--muted);
    }
    .pill strong{ color: var(--txt); font-weight: 700; }
    .dot{ width: 8px; height: 8px; border-radius: 999px; background: var(--muted2); }
    .dot.ok{ background: var(--ok); }
    .dot.warn{ background: var(--warn); }
    .dot.bad{ background: var(--bad); }

    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 14px;
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px 12px 10px 12px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), transparent);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd h2{
      margin:0;
      font-size: 12px;
      letter-spacing: .35px;
      text-transform: uppercase;
      color: rgba(255,255,255,.78);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tag{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.75);
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      white-space: nowrap;
    }

    .body{
      padding: 12px;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .field label{
      display:block;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    select, button, input{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      color: var(--txt);
      padding: 10px 10px;
      font-size: 14px;
      outline: none;
    }
    select:focus, button:focus, input:focus{
      border-color: rgba(96,165,250,.45);
      box-shadow: 0 0 0 3px rgba(96,165,250,.14);
    }
    .btnrow{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .btn{
      cursor:pointer;
      border: 1px solid var(--stroke2);
      background:
        radial-gradient(120% 120% at 30% 20%, rgba(96,165,250,.18), rgba(167,139,250,.08)),
        rgba(255,255,255,.05);
      transition: transform .08s ease, filter .15s ease, opacity .15s ease;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,.05);
      border-color: var(--stroke);
      font-weight: 600;
      color: rgba(255,255,255,.86);
    }
    .btn.danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.35);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
    }

    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .callbox{
      background: rgba(0,0,0,.24);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .calltop{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 10px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
    }
    .calltop .left{
      display:flex;
      gap:10px;
      align-items:center;
      min-width: 0;
    }
    .avatar{
      width: 36px; height:36px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), rgba(255,255,255,.06)),
        linear-gradient(180deg, rgba(96,165,250,.25), rgba(167,139,250,.12));
      border: 1px solid var(--stroke2);
    }
    .callmeta{
      min-width: 0;
    }
    .callmeta .title{
      font-size: 13px;
      margin:0;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .callmeta .small{
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      font-family: var(--mono);
    }
    .timer{
      display:flex;
      align-items:center;
      gap:8px;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.85);
      white-space: nowrap;
    }
    .bar{
      width: 86px;
      height: 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width: 50%;
      background: linear-gradient(90deg, rgba(34,197,94,.9), rgba(245,158,11,.9), rgba(239,68,68,.9));
      border-radius: 999px;
    }

    .transcript{
      padding: 10px;
      min-height: 150px;
      max-height: 220px;
      overflow:auto;
      font-size: 13px;
      line-height: 1.4;
    }
    .line{
      margin: 0 0 10px 0;
      color: rgba(255,255,255,.88);
    }
    .line .who{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.65);
      margin-bottom: 4px;
      display:block;
    }

    .choices{
      display:grid;
      gap: 8px;
      padding: 10px;
      border-top: 1px solid var(--stroke);
      background: rgba(255,255,255,.03);
    }
    .choice{
      text-align:left;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--stroke);
      padding: 10px 10px;
      border-radius: 14px;
      cursor:pointer;
      transition: filter .15s ease, transform .08s ease;
      color: rgba(255,255,255,.9);
      font-weight: 650;
    }
    .choice:hover{ filter: brightness(1.06); }
    .choice:active{ transform: translateY(1px); }

    .feed{
      display:grid;
      gap: 10px;
    }
    .list{
      display:grid;
      gap: 8px;
    }
    .item{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      cursor:pointer;
    }
    .item:hover{ border-color: rgba(255,255,255,.18); }
    .item .a{
      min-width:0;
    }
    .item .t{
      margin:0;
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .item .s{
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
      font-family: var(--mono);
    }
    .sev{
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      color: rgba(255,255,255,.82);
      white-space: nowrap;
    }
    .sev.low{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .sev.med{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .sev.high{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

    .mapcard{
      height: calc(100vh - 100px);
      min-height: 620px;
      display:flex;
      flex-direction:column;
    }
    #map{
      flex:1;
      min-height: 460px;
    }

    .bottomDock{
      padding: 10px;
      border-top: 1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .dockCol{
      background: rgba(0,0,0,.22);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 10px;
    }
    .dockCol h3{
      margin:0 0 8px 0;
      font-size: 11px;
      letter-spacing: .35px;
      text-transform: uppercase;
      color: rgba(255,255,255,.75);
    }
    .muted{ color: var(--muted); font-size: 12px; line-height: 1.35; }
    .row{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .chip{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.85);
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      white-space: nowrap;
    }
    .chip.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .chip.busy{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .chip.off{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 999px;
      padding: 10px 14px;
      color: rgba(255,255,255,.92);
      font-size: 13px;
      box-shadow: var(--shadow);
      max-width: min(620px, 92vw);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    /* Responsive */
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .mapcard{ height: auto; min-height: 520px; }
      #map{ min-height: 420px; }
    }
    @media (max-width: 520px){
      .controls{ grid-template-columns: 1fr; }
      .bottomDock{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
      .topstats{ justify-content:flex-start; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Last Call Dispatch Operator</h1>
          <div class="sub">Fase 1 — Prototipagem sólida (turno + chamada + despacho)</div>
        </div>
      </div>

      <div class="topstats">
        <div class="pill"><span class="dot" id="dotShift"></span> Turno: <strong id="shiftState">OFF</strong></div>
        <div class="pill">Tempo: <strong id="shiftClock">00:00</strong></div>
        <div class="pill">Pontuação: <strong id="score">0</strong></div>
        <div class="pill">Nível: <strong id="lvl">1</strong> <span style="opacity:.6">•</span> XP: <strong id="xp">0</strong></div>
        <div class="pill">Créditos: <strong id="money">0</strong></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <h2>Central</h2>
          <span class="tag" id="regionTag">BR • SP</span>
        </div>

        <div class="body">
          <div class="controls">
            <div class="field">
              <label>Cidade</label>
              <select id="city">
                <option value="saopaulo">São Paulo (BR)</option>
                <option value="nyc">New York (EUA)</option>
              </select>
            </div>
            <div class="field">
              <label>Agência</label>
              <select id="agency">
                <option value="police">Polícia</option>
                <option value="fire">Bombeiros/Resgate</option>
                <option value="mixed">Central Integrada (911/112/CIOSP)</option>
              </select>
            </div>
          </div>

          <div class="btnrow">
            <button class="btn" id="btnStart">Iniciar turno</button>
            <button class="btn secondary" id="btnNextCall" disabled>Forçar nova chamada</button>
          </div>
          <div class="btnrow">
            <button class="btn secondary" id="btnClearSave">Resetar carreira (local)</button>
            <button class="btn danger" id="btnEnd" disabled>Encerrar turno</button>
          </div>

          <div style="height:12px"></div>

          <div class="split">
            <!-- CALL -->
            <div class="callbox">
              <div class="calltop">
                <div class="left">
                  <div class="avatar"></div>
                  <div class="callmeta">
                    <p class="title" id="callTitle">Sem chamada ativa</p>
                    <div class="small" id="callSmall">Aguardando…</div>
                  </div>
                </div>
                <div class="timer">
                  <span id="callTimerTxt">--:--</span>
                  <div class="bar"><i id="callTimerBar" style="width:0%"></i></div>
                </div>
              </div>

              <div class="transcript" id="transcript">
                <p class="line" style="color:rgba(255,255,255,.65);margin:0">
                  Inicie um turno para começar a receber chamadas.
                </p>
              </div>

              <div class="choices" id="choices">
                <!-- buttons -->
              </div>
            </div>

            <!-- QUEUE + INCIDENTS -->
            <div class="feed">
              <div>
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;">
                  <div style="font-size:12px; color:rgba(255,255,255,.78); text-transform:uppercase; letter-spacing:.35px;">Fila de Chamadas</div>
                  <span class="tag" id="queueTag">0</span>
                </div>
                <div class="list" id="queueList"></div>
              </div>

              <div>
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin: 8px 0;">
                  <div style="font-size:12px; color:rgba(255,255,255,.78); text-transform:uppercase; letter-spacing:.35px;">Ocorrências Ativas</div>
                  <span class="tag" id="incTag">0</span>
                </div>
                <div class="list" id="incList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card mapcard">
        <div class="hd">
          <h2>Mapa e Despacho</h2>
          <span class="tag" id="dispatchHint">Selecione uma ocorrência</span>
        </div>

        <div id="map"></div>

        <div class="bottomDock">
          <div class="dockCol">
            <h3>Unidades</h3>
            <div class="muted" id="unitHelp">Toque numa ocorrência (lista ou mapa), depois escolha a unidade.</div>
            <div style="height:8px"></div>
            <div class="row" id="unitChips"></div>
          </div>

          <div class="dockCol">
            <h3>Despacho</h3>
            <div class="muted" id="dispatchPanel">
              Nenhuma ocorrência selecionada.
            </div>
            <div style="height:10px"></div>
            <div class="btnrow" style="margin:0">
              <button class="btn" id="btnDispatch" disabled>Despachar unidade</button>
              <button class="btn secondary" id="btnUnselect" disabled>Limpar seleção</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     *  Utilities
     ************************/
    const $ = (id)=>document.getElementById(id);

    function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
    function rnd(a,b){ return a + Math.random()*(b-a); }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function fmtMMSS(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = String(Math.floor(sec/60)).padStart(2,'0');
      const s = String(sec%60).padStart(2,'0');
      return `${m}:${s}`;
    }

    function toast(msg){
      const t = $('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>t.classList.remove('show'), 2200);
    }

    /***********************
     *  Career (localStorage)
     ************************/
    const SAVE_KEY = 'lcdo_save_v1';
    function loadCareer(){
      try{
        const raw = localStorage.getItem(SAVE_KEY);
        if(!raw) return { lvl:1, xp:0, money:0, bestScore:0 };
        const d = JSON.parse(raw);
        return { lvl: d.lvl||1, xp:d.xp||0, money:d.money||0, bestScore:d.bestScore||0 };
      }catch(e){
        return { lvl:1, xp:0, money:0, bestScore:0 };
      }
    }
    function saveCareer(){
      localStorage.setItem(SAVE_KEY, JSON.stringify(CAREER));
    }
    function xpNeededForNext(lvl){
      return 120 + (lvl-1)*60;
    }
    function addXP(amount){
      CAREER.xp += amount;
      while(CAREER.xp >= xpNeededForNext(CAREER.lvl)){
        CAREER.xp -= xpNeededForNext(CAREER.lvl);
        CAREER.lvl++;
        toast(`Promoção! Você alcançou o nível ${CAREER.lvl}.`);
      }
      saveCareer();
      renderHUD();
    }
    function addMoney(amount){
      CAREER.money = Math.max(0, CAREER.money + amount);
      saveCareer();
      renderHUD();
    }

    let CAREER = loadCareer();

    /***********************
     *  Cities & Units
     ************************/
    const CITIES = {
      saopaulo: {
        label: "São Paulo",
        regionTag: "BR • SP",
        center: [-23.55052, -46.633308],
        bounds: { // rough gameplay bounds
          latMin: -23.72, latMax: -23.40,
          lngMin: -46.82, lngMax: -46.45
        },
        units: [
          { id:'sp_p1', name:'Patrulha (Área)', type:'police', tags:['police','patrol'], speed: 1.0 },
          { id:'sp_rota', name:'ROTA (Tático)', type:'police', tags:['police','tactical','swat'], speed: 1.05 },
          { id:'sp_gate', name:'GATE (Anti-bomba)', type:'police', tags:['police','bomb','tactical'], speed: 0.95 },
          { id:'sp_aguia', name:'Águia (Helicóptero)', type:'police', tags:['police','air','tactical'], speed: 1.35 },
          { id:'sp_choque', name:'Choque (Controle)', type:'police', tags:['police','riot','tactical'], speed: 0.95 },

          { id:'sp_resgate', name:'Resgate (Bombeiros)', type:'fire', tags:['fire','rescue'], speed: 1.0 },
          { id:'sp_ab', name:'Auto Bomba (Incêndio)', type:'fire', tags:['fire','firetruck'], speed: 0.95 },
          { id:'sp_amb', name:'Ambulância', type:'medic', tags:['medic','ems'], speed: 1.05 },
        ]
      },
      nyc: {
        label: "New York City",
        regionTag: "USA • NYC",
        center: [40.7128, -74.0060],
        bounds: {
          latMin: 40.55, latMax: 40.92,
          lngMin: -74.25, lngMax: -73.70
        },
        units: [
          { id:'ny_patrol', name:'Patrol (Area)', type:'police', tags:['police','patrol'], speed: 1.0 },
          { id:'ny_swat', name:'SWAT', type:'police', tags:['police','swat','tactical'], speed: 1.05 },
          { id:'ny_fbi', name:'Federal Task (FBI)', type:'police', tags:['police','investigation','tactical'], speed: 1.0 },
          { id:'ny_bomb', name:'Bomb Squad', type:'police', tags:['police','bomb','tactical'], speed: 0.95 },

          { id:'ny_ems', name:'EMS Ambulance', type:'medic', tags:['medic','ems'], speed: 1.05 },
          { id:'ny_engine', name:'Fire Engine', type:'fire', tags:['fire','firetruck'], speed: 0.95 },
          { id:'ny_rescue', name:'Rescue Unit', type:'fire', tags:['fire','rescue'], speed: 1.0 },
        ]
      }
    };

    // incident needs tags to resolve
    const INCIDENT_CATALOG = {
      prank: [
        { key:'trote_crianca', title:'Possível trote', sev:'low', needs:['triage'], script:"(risos) Oi moço… tem um leão no meu quarto…", tips:"Sinais de trote: inconsistência, risos, história absurda." },
        { key:'ligacao_muda', title:'Ligação muda', sev:'low', needs:['triage'], script:"…(silêncio)… respiração… depois desliga.", tips:"Tente confirmar local e tipo. Se sem resposta, encerre e registre." },
      ],
      police_low: [
        { key:'perturbacao', title:'Perturbação do sossego', sev:'low', needs:['police','patrol'], script:"Tem som alto no vizinho, tá impossível dormir.", tips:"Coletar endereço e orientar a evitar confronto direto." },
        { key:'suspeito', title:'Pessoa suspeita rondando', sev:'low', needs:['police','patrol'], script:"Tem um cara olhando as casas e mexendo nos portões.", tips:"Pedir descrição, direção, roupa, se há arma visível." },
      ],
      police_med: [
        { key:'roubo', title:'Roubo em andamento', sev:'med', needs:['police','patrol'], script:"Estão tentando arrombar a porta aqui!", tips:"Orientar a se esconder, manter silêncio, não confrontar." },
        { key:'viol_dom', title:'Violência doméstica', sev:'med', needs:['police','patrol'], script:"Meu marido tá agressivo, tenho medo…", tips:"Perguntar se há armas, crianças, local seguro." },
      ],
      police_high: [
        { key:'tiros', title:'Disparos / situação armada', sev:'high', needs:['police','tactical'], script:"Tem tiro! Eu ouvi vários tiros agora!", tips:"Orientar abrigo imediato. Despacho tático/elite." },
        { key:'bomba', title:'Suspeita de artefato explosivo', sev:'high', needs:['police','bomb'], script:"Tem uma mochila abandonada e tá fazendo barulho estranho.", tips:"Isolar área, não tocar, chamar anti-bomba." },
      ],
      fire_low: [
        { key:'fumaça', title:'Fumaça em apartamento', sev:'low', needs:['fire','firetruck'], script:"Tá saindo fumaça da cozinha, acho que queimou panela.", tips:"Orientar desligar gás/energia se seguro, ventilar, observar chamas." },
        { key:'elevador', title:'Pessoa presa no elevador', sev:'low', needs:['fire','rescue'], script:"Travou o elevador com gente dentro!", tips:"Manter calma, evitar forçar portas, aguardar resgate." },
      ],
      fire_med: [
        { key:'acidente_ferragens', title:'Acidente com vítimas presas', sev:'med', needs:['fire','rescue','medic'], script:"Bateu forte e tem gente presa no carro!", tips:"Orientar não mexer no pescoço, desligar motor se possível, acionar resgate + ambulância." },
        { key:'incendio', title:'Incêndio residencial', sev:'med', needs:['fire','firetruck'], script:"Pegou fogo no quarto, tá espalhando!", tips:"Evacuar, fechar portas, não usar elevador, ponto de encontro." },
      ],
      fire_high: [
        { key:'parada', title:'Parada cardíaca', sev:'high', needs:['medic','ems'], script:"Ele caiu no chão e não responde! Não tá respirando!", tips:"Orientar RCP: compressões firmes e rápidas. Mandar ambulância urgente." },
        { key:'parto', title:'Parto de emergência', sev:'high', needs:['medic','ems'], script:"A bebê tá vindo! Não dá tempo!", tips:"Orientar higiene, posição, suporte emocional, ambulância urgente." },
      ]
    };

    function buildScenarioPool(agency){
      // agency: police / fire / mixed
      const pool = [];
      pool.push(...INCIDENT_CATALOG.prank);

      if(agency === 'police'){
        pool.push(...INCIDENT_CATALOG.police_low, ...INCIDENT_CATALOG.police_med, ...INCIDENT_CATALOG.police_high);
      }else if(agency === 'fire'){
        pool.push(...INCIDENT_CATALOG.fire_low, ...INCIDENT_CATALOG.fire_med, ...INCIDENT_CATALOG.fire_high);
      }else{
        pool.push(
          ...INCIDENT_CATALOG.police_low, ...INCIDENT_CATALOG.police_med, ...INCIDENT_CATALOG.police_high,
          ...INCIDENT_CATALOG.fire_low, ...INCIDENT_CATALOG.fire_med, ...INCIDENT_CATALOG.fire_high
        );
      }
      return pool;
    }

    /***********************
     *  Map setup
     ************************/
    let map, tileLayer;
    const markers = {
      incidents: new Map(), // id -> marker
      units: new Map(),     // id -> marker
      routes: new Map(),    // unitId -> polyline
    };

    function initMap(){
      map = L.map('map', { zoomControl: true, preferCanvas: true });
      tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      });
      tileLayer.addTo(map);
      map.setView(CITIES.saopaulo.center, 12);

      map.on('click', ()=>{
        // click on empty map = no-op
      });
    }

    function setCity(cityKey){
      const c = CITIES[cityKey];
      $('regionTag').textContent = c.regionTag;
      map.setView(c.center, cityKey==='saopaulo' ? 12 : 12);
    }

    function iconForIncident(sev){
      const color = sev==='high' ? '#ef4444' : (sev==='med' ? '#f59e0b' : '#22c55e');
      const html = `
        <div style="
          width:18px;height:18px;border-radius:999px;
          background:${color};
          box-shadow:0 0 0 6px rgba(0,0,0,.22), 0 10px 22px rgba(0,0,0,.35);
          border:1px solid rgba(255,255,255,.25);
        "></div>`;
      return L.divIcon({ html, className:'', iconSize:[18,18], iconAnchor:[9,9] });
    }

    function iconForUnit(unit){
      let color = '#60a5fa';
      if(unit.type==='fire') color = '#fb7185';
      if(unit.type==='medic') color = '#34d399';
      const html = `
        <div style="
          width:22px;height:22px;border-radius:10px;
          background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06)), ${color};
          border:1px solid rgba(255,255,255,.22);
          display:flex;align-items:center;justify-content:center;
          box-shadow:0 18px 45px rgba(0,0,0,.35);
          font-size:12px; color: rgba(0,0,0,.75); font-weight:900;
        ">${unit.type==='police'?'P':(unit.type==='fire'?'F':'M')}</div>`;
      return L.divIcon({ html, className:'', iconSize:[22,22], iconAnchor:[11,11] });
    }

    /***********************
     *  Game state
     ************************/
    const GAME = {
      running: false,
      cityKey: 'saopaulo',
      agency: 'police',
      score: 0,

      shiftElapsed: 0,
      shiftDuration: 8 * 60, // 8min (prototype). Ajuste depois.
      lastCallAt: 0,

      scenarioPool: [],

      queue: [],      // calls waiting
      activeCall: null,
      incidents: [],  // active incidents
      selectedIncidentId: null,

      units: [],      // units (with status + pos)
      tickHandle: null,
    };

    function resetOperationalState(){
      GAME.score = 0;
      GAME.shiftElapsed = 0;
      GAME.lastCallAt = 0;
      GAME.queue = [];
      GAME.activeCall = null;
      GAME.incidents = [];
      GAME.selectedIncidentId = null;

      // clear map markers
      for(const m of markers.incidents.values()) map.removeLayer(m);
      markers.incidents.clear();
      for(const p of markers.routes.values()) map.removeLayer(p);
      markers.routes.clear();

      // units keep but reset status
      for(const u of GAME.units){
        u.status = 'idle';
        u.busyUntil = 0;
      }
      renderAll();
    }

    function buildUnitsForCity(){
      const c = CITIES[GAME.cityKey];
      const bounds = c.bounds;

      GAME.units = c.units.map(u => {
        const lat = rnd(bounds.latMin, bounds.latMax);
        const lng = rnd(bounds.lngMin, bounds.lngMax);
        return {
          ...u,
          lat, lng,
          status: 'idle', // idle / enroute / onscene / returning
          busyUntil: 0,
          target: null
        };
      });

      // remove unit markers
      for(const m of markers.units.values()) map.removeLayer(m);
      markers.units.clear();

      // re-add
      for(const u of GAME.units){
        const mk = L.marker([u.lat,u.lng], { icon: iconForUnit(u) }).addTo(map);
        mk.on('click', ()=>{
          if(!GAME.selectedIncidentId){
            toast('Selecione uma ocorrência primeiro.');
            return;
          }
          selectUnitForDispatch(u.id);
        });
        mk.bindTooltip(u.name, { direction:'top', opacity:0.9 });
        markers.units.set(u.id, mk);
      }
    }

    /***********************
     *  Call / Incident generation
     ************************/
    let _id = 1;
    function nextId(prefix){ return `${prefix}_${_id++}`; }

    function randomLocation(){
      const b = CITIES[GAME.cityKey].bounds;
      return { lat: rnd(b.latMin, b.latMax), lng: rnd(b.lngMin, b.lngMax) };
    }

    function enqueueCall(){
      const scenario = pick(GAME.scenarioPool);
      const loc = randomLocation();

      const call = {
        id: nextId('call'),
        scenario,
        loc,
        createdAt: GAME.shiftElapsed,
        // call timers
        duration: scenario.sev==='high' ? 120 : (scenario.sev==='med' ? 100 : 80),
        timeLeft: scenario.sev==='high' ? 120 : (scenario.sev==='med' ? 100 : 80),
        stage: 0,
        collected: {
          addressKnown: false,
          natureKnown: false,
          dangerKnown: false
        },
        transcript: [],
        typing: null,
        resolved: false
      };

      GAME.queue.push(call);
      renderQueue();
      $('queueTag').textContent = String(GAME.queue.length);

      // alert
      toast('☎️ Nova chamada na fila.');
    }

    function popNextCall(){
      if(GAME.activeCall) return;
      const call = GAME.queue.shift();
      if(!call) return;
      GAME.activeCall = call;
      $('queueTag').textContent = String(GAME.queue.length);
      renderQueue();
      startCallIntro(call);
    }

    function startCallIntro(call){
      const cityKey = GAME.cityKey;
      const agency = GAME.agency;

      let greeting = "Central, qual sua emergência?";
      if(cityKey==='saopaulo'){
        if(agency==='police') greeting = "190, Polícia Militar. Qual sua emergência?";
        else if(agency==='fire') greeting = "193, Bombeiros. Qual sua emergência?";
        else greeting = "CIOSP (Central Integrada). Qual sua emergência?";
      } else {
        // NYC/USA
        if(agency==='police' || agency==='mixed') greeting = "911, what's your emergency?";
        else greeting = "911 Fire/Rescue, what's your emergency?";
      }

      setCallHeader(call, `Chamada — ${CITIES[cityKey].label}`, `ID ${call.id} • Prioridade ${call.scenario.sev.toUpperCase()}`);
      setTranscript(call, []);
      addLine(call, "OPERADOR", greeting, true, ()=> {
        addLine(call, "CHAMADOR", call.scenario.script, true, ()=>{
          renderChoicesForCall(call);
        });
      });
    }

    function setCallHeader(call, title, small){
      $('callTitle').textContent = title;
      $('callSmall').textContent = small;
    }

    function setTranscript(call, lines){
      call.transcript = lines.slice();
      renderTranscript(call);
    }

    function renderTranscript(call){
      const el = $('transcript');
      el.innerHTML = '';
      for(const L of call.transcript){
        const p = document.createElement('p');
        p.className = 'line';
        const who = document.createElement('span');
        who.className = 'who';
        who.textContent = L.who;
        const msg = document.createElement('span');
        msg.textContent = L.text;
        p.appendChild(who);
        p.appendChild(msg);
        el.appendChild(p);
      }
      el.scrollTop = el.scrollHeight;
    }

    // Typewriter
    function typewriterAppend(call, who, text, done){
      const el = $('transcript');

      // create new line
      const p = document.createElement('p');
      p.className = 'line';
      const whoEl = document.createElement('span');
      whoEl.className = 'who';
      whoEl.textContent = who;
      const msgEl = document.createElement('span');
      msgEl.textContent = '';
      p.appendChild(whoEl);
      p.appendChild(msgEl);
      el.appendChild(p);
      el.scrollTop = el.scrollHeight;

      let i = 0;
      const speed = 12; // lower = faster (ms per char approx by interval)
      clearInterval(call.typing);
      call.typing = setInterval(()=>{
        i++;
        msgEl.textContent = text.slice(0, i);
        el.scrollTop = el.scrollHeight;
        if(i >= text.length){
          clearInterval(call.typing);
          call.typing = null;
          // push into transcript (final)
          call.transcript.push({ who, text });
          // rebuild to keep consistent
          renderTranscript(call);
          if(done) done();
        }
      }, speed);
    }

    function addLine(call, who, text, typed=true, done){
      if(!call) return;
      // if already typing, stop to avoid overlap
      if(call.typing){
        clearInterval(call.typing);
        call.typing = null;
      }

      if(!typed){
        call.transcript.push({ who, text });
        renderTranscript(call);
        if(done) done();
        return;
      }
      typewriterAppend(call, who, text, done);
    }

    function renderChoices(buttons){
      const box = $('choices');
      box.innerHTML = '';
      for(const b of buttons){
        const btn = document.createElement('button');
        btn.className = 'choice';
        btn.textContent = b.label;
        btn.onclick = b.onClick;
        box.appendChild(btn);
      }
    }

    function renderChoicesForCall(call){
      if(!call) return;

      const buttons = [];

      // Protocol-ish questions
      buttons.push({
        label: "Perguntar endereço/localização",
        onClick: ()=>{
          if(call.collected.addressKnown){
            addLine(call,"OPERADOR","Confirme novamente: qual o endereço exato?", true, ()=>{
              addLine(call,"CHAMADOR","É aqui mesmo… rápido!", true, ()=> {});
            });
            GAME.score -= 1;
            renderHUD();
            return;
          }
          call.collected.addressKnown = true;
          addLine(call,"OPERADOR","Qual o endereço exato e ponto de referência?", true, ()=>{
            addLine(call,"CHAMADOR", fakeAddressForCity(GAME.cityKey), true, ()=>{
              // small reward
              addScore(+6);
              renderChoicesForCall(call);
            });
          });
        }
      });

      buttons.push({
        label: "Perguntar o que está acontecendo",
        onClick: ()=>{
          if(call.collected.natureKnown){
            addLine(call,"OPERADOR","Entendi. O que mais você consegue ver/ouvir agora?", true, ()=>{
              addLine(call,"CHAMADOR","Tá assustador…", true, ()=> {});
            });
            addScore(+1);
            return;
          }
          call.collected.natureKnown = true;
          addLine(call,"OPERADOR","Certo. Descreva a emergência em uma frase.", true, ()=>{
            addLine(call,"CHAMADOR", call.scenario.title + ".", true, ()=>{
              addScore(+6);
              renderChoicesForCall(call);
            });
          });
        }
      });

      buttons.push({
        label: "Perguntar risco imediato (armas/fogo/feridos)",
        onClick: ()=>{
          if(call.collected.dangerKnown){
            addLine(call,"OPERADOR","Fique em segurança. Alguma mudança agora?", true, ()=>{
              addLine(call,"CHAMADOR","Tô tentando…", true, ()=> {});
            });
            addScore(+1);
            return;
          }
          call.collected.dangerKnown = true;
          addLine(call,"OPERADOR","Existe risco imediato? Arma, fogo, fumaça, alguém inconsciente?", true, ()=>{
            addLine(call,"CHAMADOR", dangerLineFromScenario(call.scenario), true, ()=>{
              addScore(+6);
              renderChoicesForCall(call);
            });
          });
        }
      });

      // Provide instruction if medical/fire
      buttons.push({
        label: "Dar instruções de segurança / primeiros socorros",
        onClick: ()=>{
          const instr = instructionForScenario(call.scenario);
          addLine(call,"OPERADOR", instr, true, ()=>{
            addLine(call,"CHAMADOR","Ok… vou tentar!", true, ()=>{
              addScore(+8);
              renderChoicesForCall(call);
            });
          });
        }
      });

      // Create incident
      buttons.push({
        label: "Registrar ocorrência e abrir despacho",
        onClick: ()=>{
          // require at least address or nature ideally
          const goodInfo = (call.collected.addressKnown || call.collected.natureKnown);
          if(!goodInfo){
            addLine(call,"OPERADOR","Preciso do endereço e do que está acontecendo para enviar ajuda.", true, ()=>{
              addScore(-3);
              renderChoicesForCall(call);
            });
            return;
          }
          // Create incident on map
          const inc = createIncidentFromCall(call);
          addLine(call,"OPERADOR","Entendido. Unidades a caminho. Permaneça na linha se possível.", true, ()=>{
            addScore(+10);
            // end call and focus dispatch
            endActiveCall(`Ocorrência registrada: ${inc.title}`);
            selectIncident(inc.id);
          });
        }
      });

      // triage/close prank
      buttons.push({
        label: "Encerrar / classificar como trote (se aplicável)",
        onClick: ()=>{
          if(call.scenario.needs.includes('triage')){
            addLine(call,"OPERADOR","Entendido. Sem emergência confirmada. Encerrando e registrando a ligação.", true, ()=>{
              addScore(+8);
              addXP(8);
              endActiveCall("Ligação encerrada (trote/sem confirmação).");
            });
          } else {
            // wrong: you closed a real emergency
            addLine(call,"OPERADOR","Vou encerrar a ligação.", true, ()=>{
              addScore(-18);
              addXP(-5);
              endActiveCall("Erro: ligação encerrada indevidamente.");
            });
          }
        }
      });

      renderChoices(buttons);
    }

    function fakeAddressForCity(cityKey){
      if(cityKey==='saopaulo'){
        return pick([
          "Av. Paulista, próximo ao MASP.",
          "Rua da Consolação, perto do metrô.",
          "Marginal Tietê, sentido Castelo Branco.",
          "Av. Rebouças, esquina com uma farmácia.",
          "Av. 23 de Maio, perto do viaduto."
        ]);
      }
      return pick([
        "5th Avenue near Central Park.",
        "Broadway, close to Times Square.",
        "Brooklyn, near the bridge entrance.",
        "Queens, near a subway station.",
        "Lower Manhattan, near Wall Street."
      ]);
    }

    function dangerLineFromScenario(sc){
      if(sc.key.includes('bomba')) return "Tem gente perto… e ninguém sabe o que é!";
      if(sc.key.includes('tiros')) return "Tem risco sim! Eu tô escondido!";
      if(sc.key.includes('incendio')) return "Tem fumaça forte e chamas!";
      if(sc.key.includes('parada')) return "Ele não respira, tá roxo!";
      if(sc.key.includes('acidente')) return "Tem sangue e gritos…";
      if(sc.needs.includes('triage')) return "Ah… acho que era brincadeira…";
      return "Não sei… tô com medo!";
    }

    function instructionForScenario(sc){
      // educational-ish, not overly explicit.
      if(sc.key.includes('parada')){
        return "Inicie compressões no centro do peito: rápidas e firmes. Se houver alguém, peça para ligar e trazer ajuda. Continue até a ambulância chegar.";
      }
      if(sc.key.includes('parto')){
        return "Mantenha a pessoa confortável. Prepare toalhas limpas. Não puxe o bebê. Apoie e aguarde a equipe médica.";
      }
      if(sc.key.includes('incendio') || sc.key.includes('fumaça')){
        return "Saia do local com segurança. Não use elevador. Se houver fumaça, fique baixo e feche portas ao sair. Não tente combater fogo se não for seguro.";
      }
      if(sc.key.includes('acidente')){
        return "Não mova a vítima se houver suspeita de trauma. Sinalize o local e desligue o motor se for seguro. Aguarde resgate.";
      }
      if(sc.key.includes('tiros')){
        return "Abaixe-se, procure abrigo e mantenha-se longe de janelas. Não confronte. Fique em silêncio e só fale se seguro.";
      }
      if(sc.needs.includes('triage')){
        return "Preciso de informações reais. Se não houver emergência, não ocupe a linha. Trotes colocam vidas em risco.";
      }
      return "Mantenha a calma, afaste-se do risco e aguarde as equipes.";
    }

    function createIncidentFromCall(call){
      const inc = {
        id: nextId('inc'),
        title: call.scenario.title,
        sev: call.scenario.sev,
        needs: call.scenario.needs.slice(), // tags
        loc: { ...call.loc },
        createdAt: GAME.shiftElapsed,
        dispatched: false,
        resolved: false,
        assignedUnitId: null,
        expiresIn: call.scenario.sev==='high' ? 150 : (call.scenario.sev==='med' ? 180 : 210),
        timeLeft: call.scenario.sev==='high' ? 150 : (call.scenario.sev==='med' ? 180 : 210),
      };

      GAME.incidents.push(inc);
      $('incTag').textContent = String(GAME.incidents.length);

      const mk = L.marker([inc.loc.lat, inc.loc.lng], { icon: iconForIncident(inc.sev) }).addTo(map);
      mk.on('click', ()=> selectIncident(inc.id));
      mk.bindTooltip(`${inc.title}`, { direction:'top', opacity:0.9 });
      markers.incidents.set(inc.id, mk);

      renderIncidents();
      return inc;
    }

    function endActiveCall(note){
      if(!GAME.activeCall) return;
      clearInterval(GAME.activeCall.typing);
      GAME.activeCall.typing = null;

      setTranscript(GAME.activeCall, GAME.activeCall.transcript);
      $('choices').innerHTML = '';
      $('callTitle').textContent = 'Sem chamada ativa';
      $('callSmall').textContent = note || 'Aguardando…';
      GAME.activeCall = null;
      updateCallTimerUI(null);

      // auto take next if exists
      if(GAME.queue.length){
        setTimeout(()=> popNextCall(), 450);
      }
    }

    /***********************
     *  Dispatch mechanics
     ************************/
    let selectedUnitId = null;

    function selectIncident(incId){
      GAME.selectedIncidentId = incId;
      const inc = GAME.incidents.find(x=>x.id===incId);
      if(!inc) return;

      $('dispatchHint').textContent = `Selecionada: ${inc.title}`;
      $('btnDispatch').disabled = false;
      $('btnUnselect').disabled = false;

      renderDispatchPanel();
      toast(`Ocorrência selecionada: ${inc.title}`);
    }

    function selectUnitForDispatch(unitId){
      selectedUnitId = unitId;
      renderDispatchPanel();
      toast('Unidade selecionada para despacho.');
    }

    function renderDispatchPanel(){
      const inc = GAME.incidents.find(x=>x.id===GAME.selectedIncidentId);
      if(!inc){
        $('dispatchPanel').textContent = 'Nenhuma ocorrência selecionada.';
        $('btnDispatch').disabled = true;
        $('btnUnselect').disabled = true;
        return;
      }

      const needs = inc.needs.map(t=>`<span class="chip">${t}</span>`).join(' ');
      const unit = selectedUnitId ? GAME.units.find(u=>u.id===selectedUnitId) : null;

      const unitLine = unit
        ? `<div style="margin-top:8px"><strong>Unidade escolhida:</strong> ${escapeHTML(unit.name)} <span class="chip ${unit.status==='idle'?'ok':'busy'}">${unit.status}</span></div>`
        : `<div style="margin-top:8px; opacity:.85">Escolha uma unidade (toque em uma na lista abaixo).</div>`;

      $('dispatchPanel').innerHTML = `
        <div><strong>Ocorrência:</strong> ${escapeHTML(inc.title)} <span class="sev ${inc.sev==='high'?'high':(inc.sev==='med'?'med':'low')}">${inc.sev.toUpperCase()}</span></div>
        <div style="margin-top:8px"><strong>Necessidades:</strong> ${needs}</div>
        ${unitLine}
        <div style="margin-top:8px; opacity:.8; font-family: var(--mono); font-size: 12px;">
          Tempo restante: ${fmtMMSS(inc.timeLeft)}
        </div>
      `;
    }

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    function canUnitHandleIncident(unit, inc){
      // if incident is triage only, no unit needed
      if(inc.needs.includes('triage')) return false;

      // needs: a set of tags that must be satisfied at least partially.
      // We'll treat: must match all "core" groups:
      // - if includes 'police' -> unit.tags must include 'police'
      // - if includes 'fire' -> unit.tags must include 'fire'
      // - if includes 'medic' -> unit.tags must include 'medic'
      // other tags like tactical/bomb/rescue/firetruck/ems should be matched if present.
      const needSet = new Set(inc.needs);

      // service group
      const serviceNeeds = ['police','fire','medic'];
      for(const s of serviceNeeds){
        if(needSet.has(s) && !unit.tags.includes(s)) return false;
      }

      // extra tags (ignore triage)
      for(const t of inc.needs){
        if(t==='triage') continue;
        if(serviceNeeds.includes(t)) continue;
        // accept if unit has tag OR some flexible equivalents:
        if(t==='tactical' && (unit.tags.includes('swat') || unit.tags.includes('tactical'))) continue;
        if(t==='ems' && unit.tags.includes('ems')) continue;
        if(t==='firetruck' && unit.tags.includes('firetruck')) continue;
        if(t==='rescue' && unit.tags.includes('rescue')) continue;
        if(t==='bomb' && unit.tags.includes('bomb')) continue;
        if(t==='patrol' && unit.tags.includes('patrol')) continue;
        if(!unit.tags.includes(t)) return false;
      }
      return true;
    }

    function dispatchSelected(){
      const inc = GAME.incidents.find(x=>x.id===GAME.selectedIncidentId);
      if(!inc){
        toast('Selecione uma ocorrência.');
        return;
      }
      if(!selectedUnitId){
        toast('Selecione uma unidade.');
        return;
      }
      const unit = GAME.units.find(u=>u.id===selectedUnitId);
      if(!unit){
        toast('Unidade inválida.');
        return;
      }
      if(unit.status !== 'idle'){
        toast('Unidade ocupada. Escolha outra.');
        return;
      }
      if(inc.dispatched){
        toast('Essa ocorrência já foi despachada.');
        return;
      }

      // validate right unit
      const ok = canUnitHandleIncident(unit, inc);

      // create route polyline (straight line prototype)
      const from = [unit.lat, unit.lng];
      const to = [inc.loc.lat, inc.loc.lng];
      const line = L.polyline([from, to], { color: ok ? '#22c55e' : '#f59e0b', weight: 3, opacity: 0.85 }).addTo(map);

      // replace old route if exists
      if(markers.routes.has(unit.id)){
        map.removeLayer(markers.routes.get(unit.id));
      }
      markers.routes.set(unit.id, line);

      unit.status = 'enroute';
      unit.target = { incId: inc.id, toLat: inc.loc.lat, toLng: inc.loc.lng, ok };
      inc.dispatched = true;
      inc.assignedUnitId = unit.id;

      // scoring immediate
      if(ok){
        addScore(+10);
        toast('Despacho realizado (unidade adequada).');
      }else{
        addScore(-8);
        toast('Despacho suspeito: unidade pode ser inadequada.');
      }

      renderUnits();
      renderIncidents();
      renderDispatchPanel();
    }

    function clearSelection(){
      GAME.selectedIncidentId = null;
      selectedUnitId = null;
      $('dispatchHint').textContent = 'Selecione uma ocorrência';
      $('btnDispatch').disabled = true;
      $('btnUnselect').disabled = true;
      renderDispatchPanel();
    }

    /***********************
     *  Scoring + resolve
     ************************/
    function addScore(delta){
      GAME.score = Math.max(-999, GAME.score + delta);
      renderHUD();
    }

    function resolveIncident(inc, unit){
      if(inc.resolved) return;
      inc.resolved = true;

      // Determine outcome based on timeLeft and whether unit ok
      const urgency = inc.sev==='high' ? 3 : (inc.sev==='med' ? 2 : 1);
      const timeFactor = inc.timeLeft / (inc.sev==='high' ? 150 : (inc.sev==='med' ? 180 : 210));
      const fast = timeFactor > 0.55;

      let outcome = "Resolvido.";
      let scoreDelta = 0;
      let xpDelta = 0;
      let moneyDelta = 0;

      if(unit && unit.target && unit.target.ok){
        scoreDelta += 18 * urgency;
        xpDelta += 12 * urgency;
        moneyDelta += 8 * urgency;
        outcome = fast ? "Sucesso rápido. Bom trabalho." : "Sucesso. Atendimento dentro do esperado.";
      } else {
        // wrong unit or no unit
        scoreDelta -= 12 * urgency;
        xpDelta += 2;
        moneyDelta += 1;
        outcome = "Resultado ruim: unidade inadequada/atraso. Penalização.";
      }

      addScore(Math.round(scoreDelta));
      addXP(Math.round(xpDelta));
      addMoney(Math.round(moneyDelta));

      // remove marker
      const mk = markers.incidents.get(inc.id);
      if(mk){
        map.removeLayer(mk);
        markers.incidents.delete(inc.id);
      }

      // remove from list
      GAME.incidents = GAME.incidents.filter(x=>x.id !== inc.id);
      $('incTag').textContent = String(GAME.incidents.length);
      renderIncidents();

      toast(`📄 Relatório: ${outcome}`);
      if(GAME.selectedIncidentId === inc.id) clearSelection();
    }

    /***********************
     *  Rendering lists
     ************************/
    function renderQueue(){
      const list = $('queueList');
      list.innerHTML = '';

      if(!GAME.queue.length){
        const div = document.createElement('div');
        div.className = 'muted';
        div.textContent = 'Sem chamadas na fila.';
        list.appendChild(div);
        return;
      }

      for(const c of GAME.queue.slice(0,6)){
        const it = document.createElement('div');
        it.className = 'item';
        it.onclick = ()=> {
          if(GAME.activeCall){
            toast('Finalize a chamada atual antes de atender outra.');
            return;
          }
          // bring it to front
          GAME.queue = [c, ...GAME.queue.filter(x=>x.id!==c.id)];
          popNextCall();
        };
        it.innerHTML = `
          <div class="a">
            <p class="t">${escapeHTML(c.scenario.title)}</p>
            <div class="s">ID ${c.id} • ${CITIES[GAME.cityKey].label}</div>
          </div>
          <span class="sev ${c.scenario.sev==='high'?'high':(c.scenario.sev==='med'?'med':'low')}">${c.scenario.sev.toUpperCase()}</span>
        `;
        list.appendChild(it);
      }
    }

    function renderIncidents(){
      const list = $('incList');
      list.innerHTML = '';

      if(!GAME.incidents.length){
        const div = document.createElement('div');
        div.className = 'muted';
        div.textContent = 'Sem ocorrências ativas.';
        list.appendChild(div);
        return;
      }

      for(const inc of GAME.incidents.slice(0,10)){
        const it = document.createElement('div');
        it.className = 'item';
        it.onclick = ()=> selectIncident(inc.id);
        const unitName = inc.assignedUnitId ? (GAME.units.find(u=>u.id===inc.assignedUnitId)?.name || 'Unidade') : '—';
        it.innerHTML = `
          <div class="a">
            <p class="t">${escapeHTML(inc.title)}</p>
            <div class="s">ID ${inc.id} • Unidade: ${escapeHTML(unitName)} • ⏱ ${fmtMMSS(inc.timeLeft)}</div>
          </div>
          <span class="sev ${inc.sev==='high'?'high':(inc.sev==='med'?'med':'low')}">${inc.sev.toUpperCase()}</span>
        `;
        list.appendChild(it);
      }
      renderDispatchPanel();
    }

    function renderUnits(){
      const wrap = $('unitChips');
      wrap.innerHTML = '';
      for(const u of GAME.units){
        const chip = document.createElement('span');
        chip.className = 'chip ' + (u.status==='idle'?'ok':(u.status==='enroute'?'busy':'busy'));
        chip.textContent = `${u.name}`;
        chip.onclick = ()=>{
          if(!GAME.selectedIncidentId){
            toast('Selecione uma ocorrência primeiro.');
            return;
          }
          selectUnitForDispatch(u.id);
        };
        wrap.appendChild(chip);
      }
    }

    function renderHUD(){
      $('score').textContent = String(GAME.score);
      $('shiftClock').textContent = fmtMMSS(GAME.shiftElapsed);

      $('lvl').textContent = String(CAREER.lvl);
      $('xp').textContent = String(CAREER.xp);
      $('money').textContent = String(CAREER.money);

      $('shiftState').textContent = GAME.running ? 'ON' : 'OFF';
      const dot = $('dotShift');
      dot.className = 'dot ' + (GAME.running ? 'ok' : '');
    }

    function updateCallTimerUI(call){
      if(!call){
        $('callTimerTxt').textContent = '--:--';
        $('callTimerBar').style.width = '0%';
        return;
      }
      $('callTimerTxt').textContent = fmtMMSS(call.timeLeft);
      const pct = 100 * (call.timeLeft / call.duration);
      $('callTimerBar').style.width = `${clamp(pct,0,100)}%`;
    }

    function renderAll(){
      renderHUD();
      renderQueue();
      renderIncidents();
      renderUnits();
      renderDispatchPanel();
    }

    /***********************
     *  Main loop
     ************************/
    function startShift(){
      if(GAME.running) return;

      GAME.running = true;

      GAME.cityKey = $('city').value;
      GAME.agency = $('agency').value;

      setCity(GAME.cityKey);
      GAME.scenarioPool = buildScenarioPool(GAME.agency);

      buildUnitsForCity();
      resetOperationalState();

      $('btnStart').disabled = true;
      $('btnEnd').disabled = false;
      $('btnNextCall').disabled = false;

      // seed some calls quickly
      enqueueCall();
      enqueueCall();
      popNextCall();

      // loop
      if(GAME.tickHandle) clearInterval(GAME.tickHandle);
      GAME.tickHandle = setInterval(tick, 250);

      toast('Turno iniciado.');
      renderAll();
    }

    function endShift(){
      if(!GAME.running) return;

      GAME.running = false;
      clearInterval(GAME.tickHandle);
      GAME.tickHandle = null;

      $('btnStart').disabled = false;
      $('btnEnd').disabled = true;
      $('btnNextCall').disabled = true;

      endActiveCall("Turno encerrado.");
      clearSelection();

      // reward based on score
      const reward = Math.max(0, Math.floor(GAME.score / 10));
      addMoney(reward);
      addXP(Math.max(0, Math.floor(GAME.score / 12)));

      toast(`Turno encerrado. Bônus: ${reward} créditos.`);
      renderAll();
    }

    function tick(){
      if(!GAME.running) return;

      GAME.shiftElapsed += 0.25;

      // Shift end
      if(GAME.shiftElapsed >= GAME.shiftDuration){
        endShift();
        return;
      }

      // Generate calls periodically, faster at higher level
      const baseInterval = 18; // seconds
      const lvlFactor = clamp(1 - (CAREER.lvl-1)*0.03, 0.72, 1.0);
      const interval = baseInterval * lvlFactor;

      if(GAME.shiftElapsed - GAME.lastCallAt >= interval){
        GAME.lastCallAt = GAME.shiftElapsed;
        // sometimes generate 2 calls burst
        enqueueCall();
        if(Math.random() < 0.18) enqueueCall();
        // if no active call, take it
        if(!GAME.activeCall) popNextCall();
      }

      // Update active call timer
      if(GAME.activeCall){
        GAME.activeCall.timeLeft -= 0.25;
        if(GAME.activeCall.timeLeft <= 0){
          // call timed out => penalty
          addScore(-10);
          addXP(1);
          endActiveCall("Chamada perdida por demora.");
        } else {
          updateCallTimerUI(GAME.activeCall);
        }
      }

      // Update incidents timer
      for(const inc of GAME.incidents){
        inc.timeLeft -= 0.25;
      }

      // If incident expires -> penalty and remove
      for(const inc of [...GAME.incidents]){
        if(inc.timeLeft <= 0){
          // expired / worst outcome
          addScore(inc.sev==='high' ? -30 : (inc.sev==='med' ? -18 : -8));
          addXP(2);
          addMoney(0);

          // remove marker
          const mk = markers.incidents.get(inc.id);
          if(mk){
            map.removeLayer(mk);
            markers.incidents.delete(inc.id);
          }
          GAME.incidents = GAME.incidents.filter(x=>x.id !== inc.id);
          $('incTag').textContent = String(GAME.incidents.length);
          if(GAME.selectedIncidentId === inc.id) clearSelection();
          toast('Ocorrência piorou/expirou. Penalização.');
        }
      }

      // Move units (simple linear interpolation)
      const dt = 0.25;
      for(const u of GAME.units){
        if(u.status === 'enroute' && u.target){
          const speed = u.speed; // higher = faster
          // step size scaled to lat/lng approx (gamey)
          const step = 0.0009 * speed; // tweak
          const dLat = u.target.toLat - u.lat;
          const dLng = u.target.toLng - u.lng;
          const dist = Math.hypot(dLat, dLng);

          if(dist < step){
            // arrive
            u.lat = u.target.toLat;
            u.lng = u.target.toLng;
            u.status = 'onscene';

            // on-scene duration
            const inc = GAME.incidents.find(x=>x.id===u.target.incId);
            const onscene = inc ? (inc.sev==='high' ? 10 : (inc.sev==='med' ? 12 : 9)) : 9;
            u.busyUntil = GAME.shiftElapsed + onscene;

            // update marker
            markers.units.get(u.id)?.setLatLng([u.lat,u.lng]);

            toast(`Unidade chegou: ${u.name}`);
          }else{
            // move fractionally
            u.lat += (dLat / dist) * step;
            u.lng += (dLng / dist) * step;
            markers.units.get(u.id)?.setLatLng([u.lat,u.lng]);
          }
        }

        if(u.status === 'onscene' && GAME.shiftElapsed >= u.busyUntil){
          // resolve incident
          const inc = GAME.incidents.find(x=>x.id===u.target?.incId);
          resolveIncident(inc, u);

          // go idle
          u.status = 'idle';
          u.target = null;
          u.busyUntil = 0;

          // remove route
          if(markers.routes.has(u.id)){
            map.removeLayer(markers.routes.get(u.id));
            markers.routes.delete(u.id);
          }

          renderUnits();
        }
      }

      // refresh some UI every tick
      renderHUD();
      renderIncidents();
    }

    /***********************
     *  Wire UI
     ************************/
    function wire(){
      $('btnStart').onclick = startShift;
      $('btnEnd').onclick = endShift;

      $('btnNextCall').onclick = ()=>{
        if(!GAME.running){
          toast('Inicie o turno primeiro.');
          return;
        }
        enqueueCall();
        if(!GAME.activeCall) popNextCall();
      };

      $('btnDispatch').onclick = dispatchSelected;
      $('btnUnselect').onclick = clearSelection;

      $('city').onchange = ()=>{
        if(GAME.running){
          toast('Para trocar cidade, encerre o turno.');
          $('city').value = GAME.cityKey;
          return;
        }
        GAME.cityKey = $('city').value;
        setCity(GAME.cityKey);
        $('regionTag').textContent = CITIES[GAME.cityKey].regionTag;
      };

      $('agency').onchange = ()=>{
        if(GAME.running){
          toast('Para trocar agência, encerre o turno.');
          $('agency').value = GAME.agency;
          return;
        }
      };

      $('btnClearSave').onclick = ()=>{
        localStorage.removeItem(SAVE_KEY);
        CAREER = loadCareer();
        toast('Carreira resetada.');
        renderHUD();
      };
    }

    /***********************
     *  Boot
     ************************/
    initMap();
    wire();

    // init city view
    setCity('saopaulo');
    $('city').value = 'saopaulo';
    $('agency').value = 'police';
    renderAll();

    // small initial hint
    setTimeout(()=>toast('Dica: Inicie o turno, atenda a chamada e depois crie o despacho.'), 650);
  </script>
</body>
</html>