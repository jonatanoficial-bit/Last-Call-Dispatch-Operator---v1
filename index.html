<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Last Call Dispatch Operator</title>
  <style>
    :root{
      --bg:#070914;
      --panel:#0b1022cc;
      --text:#e8ecff;
      --muted:#aeb8e8;
      --accent:#7cf7ff;
      --danger:#ff4d6d;
      --warn:#ffb020;
      --good:#3dff9e;
      --shadow: 0 10px 40px rgba(0,0,0,.45);
      --radius2:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(124,247,255,.12), transparent 55%),
                  radial-gradient(900px 500px at 80% 20%, rgba(255,77,109,.10), transparent 55%),
                  radial-gradient(800px 500px at 40% 90%, rgba(61,255,158,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    .app{max-width:1400px;margin:0 auto;padding:12px 12px 22px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 10px 14px;border-radius:var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow)
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:240px}
    .logo{
      width:44px;height:44px;border-radius:14px;display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(124,247,255,.25), rgba(124,247,255,.05));
      border:1px solid rgba(124,247,255,.28);color:var(--accent);font-weight:900
    }
    .brandText .title{font-weight:900;font-size:14px}
    .brandText .subtitle{font-size:12px;color:var(--muted)}
    .hud{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);display:flex;gap:8px;align-items:baseline
    }
    .pillLabel{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
    .pillValue{font-size:12px;font-weight:800}
    .layout{
      margin-top:12px;display:grid;grid-template-columns:1.05fr 1.25fr;grid-template-rows:auto auto;gap:12px
    }
    .panel{
      background: radial-gradient(900px 300px at 10% 20%, rgba(124,247,255,.08), transparent 60%),
                  radial-gradient(900px 300px at 80% 30%, rgba(255,77,109,.07), transparent 60%),
                  var(--panel);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius2);box-shadow:var(--shadow);overflow:hidden
    }
    .panelHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 12px 10px;border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.12)
    }
    .panelTitle{font-weight:900;font-size:13px}
    .panelMeta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{
      font-size:11px;padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);color:var(--muted)
    }
    .badge.high{border-color:rgba(255,77,109,.35);background:rgba(255,77,109,.12);color:#ffdbe2}
    .badge.med{border-color:rgba(255,176,32,.28);background:rgba(255,176,32,.12);color:#ffe7b4}
    .badge.low{border-color:rgba(61,255,158,.22);background:rgba(61,255,158,.10);color:#c9ffe9}
    .badge.neutral{border-color:rgba(124,247,255,.25);background:rgba(124,247,255,.10);color:#cfefff}

    .btn{
      appearance:none;border:none;cursor:pointer;padding:10px 12px;border-radius:14px;
      font-weight:900;font-size:12px;color:var(--text);
      background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.10);
      transition:transform .06s ease, background .18s ease, border-color .18s ease, opacity .18s ease
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:active{transform:scale(.98)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn.primary{background:rgba(124,247,255,.14);border-color:rgba(124,247,255,.25);color:var(--accent)}
    .btn.ghost{background:rgba(255,255,255,.04)}
    .btn.danger{background:rgba(255,77,109,.14);border-color:rgba(255,77,109,.28);color:#ffdbe2}
    .btn.warn{background:rgba(255,176,32,.14);border-color:rgba(255,176,32,.25);color:#ffe7b4}
    .btn.good{background:rgba(61,255,158,.12);border-color:rgba(61,255,158,.22);color:#c9ffe9}

    .help{
      margin:0 12px 12px;padding:10px 12px;border-radius:14px;background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);color:var(--muted);font-size:12px
    }

    .callPanel{min-height:440px;display:flex;flex-direction:column}
    .dispatchPanel{min-height:440px;display:flex;flex-direction:column}
    .queuePanel{grid-column:1/-1}

    .callTranscript{padding:12px;height:240px;overflow:auto;font-size:12px;line-height:1.5}
    .line{margin:0 0 8px;white-space:pre-wrap}
    .op{color:var(--accent)}
    .cl{color:var(--text)}
    .sys{color:var(--muted)}
    .bad{color:var(--danger)}
    .good{color:var(--good)}
    .typingCaret{
      display:inline-block; width:9px; height:14px; margin-left:2px;
      background: rgba(124,247,255,.75);
      transform: translateY(2px);
      animation: blink .85s infinite;
      border-radius:2px;
    }
    @keyframes blink { 0%,55%{opacity:1} 56%,100%{opacity:0} }

    .callFields{padding:0 12px 12px;display:grid;gap:6px}
    .fieldRow{display:flex;gap:8px;align-items:baseline}
    .fieldLabel{color:var(--muted);font-size:12px;min-width:78px}
    .fieldValue{font-size:12px;font-weight:800}

    .actions{padding:0 12px 12px;display:flex;gap:8px;flex-wrap:wrap}
    .actions.bottom{padding-top:2px}

    .mapWrap{position:relative;padding:12px;flex:1}
    #gridCanvas{
      width:100%;height:330px;border-radius:18px;background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);display:block
    }
    .unitDock{
      position:absolute;left:16px;bottom:16px;display:flex;gap:8px;padding:8px;border-radius:16px;
      background:rgba(0,0,0,.30);border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(8px)
    }
    .unitBtn{
      width:40px;height:30px;border-radius:10px;font-weight:900;font-size:12px;
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06);color:var(--text)
    }
    .unitBtn:disabled{opacity:.45}
    .unitBtn.police{color:#b9d3ff;border-color:rgba(129,170,255,.25);background:rgba(129,170,255,.10)}
    .unitBtn.fire{color:#ffd0d7;border-color:rgba(255,77,109,.25);background:rgba(255,77,109,.10)}
    .unitBtn.medic{color:#c9ffe9;border-color:rgba(61,255,158,.22);background:rgba(61,255,158,.10)}

    .queueList{padding:10px 12px 6px;display:flex;gap:10px;overflow:auto}
    .qItem{
      min-width:260px;max-width:320px;padding:10px 10px;border-radius:16px;background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.08);cursor:pointer
    }
    .qItem.selected{border-color:rgba(124,247,255,.55);box-shadow:0 0 0 2px rgba(124,247,255,.12) inset}
    .qTop{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:6px}
    .qId{font-size:12px;font-weight:900}
    .qMeta{display:flex;gap:8px;align-items:center}
    .tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06);color:var(--muted)}
    .tag.high{border-color:rgba(255,77,109,.28);background:rgba(255,77,109,.12);color:#ffdbe2}
    .tag.med{border-color:rgba(255,176,32,.25);background:rgba(255,176,32,.12);color:#ffe7b4}
    .tag.low{border-color:rgba(61,255,158,.22);background:rgba(61,255,158,.10);color:#c9ffe9}
    .tag.prank{border-color:rgba(124,247,255,.25);background:rgba(124,247,255,.10);color:#cfefff}
    .qText{font-size:12px;line-height:1.4;white-space:pre-wrap}
    .qFooter{margin-top:8px;color:var(--muted);font-size:11px}

    .queueFooter{
      padding:10px 12px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.06);background:rgba(0,0,0,.10)
    }
    .queueHint{color:var(--muted);font-size:12px;flex:1;min-width:160px}

    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      min-width:220px;max-width:92vw;padding:10px 12px;border-radius:14px;background:rgba(0,0,0,.60);
      border:1px solid rgba(255,255,255,.12);color:var(--text);font-size:12px;
      opacity:0;pointer-events:none;transition:opacity .18s ease, transform .18s ease;box-shadow:var(--shadow);z-index:50
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
    .errorBar{
      position:fixed;left:12px;right:12px;bottom:70px;padding:10px 12px;border-radius:14px;
      background:rgba(255,77,109,.16);border:1px solid rgba(255,77,109,.30);color:#ffdbe2;
      font-size:12px;display:none;z-index:60;box-shadow:var(--shadow)
    }

    @media (max-width:920px){
      .layout{grid-template-columns:1fr;grid-template-rows:auto auto auto}
      .queuePanel{grid-column:auto}
      #gridCanvas{height:300px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo">LCDO</div>
        <div class="brandText">
          <div class="title">Last Call Dispatch Operator</div>
          <div class="subtitle">Fase: Jogabilidade ‚Äî m√°quina de escrever + trotes + gravidade</div>
        </div>
      </div>
      <div class="hud">
        <div class="pill"><div class="pillLabel">Cidade</div><div class="pillValue" id="hudCity">Nova Aurora (Simula√ß√£o)</div></div>
        <div class="pill"><div class="pillLabel">Turno</div><div class="pillValue" id="hudShift">06:00</div></div>
        <div class="pill"><div class="pillLabel">Score</div><div class="pillValue" id="hudScore">0</div></div>
        <button class="btn ghost" id="btnPause">Pausar</button>
      </div>
    </header>

    <main class="layout">
      <section class="panel callPanel">
        <div class="panelHeader">
          <div class="panelTitle">Chamada ativa</div>
          <div class="panelMeta">
            <span class="badge neutral" id="badgeType">‚Äî</span>
            <span class="badge" id="badgeRisk">‚Äî</span>
            <span class="badge" id="badgeCallTime">Tempo 00:00</span>
          </div>
        </div>

        <div class="callTranscript" id="callTranscript"></div>

        <div class="callFields">
          <div class="fieldRow"><div class="fieldLabel">Endere√ßo:</div><div class="fieldValue" id="fieldAddress">‚Äî</div></div>
          <div class="fieldRow"><div class="fieldLabel">Detalhes:</div><div class="fieldValue" id="fieldDetails">‚Äî</div></div>
          <div class="fieldRow"><div class="fieldLabel">V√≠timas:</div><div class="fieldValue" id="fieldVictims">‚Äî</div></div>
        </div>

        <div class="actions">
          <button class="btn" id="btnAskAddress">Perguntar endere√ßo</button>
          <button class="btn" id="btnAskDetails">Perguntar detalhes</button>
          <button class="btn" id="btnAskVictims">Perguntar v√≠timas</button>
          <button class="btn warn" id="btnGiveInstructions">Instru√ß√µes pr√©-chegada</button>
        </div>

        <div class="actions bottom">
          <button class="btn good" id="btnMarkPrank">Marcar como trote</button>
          <button class="btn ghost" id="btnHold">Colocar em espera</button>
          <button class="btn danger" id="btnEndCall">Encerrar chamada</button>
        </div>

        <div class="help" id="callHelp">
          Dica: trotes existem. Se suspeitar, use <b>‚ÄúMarcar como trote‚Äù</b>. Se for emerg√™ncia real, isso d√° penalidade.
        </div>
      </section>

      <section class="panel dispatchPanel">
        <div class="panelHeader">
          <div class="panelTitle">Despacho</div>
          <div class="panelMeta">
            <span class="badge" id="badgeIncident">Incidente: ‚Äî</span>
          </div>
        </div>

        <div class="mapWrap">
          <canvas id="gridCanvas" width="900" height="520"></canvas>

          <div class="unitDock">
            <button class="unitBtn police" id="dockP1">P1</button>
            <button class="unitBtn police" id="dockP2">P2</button>
            <button class="unitBtn fire" id="dockF1">F1</button>
            <button class="unitBtn medic" id="dockM1">M1</button>
          </div>
        </div>

        <div class="help">
          Toque no √≠cone <b>!</b> para selecionar incidente. Depois toque numa unidade para despachar.
        </div>
      </section>

      <section class="panel queuePanel">
        <div class="panelHeader">
          <div class="panelTitle">Fila de chamadas</div>
          <div class="panelMeta"><span class="badge" id="badgeQueueCount">0</span></div>
        </div>

        <div class="queueList" id="queueList"></div>

        <div class="queueFooter">
          <button class="btn primary" id="btnStart">Iniciar turno</button>
          <button class="btn ghost" id="btnRestart">Reiniciar</button>
          <div class="queueHint" id="queueHint">Depois de iniciar, toque em uma chamada para selecionar.</div>
          <button class="btn" id="btnAnswer">Atender selecionada</button>
        </div>
      </section>
    </main>

    <div class="toast" id="toast"></div>
    <div class="errorBar" id="errorBar"></div>
  </div>

  <script>
    (function(){
      const els = {
        hudCity: document.getElementById('hudCity'),
        hudShift: document.getElementById('hudShift'),
        hudScore: document.getElementById('hudScore'),
        btnPause: document.getElementById('btnPause'),

        btnStart: document.getElementById('btnStart'),
        btnRestart: document.getElementById('btnRestart'),
        btnAnswer: document.getElementById('btnAnswer'),

        btnAskAddress: document.getElementById('btnAskAddress'),
        btnAskDetails: document.getElementById('btnAskDetails'),
        btnAskVictims: document.getElementById('btnAskVictims'),
        btnGiveInstructions: document.getElementById('btnGiveInstructions'),
        btnMarkPrank: document.getElementById('btnMarkPrank'),
        btnHold: document.getElementById('btnHold'),
        btnEndCall: document.getElementById('btnEndCall'),

        badgeType: document.getElementById('badgeType'),
        badgeRisk: document.getElementById('badgeRisk'),
        badgeCallTime: document.getElementById('badgeCallTime'),
        badgeIncident: document.getElementById('badgeIncident'),
        badgeQueueCount: document.getElementById('badgeQueueCount'),

        callTranscript: document.getElementById('callTranscript'),
        fieldAddress: document.getElementById('fieldAddress'),
        fieldDetails: document.getElementById('fieldDetails'),
        fieldVictims: document.getElementById('fieldVictims'),

        queueList: document.getElementById('queueList'),
        toast: document.getElementById('toast'),
        errorBar: document.getElementById('errorBar'),

        canvas: document.getElementById('gridCanvas'),
        dockP1: document.getElementById('dockP1'),
        dockP2: document.getElementById('dockP2'),
        dockF1: document.getElementById('dockF1'),
        dockM1: document.getElementById('dockM1'),
      };

      function fatal(err){
        console.error(err);
        els.errorBar.style.display = 'block';
        els.errorBar.textContent = 'ERRO: ' + (err && err.message ? err.message : String(err));
      }
      window.addEventListener('error', e => fatal(e.error || new Error(e.message)));
      window.addEventListener('unhandledrejection', e => fatal(e.reason || new Error('Promise rejeitada')));

      function toast(msg){
        els.toast.textContent = msg;
        els.toast.classList.add('show');
        clearTimeout(toast._t);
        toast._t = setTimeout(()=>els.toast.classList.remove('show'), 1600);
      }

      // ===== Conte√∫do Variado (Trote / Leve / M√©dio / Grave) =====
      const CITY = { name:"Nova Aurora (Simula√ß√£o)", grid:{w:32,h:18} };

      // pequenos geradores pra variar sem ‚Äúrepetir‚Äù demais
      const NAMES = ["Carlos","Ana","Marcos","Juliana","Paulo","Renata","Gabriel","Bruna","Vitor","Camila"];
      const STREETS = ["Rua Central","Av. das Na√ß√µes","Rua do Mercado","Rua da Esta√ß√£o","Av. Atl√¢ntica","Rua das Flores","Rua S√£o Bento","Av. Independ√™ncia"];
      const PLACES = ["Apto 42","Casa 12","Loja t√©rrea","Esquina","Bloco B","Condom√≠nio","Ponto de √¥nibus","Posto de gasolina"];

      function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
      function randInt(a,b){ return a + Math.floor(Math.random()*(b-a+1)); }

      // severity: low/med/high  |  expected: police/fire/medic/none
      const TEMPLATES = [
        // ===== TROTES (none) =====
        {
          id:"br_prank_kid", region:"BR", number:"190", expected:"none", severity:"prank", isPrank:true,
          title:"Trote (crian√ßa rindo)",
          opening: () => "al√¥? hehe... √©... tem um drag√£o na rua! HAHAHA!",
          address: () => "‚Äî",
          details: () => "Voz infantil, risadas e informa√ß√£o imposs√≠vel.",
          victims: () => "Nenhuma.",
          instructions: () => [{text:"Solicitar informa√ß√µes reais, orientar sobre consequ√™ncias e encerrar.", good:true, note:"Procedimento adequado."}]
        },
        {
          id:"br_prank_pizza", region:"BR", number:"193", expected:"none", severity:"prank", isPrank:true,
          title:"Trote (pedido de pizza)",
          opening: () => "oi... quero uma pizza grande e uma coca. entrega r√°pido!",
          address: () => pick(STREETS)+", "+randInt(10,999)+", "+pick(PLACES)+".",
          details: () => "Pessoa insiste que √© 'pedido' e n√£o emerg√™ncia.",
          victims: () => "Nenhuma.",
          instructions: () => [{text:"Informar que √© linha de emerg√™ncia e encerrar.", good:true, note:"Evita desperd√≠cio."}]
        },

        // ===== LEVES =====
        {
          id:"br_low_noise", region:"BR", number:"190", expected:"police", severity:"low", isPrank:false,
          title:"Perturba√ß√£o do sossego (barulho)",
          opening: () => "190? Meu vizinho t√° com som alto desde cedo, n√£o consigo dormir!",
          address: () => pick(STREETS)+", "+randInt(10,999)+", "+pick(PLACES)+".",
          details: () => "Som alto e discuss√£o. Sem amea√ßa imediata aparente.",
          victims: () => "Sem feridos.",
          instructions: () => [
            {text:"Manter dist√¢ncia e evitar confronto direto.", good:true, note:"Reduz risco de escalada."},
            {text:"Ir l√° e quebrar o som.", good:false, note:"Isso aumenta o conflito."}
          ]
        },
        {
          id:"us_low_minor_crash", region:"US", number:"911", expected:"police", severity:"low", isPrank:false,
          title:"Batida leve (sem feridos aparentes)",
          opening: () => "911, a car hit me at a stop sign. I think no one is hurt.",
          address: () => randInt(100,999)+" "+pick(["Pine St","Oak Ave","River Rd","Market St"]) + ", "+pick(PLACES)+".",
          details: () => "Dois carros com danos leves. Via parcialmente bloqueada.",
          victims: () => "Sem feridos aparentes.",
          instructions: () => [
            {text:"Se seguro, mover ve√≠culos para local seguro e sinalizar.", good:true, note:"Evita novo acidente."},
            {text:"Ficar parado no meio da via para discutir.", good:false, note:"Perigoso."}
          ]
        },

        // ===== M√âDIOS =====
        {
          id:"eu_med_fire_small", region:"EU", number:"112", expected:"fire", severity:"med", isPrank:false,
          title:"Fogo pequeno (lixeira/curto-circuito)",
          opening: () => "112! Tem fogo pequeno na √°rea comum. Muita fuma√ßa, mas parece control√°vel.",
          address: () => pick(STREETS)+", "+randInt(10,999)+", "+pick(["pr√©dio","hall","garagem","escada"]) + ".",
          details: () => "Fuma√ßa moderada e cheiro forte. Pessoas evacuando.",
          victims: () => "Poss√≠vel inala√ß√£o de fuma√ßa.",
          instructions: () => [
            {text:"Evacuar e fechar portas para conter fuma√ßa.", good:true, note:"Conten√ß√£o b√°sica correta."},
            {text:"Usar elevador para sair r√°pido.", good:false, note:"Risco em inc√™ndio."}
          ]
        },
        {
          id:"br_med_domestic", region:"BR", number:"190", expected:"police", severity:"med", isPrank:false,
          title:"Viol√™ncia dom√©stica (poss√≠vel agress√£o)",
          opening: () => "190... eu ouvi gritos no apartamento ao lado, parece que ele t√° batendo nela!",
          address: () => pick(STREETS)+", "+randInt(10,999)+", "+pick(PLACES)+".",
          details: () => "Gritos, choro e barulhos de impacto. Situa√ß√£o inst√°vel.",
          victims: () => "1 poss√≠vel v√≠tima.",
          instructions: () => [
            {text:"N√£o intervir fisicamente; manter dist√¢ncia e aguardar viatura.", good:true, note:"Protege o denunciante."},
            {text:"Arrombar a porta sozinho.", good:false, note:"Risco elevado ao denunciante."}
          ]
        },

        // ===== GRAVES =====
        {
          id:"br_high_fire_gas", region:"BR", number:"193", expected:"fire", severity:"high", isPrank:false,
          title:"Inc√™ndio + cheiro de g√°s (apto)",
          opening: () => "193, tem fuma√ßa saindo da cozinha do apartamento do meu vizinho! Sinto cheiro de g√°s!",
          address: () => pick(STREETS)+", "+randInt(10,999)+", "+pick(["Bloco B, Apto 42","Apto 12","cobertura","t√©rreo"]) + ".",
          details: () => "Muita fuma√ßa, poss√≠vel fogo no fog√£o. O morador n√£o responde.",
          victims: () => "1 poss√≠vel v√≠tima presa.",
          instructions: () => [
            {text:"Evacue o corredor e n√£o use elevador.", good:true, note:"Procedimento correto em inc√™ndio."},
            {text:"Entre e procure a v√≠tima rapidamente.", good:false, note:"Perigo por fuma√ßa e g√°s."}
          ]
        },
        {
          id:"us_high_choking", region:"US", number:"911", expected:"medic", severity:"high", isPrank:false,
          title:"Engasgo grave (adulto)",
          opening: () => "911, my dad is choking! He can't breathe!",
          address: () => randInt(100,999)+" "+pick(["Pine Street","Hill Avenue","Broadway","Lake Road"]) + ", "+pick(PLACES)+".",
          details: () => "Ele estava comendo e agora n√£o consegue falar nem tossir.",
          victims: () => "1 adulto consciente, sufocando.",
          instructions: () => [
            {text:"Fa√ßa compress√µes abdominais (Heimlich) se souber.", good:true, note:"Conduta adequada em engasgo grave."},
            {text:"D√™ √°gua imediatamente.", good:false, note:"Pode piorar."}
          ]
        },
        {
          id:"eu_high_robbery", region:"EU", number:"112", expected:"police", severity:"high", isPrank:false,
          title:"Assalto em andamento (arma)",
          opening: () => "112! Tem um assalto acontecendo, estou escondido e ele tem uma arma!",
          address: () => pick(STREETS)+", "+randInt(10,999)+", "+pick(["loja t√©rrea","farm√°cia","mercado","lanchonete"]) + ".",
          details: () => "Suspeito armado exigindo dinheiro. Clientes no local.",
          victims: () => "Ref√©ns potenciais, risco alto.",
          instructions: () => [
            {text:"Fique escondido e em sil√™ncio.", good:true, note:"Evita escalada."},
            {text:"Confronte o suspeito.", good:false, note:"Aumenta risco de viol√™ncia."}
          ]
        }
      ];

      // pesos para variedade (mais leves, menos graves, trotes raros mas presentes)
      const WEIGHTS = {
        prank: 0.12, // 12%
        low:   0.45, // 45%
        med:   0.28, // 28%
        high:  0.15  // 15%
      };

      function chooseTemplateWeighted(){
        const r = Math.random();
        let bucket = 'low';
        let acc = 0;
        const order = ['prank','low','med','high'];
        for (const k of order){
          acc += WEIGHTS[k];
          if (r <= acc){ bucket = k; break; }
        }
        const list = TEMPLATES.filter(t => t.severity === bucket);
        return list.length ? list[Math.floor(Math.random()*list.length)] : TEMPLATES[Math.floor(Math.random()*TEMPLATES.length)];
      }

      function severityLabel(sev){
        if (sev==='prank') return {txt:'TROTE', cls:'neutral'};
        if (sev==='low') return {txt:'LEVE', cls:'low'};
        if (sev==='med') return {txt:'M√âDIA', cls:'med'};
        return {txt:'GRAVE', cls:'high'};
      }

      function typeLabel(expected){
        if (expected==='police') return {txt:'Pol√≠cia', cls:'neutral'};
        if (expected==='fire') return {txt:'Bombeiros', cls:'neutral'};
        if (expected==='medic') return {txt:'M√©dico', cls:'neutral'};
        return {txt:'Indefinido', cls:'neutral'};
      }

      // ===== Estado =====
      const state = {
        city: CITY,
        running:false,
        paused:false,
        score:0,
        shiftTotal: 6*60,
        shiftRemaining: 6*60,
        queue: [],
        selectedQueueId: null,
        activeCall: null,
        incidents: [],
        selectedIncidentId: null,
        units: [
          { id:'P1', type:'police', x:3, y:4, status:'available', target:null },
          { id:'P2', type:'police', x:24, y:12, status:'available', target:null },
          { id:'F1', type:'fire',   x:28, y:4, status:'available', target:null },
          { id:'M1', type:'medic',  x:16, y:4, status:'available', target:null },
        ],
        _id:0,
        _spawn:0,
        typing: { busy:false, queue:[] },
        ui: { currentCallId:null }
      };

      function nextId(prefix){
        state._id += 1;
        return prefix + '_' + String(state._id).padStart(4,'0');
      }
      function fmt(sec){
        sec = Math.max(0, Math.floor(sec));
        const m = Math.floor(sec/60);
        const s = sec%60;
        return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
      }

      // ===== M√°quina de escrever (fila) =====
      function clearTranscript(){
        els.callTranscript.innerHTML = '';
      }
      function appendLine(kind, text, typed=true){
        const div = document.createElement('div');
        div.className = 'line ' + kind;
        const span = document.createElement('span');
        div.appendChild(span);
        if (typed){
          const caret = document.createElement('span');
          caret.className = 'typingCaret';
          div.appendChild(caret);
          els.callTranscript.appendChild(div);
          els.callTranscript.scrollTop = els.callTranscript.scrollHeight;

          state.typing.queue.push({ span, caret, text, speed: 14 + Math.random()*10 }); // chars/seg
          runTypingQueue();
        } else {
          span.textContent = text;
          els.callTranscript.appendChild(div);
          els.callTranscript.scrollTop = els.callTranscript.scrollHeight;
        }
      }

      function runTypingQueue(){
        if (state.typing.busy) return;
        state.typing.busy = true;

        const job = state.typing.queue.shift();
        if (!job){
          state.typing.busy = false;
          return;
        }

        const { span, caret, text, speed } = job;
        span.textContent = '';
        let i = 0;
        let last = performance.now();

        function step(now){
          const dt = Math.min(0.05, (now - last)/1000);
          last = now;

          // quantos chars por frame
          const add = Math.max(1, Math.floor(speed * dt * 3));
          i = Math.min(text.length, i + add);
          span.textContent = text.slice(0, i);
          els.callTranscript.scrollTop = els.callTranscript.scrollHeight;

          if (i >= text.length){
            if (caret && caret.parentNode) caret.parentNode.removeChild(caret);
            state.typing.busy = false;
            runTypingQueue();
            return;
          }
          requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }

      // ===== UI/HUD =====
      function renderHUD(){
        els.hudCity.textContent = state.city.name;
        els.hudShift.textContent = fmt(state.shiftRemaining);
        els.hudScore.textContent = String(state.score);
        els.badgeQueueCount.textContent = String(state.queue.length);

        if (!state.activeCall){
          els.badgeType.textContent = '‚Äî';
          els.badgeType.className = 'badge neutral';
          els.badgeRisk.textContent = '‚Äî';
          els.badgeRisk.className = 'badge';
          els.badgeCallTime.textContent = 'Tempo 00:00';
        } else {
          const sev = severityLabel(state.activeCall.template.severity);
          const typ = typeLabel(state.activeCall.template.expected);

          els.badgeType.textContent = typ.txt;
          els.badgeType.className = 'badge ' + typ.cls;

          els.badgeRisk.textContent = sev.txt;
          els.badgeRisk.className = 'badge ' + (sev.cls || 'neutral');

          els.badgeCallTime.textContent = 'Tempo ' + fmt(state.activeCall.elapsed);
        }

        els.badgeIncident.textContent = state.selectedIncidentId ? 'Incidente: '+state.selectedIncidentId : 'Incidente: ‚Äî';

        // bot√µes: s√≥ habilitar a√ß√µes quando h√° chamada
        const hasCall = !!state.activeCall;
        els.btnAskAddress.disabled = !hasCall;
        els.btnAskDetails.disabled = !hasCall;
        els.btnAskVictims.disabled = !hasCall;
        els.btnGiveInstructions.disabled = !hasCall;
        els.btnMarkPrank.disabled = !hasCall;
        els.btnHold.disabled = !hasCall;
        els.btnEndCall.disabled = !hasCall;
      }

      function renderQueue(){
        els.queueList.innerHTML = '';
        state.queue.forEach(call=>{
          const div = document.createElement('div');
          div.className = 'qItem' + (state.selectedQueueId===call.id ? ' selected':'');
          div.dataset.id = call.id;

          const sev = call.template.severity;
          const tagClass = sev==='prank' ? 'prank' : sev;
          const tagLabel = sev==='prank' ? 'TROTE' : (sev==='low'?'LEVE':(sev==='med'?'M√âDIA':'GRAVE'));

          div.innerHTML = `
            <div class="qTop">
              <div class="qId">${call.template.region}_${call.template.id}</div>
              <div class="qMeta">
                <span class="tag ${tagClass}">${tagLabel}</span>
                <span class="tag">${fmt(call.waiting)}</span>
              </div>
            </div>
            <div class="qText">${call.preview}</div>
            <div class="qFooter">Toque para selecionar ‚Ä¢ N√∫mero ${call.template.number}</div>
          `;
          els.queueList.appendChild(div);
        });
      }

      function updateFields(){
        const c = state.activeCall;
        if (!c){
          els.fieldAddress.textContent = '‚Äî';
          els.fieldDetails.textContent = '‚Äî';
          els.fieldVictims.textContent = '‚Äî';
          return;
        }
        els.fieldAddress.textContent = c.collected.address || '‚Äî';
        els.fieldDetails.textContent = c.collected.details || '‚Äî';
        els.fieldVictims.textContent = c.collected.victims || '‚Äî';
      }

      // ===== Gera√ß√£o e Fluxo =====
      function seedQueue(){
        if (state.queue.length>=3) return;
        spawnCall(); spawnCall(); spawnCall();
        if (!state.selectedQueueId && state.queue.length>0) state.selectedQueueId = state.queue[0].id;
      }

      function spawnCall(){
        const tpl = chooseTemplateWeighted();
        const id = nextId('CALL');

        const opening = (typeof tpl.opening === 'function') ? tpl.opening() : tpl.opening;
        const preview = `${tpl.number}, ${tpl.title}\n${opening.slice(0, 92)}${opening.length>92?'‚Ä¶':''}`;

        state.queue.push({
          id,
          template: tpl,
          elapsed:0,
          waiting:0,
          collected:{address:'',details:'',victims:''},
          incidentCreated:false,
          // texto base gerado por fun√ß√£o (para variar)
          gen:{
            opening,
            address: (typeof tpl.address === 'function') ? tpl.address() : tpl.address,
            details: (typeof tpl.details === 'function') ? tpl.details() : tpl.details,
            victims: (typeof tpl.victims === 'function') ? tpl.victims() : tpl.victims
          },
          preview
        });
      }

      function openCallUI(call){
        state.ui.currentCallId = call.id;
        clearTranscript();
        appendLine('sys', `Linha ${call.template.number} conectada (${call.template.region}).`, true);

        // sauda√ß√£o padr√£o (simula protocolo)
        let greet = '';
        if (call.template.region === 'BR'){
          greet = `${call.template.number}, emerg√™ncia. Qual sua ocorr√™ncia?`;
        } else if (call.template.region === 'US'){
          greet = `${call.template.number}, what is your emergency?`;
        } else {
          greet = `${call.template.number}, qual sua emerg√™ncia?`;
        }
        appendLine('op', `Operador: ${greet}`, true);

        appendLine('cl', `Chamador: ${call.gen.opening}`, true);
        updateFields();
      }

      function answerSelected(){
        if (!state.running){ toast('Clique em ‚ÄúIniciar turno‚Äù primeiro.'); return; }
        if (state.activeCall){ toast('J√° existe uma chamada ativa.'); return; }
        if (state.queue.length===0){ toast('Fila vazia.'); return; }

        let id = state.selectedQueueId;
        let idx = state.queue.findIndex(c=>c.id===id);
        if (idx<0){ idx = 0; id = state.queue[0].id; state.selectedQueueId = id; }

        const call = state.queue.splice(idx,1)[0];
        state.activeCall = call;
        state.selectedQueueId = state.queue[0]?.id || null;

        openCallUI(call);
        toast('Chamada atendida.');
      }

      function maybeCreateIncident(){
        const c = state.activeCall;
        if (!c || c.incidentCreated) return;

        // Se for trote, N√ÉO cria incidente
        if (c.template.isPrank){
          return;
        }

        // S√≥ cria quando tem o m√≠nimo: endere√ßo + detalhes
        if (!c.collected.address || !c.collected.details) return;

        const incId = nextId('INC');
        const x = 2 + Math.floor(Math.random()*(CITY.grid.w-4));
        const y = 2 + Math.floor(Math.random()*(CITY.grid.h-4));

        // tempo de resolu√ß√£o depende da gravidade
        let resolveBase = 7;
        if (c.template.severity === 'low') resolveBase = 6;
        if (c.template.severity === 'med') resolveBase = 9;
        if (c.template.severity === 'high') resolveBase = 12;

        state.incidents.push({
          id: incId,
          expected: c.template.expected,
          severity: c.template.severity,
          x,y,
          status:'waiting',
          assigned:null,
          resolve: resolveBase + Math.random()*6
        });
        state.selectedIncidentId = incId;
        c.incidentCreated = true;

        appendLine('sys', `Incidente registrado: ${incId}. Selecione o ‚Äú!‚Äù no mapa e despache a unidade correta.`, true);
        toast('Incidente criado no mapa.');
      }

      function ask(kind){
        const c = state.activeCall;
        if (!c){ toast('Nenhuma chamada ativa.'); return; }

        if (kind==='address'){
          appendLine('op', 'Operador: Qual √© o endere√ßo exato?', true);
          // trote: pode responder ‚Äúconfuso‚Äù
          if (c.template.isPrank){
            appendLine('cl', 'Chamador: ah‚Ä¶ n√£o sei‚Ä¶ √©‚Ä¶ perto do‚Ä¶ drag√£o!', true);
            c.collected.address = ''; // n√£o coleta
            appendLine('sys', 'Sinal de alerta: endere√ßo inconsistente.', true);
          } else {
            appendLine('cl', 'Chamador: '+c.gen.address, true);
            c.collected.address = c.gen.address;
          }
          toast('Endere√ßo atualizado.');
        }

        if (kind==='details'){
          appendLine('op', 'Operador: Descreva o que est√° acontecendo.', true);
          if (c.template.isPrank){
            appendLine('cl', 'Chamador: ele t√° cuspindo fogo! hahaha!', true);
            c.collected.details = ''; // n√£o coleta
            appendLine('sys', 'Sinal de alerta: detalhes absurdos/inconsistentes.', true);
          } else {
            appendLine('cl', 'Chamador: '+c.gen.details, true);
            c.collected.details = c.gen.details;
          }
          toast('Detalhes atualizados.');
        }

        if (kind==='victims'){
          appendLine('op', 'Operador: H√° v√≠timas/feridos?', true);
          if (c.template.isPrank){
            appendLine('cl', 'Chamador: s√≥ meu videogame que morreu! kkk', true);
            c.collected.victims = '‚Äî';
          } else {
            appendLine('cl', 'Chamador: '+c.gen.victims, true);
            c.collected.victims = c.gen.victims;
          }
          toast('V√≠timas atualizado.');
        }

        updateFields();
        maybeCreateIncident();
      }

      function giveInstructions(){
        const c = state.activeCall;
        if (!c){ toast('Nenhuma chamada ativa.'); return; }

        const opts = (typeof c.template.instructions === 'function') ? c.template.instructions() : (c.template.instructions || []);
        const goodOpt = opts.find(o=>o.good) || opts[0];
        const badOpt = opts.find(o=>!o.good) || opts[0];

        // chance de erro do operador (jogador) n√£o faz sentido: quem escolhe √© voc√™.
        // Ent√£o aqui n√≥s mostramos DUAS op√ß√µes ‚Äúsimuladas‚Äù por vez (voc√™ clica uma √∫nica vez hoje).
        // Nesta fase, o bot√£o aplica a op√ß√£o ‚Äúboa‚Äù automaticamente (para n√£o travar jogabilidade).
        // Depois, quando voc√™ disser ‚ÄúPr√≥ximo‚Äù, eu troco para: duas op√ß√µes clic√°veis (decis√£o real).
        const chosen = goodOpt;

        appendLine('op', 'Operador: '+chosen.text, true);

        // pontua√ß√£o baseada em gravidade
        let bonus = 8;
        if (c.template.severity==='low') bonus = 6;
        if (c.template.severity==='med') bonus = 9;
        if (c.template.severity==='high') bonus = 12;

        if (chosen.good){
          state.score += bonus;
          appendLine('good', `‚úì Correto: ${chosen.note} (+${bonus})`, true);
          toast(`+${bonus} pontos (instru√ß√µes corretas)`);
        } else {
          state.score -= 12;
          appendLine('bad', `‚úó Incorreto: ${chosen.note} (-12)`, true);
          toast('-12 pontos (instru√ß√µes incorretas)');
        }

        updateFields();
        maybeCreateIncident();
      }

      function markPrank(){
        const c = state.activeCall;
        if (!c){ toast('Nenhuma chamada ativa.'); return; }

        appendLine('op', 'Operador: Confirmo poss√≠vel trote. Linha de emerg√™ncia √© para risco real. Encerrando.', true);

        if (c.template.isPrank){
          state.score += 15;
          appendLine('good', '‚úì Trote identificado corretamente. (+15)', true);
          toast('+15 (trote correto)');
        } else {
          state.score -= 25;
          appendLine('bad', '‚úó Era uma ocorr√™ncia real. Penalidade por triagem errada. (-25)', true);
          toast('-25 (triagem errada)');
        }

        appendLine('sys', 'Chamada encerrada.', true);
        state.activeCall = null;
        updateFields();
      }

      function endCall(){
        if (!state.activeCall){ toast('Nenhuma chamada ativa.'); return; }
        appendLine('sys', 'Chamada encerrada pelo operador.', true);
        state.activeCall = null;
        updateFields();
        toast('Chamada finalizada.');
      }

      function holdCall(){
        if (!state.activeCall){ toast('Nenhuma chamada ativa.'); return; }
        appendLine('op', 'Operador: Permane√ßa na linha, por favor.', true);
        toast('Em espera (simulado).');
      }

      // ===== Canvas (mapa grade) =====
      const canvas = els.canvas;
      const ctx = canvas.getContext('2d');

      if (!CanvasRenderingContext2D.prototype.roundRect){
        CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
          const rr = Math.min(r, w/2, h/2);
          this.beginPath();
          this.moveTo(x+rr,y);
          this.arcTo(x+w,y,x+w,y+h,rr);
          this.arcTo(x+w,y+h,x,y+h,rr);
          this.arcTo(x,y+h,x,y,rr);
          this.arcTo(x,y,x+w,y,rr);
          this.closePath();
          return this;
        };
      }

      function resizeCanvas(){
        const rect = canvas.getBoundingClientRect();
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        canvas.width = Math.floor(rect.width * dpr);
        canvas.height = Math.floor(rect.height * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      function cellToPx(cx, cy){
        const rect = canvas.getBoundingClientRect();
        const w = rect.width, h = rect.height;
        const pad = 14;
        const cell = Math.min((w-pad*2)/CITY.grid.w, (h-pad*2)/CITY.grid.h);
        const x = pad + cx*cell;
        const y = pad + cy*cell;
        return {x,y,cell,cx:x+cell/2,cy:y+cell/2,pad};
      }

      function draw(){
        const rect = canvas.getBoundingClientRect();
        const w = rect.width, h = rect.height;
        ctx.clearRect(0,0,w,h);

        const pad = 14;
        const cell = Math.min((w-pad*2)/CITY.grid.w, (h-pad*2)/CITY.grid.h);

        // grid
        ctx.strokeStyle = 'rgba(255,255,255,.07)';
        for (let i=0;i<=CITY.grid.w;i++){
          const x = pad + i*cell;
          ctx.beginPath(); ctx.moveTo(x,pad); ctx.lineTo(x, pad+CITY.grid.h*cell); ctx.stroke();
        }
        for (let j=0;j<=CITY.grid.h;j++){
          const y = pad + j*cell;
          ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(pad+CITY.grid.w*cell, y); ctx.stroke();
        }

        // incidents
        state.incidents.filter(i=>i.status!=='resolved').forEach(inc=>{
          const p = cellToPx(inc.x, inc.y);

          // cor por severidade
          let fill = 'rgba(255,255,255,.12)';
          let stroke = 'rgba(255,255,255,.22)';
          if (inc.severity==='low'){ fill='rgba(61,255,158,.10)'; stroke='rgba(61,255,158,.32)'; }
          if (inc.severity==='med'){ fill='rgba(255,176,32,.12)'; stroke='rgba(255,176,32,.35)'; }
          if (inc.severity==='high'){ fill='rgba(255,77,109,.12)'; stroke='rgba(255,77,109,.40)'; }

          if (inc.id===state.selectedIncidentId){
            fill='rgba(124,247,255,.22)';
            stroke='rgba(124,247,255,.80)';
          }

          ctx.beginPath();
          ctx.fillStyle = fill;
          ctx.strokeStyle = stroke;
          ctx.lineWidth = 2;
          ctx.arc(p.cx,p.cy,16,0,Math.PI*2);
          ctx.fill(); ctx.stroke();

          ctx.fillStyle = '#ffffff';
          ctx.font = '900 14px ui-sans-serif,system-ui';
          ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillText('!', p.cx, p.cy+1);
        });

        // units
        state.units.forEach(u=>{
          const p = cellToPx(u.x, u.y);
          ctx.beginPath();
          const color = u.type==='police' ? 'rgba(129,170,255,.55)' : (u.type==='fire' ? 'rgba(255,77,109,.55)' : 'rgba(61,255,158,.55)');
          ctx.fillStyle = color;
          ctx.strokeStyle = 'rgba(0,0,0,.25)';
          ctx.lineWidth = 2;
          ctx.roundRect(p.x+2, p.y+2, p.cell-4, p.cell-4, 8);
          ctx.fill(); ctx.stroke();

          ctx.fillStyle = '#0b1022';
          ctx.font = '900 11px ui-sans-serif,system-ui';
          ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillText(u.id, p.cx, p.cy+1);
        });
      }

      function hitIncident(px,py){
        for (const inc of state.incidents.filter(i=>i.status!=='resolved')){
          const p = cellToPx(inc.x, inc.y);
          const dx = px - p.cx;
          const dy = py - p.cy;
          if (Math.hypot(dx,dy)<=16) return inc;
        }
        return null;
      }

      canvas.addEventListener('click', (e)=>{
        const r = canvas.getBoundingClientRect();
        const px = (e.clientX - r.left);
        const py = (e.clientY - r.top);
        const hit = hitIncident(px,py);
        if (!hit){
          state.selectedIncidentId = null;
          toast('Nenhum incidente selecionado.');
          return;
        }
        state.selectedIncidentId = hit.id;
        toast('Incidente selecionado: '+hit.id);
      });

      function dispatch(unitId){
        if (!state.selectedIncidentId){ toast('Selecione um incidente (!) no mapa.'); return; }
        const inc = state.incidents.find(i=>i.id===state.selectedIncidentId && i.status!=='resolved');
        if (!inc){ toast('Incidente inv√°lido.'); return; }
        const u = state.units.find(x=>x.id===unitId);
        if (!u || u.status!=='available'){ toast('Unidade indispon√≠vel.'); return; }

        inc.assigned = u.id;
        inc.status = 'enroute';
        u.status = 'enroute';
        u.target = {x:inc.x, y:inc.y, incId:inc.id};

        toast('Despacho: '+u.id+' a caminho.');
      }

      els.dockP1.addEventListener('click', ()=>dispatch('P1'));
      els.dockP2.addEventListener('click', ()=>dispatch('P2'));
      els.dockF1.addEventListener('click', ()=>dispatch('F1'));
      els.dockM1.addEventListener('click', ()=>dispatch('M1'));

      // ===== Simula√ß√£o tempo real =====
      function tick(dt){
        state.queue.forEach(c=>c.waiting += dt);
        if (state.activeCall) state.activeCall.elapsed += dt;

        // Paci√™ncia do chamador (simples): se passar muito tempo sem coletar info, penaliza
        if (state.activeCall && !state.activeCall.template.isPrank){
          const c = state.activeCall;
          // leve: tolera mais; grave: tolera menos
          let limit = 60;
          if (c.template.severity==='low') limit = 95;
          if (c.template.severity==='med') limit = 75;
          if (c.template.severity==='high') limit = 55;

          if (!c._warned && c.elapsed > limit){
            c._warned = true;
            state.score -= 8;
            appendLine('bad', '‚ö† Demora excessiva: tempo perdido e risco aumentado. (-8)', true);
            toast('-8 (demora)');
          }
        }

        // movement + resolve
        const speed = 5; // cells/sec
        state.units.forEach(u=>{
          if (u.status!=='enroute' || !u.target) return;
          u._acc = (u._acc||0) + speed*dt;
          while (u._acc>=1){
            const dx = u.target.x - u.x;
            const dy = u.target.y - u.y;
            if (dx===0 && dy===0) break;
            if (dx!==0) u.x += Math.sign(dx);
            else if (dy!==0) u.y += Math.sign(dy);
            u._acc -= 1;
          }
          if (u.x===u.target.x && u.y===u.target.y){
            u.status='onscene';
            const inc = state.incidents.find(i=>i.id===u.target.incId);
            if (inc && inc.status!=='resolved') inc.status='onscene';
          }
        });

        state.incidents.forEach(inc=>{
          if (inc.status!=='onscene') return;
          inc.resolve -= dt;
          if (inc.resolve<=0){
            const u = state.units.find(x=>x.id===inc.assigned);
            const wrong = u && u.type!==inc.expected;

            // pontua√ß√£o por gravidade
            let base = 22;
            if (inc.severity==='low') base = 18;
            if (inc.severity==='med') base = 26;
            if (inc.severity==='high') base = 35;

            if (wrong){
              const penalty = Math.floor(base * 0.9);
              state.score -= penalty;
              toast(`Falha: unidade errada (-${penalty})`);
              if (state.activeCall) appendLine('bad', `‚ùå Unidade errada causou atraso cr√≠tico. (-${penalty})`, true);
            } else {
              state.score += base;
              toast(`Ocorr√™ncia resolvida (+${base})`);
              if (state.activeCall) appendLine('good', `üìÑ Relat√≥rio: ocorr√™ncia encerrada com sucesso. (+${base})`, true);
            }

            inc.status='resolved';
            if (u){
              u.status='available';
              u.target=null;
            }

            // encerra chamada (se estiver ativa e relacionada)
            if (state.activeCall){
              appendLine('sys', 'Chamada encerrada ap√≥s conclus√£o da ocorr√™ncia.', true);
              state.activeCall = null;
              updateFields();
            }
          }
        });
      }

      // ===== Loop =====
      let last = performance.now();
      function loop(now){
        const dt = Math.min(0.05, (now-last)/1000);
        last = now;

        if (state.running && !state.paused){
          state.shiftRemaining -= dt;
          if (state.shiftRemaining<=0){
            state.shiftRemaining = 0;
            state.running = false;
            toast('Turno finalizado.');
          }

          tick(dt);

          // nova chamada a cada 9s, limita a fila
          state._spawn += dt;
          if (state._spawn>=9){
            state._spawn=0;
            if (state.queue.length<7) spawnCall();
            if (!state.selectedQueueId && state.queue.length>0) state.selectedQueueId = state.queue[0].id;
          }
        }

        renderQueue();
        renderHUD();
        draw();

        requestAnimationFrame(loop);
      }

      // ===== Bot√µes =====
      els.btnStart.addEventListener('click', ()=>{
        try{
          els.btnStart.textContent = 'Turno iniciado ‚úì';
          setTimeout(()=>els.btnStart.textContent='Iniciar turno', 900);

          state.running = true;
          state.paused = false;
          if (state.shiftRemaining<=0) state.shiftRemaining = state.shiftTotal;

          seedQueue();
          toast('Turno iniciado. Selecione uma chamada na fila.');
          console.log('[LCDO] Turno iniciado (OK).');
        }catch(err){ fatal(err); }
      });

      els.btnRestart.addEventListener('click', ()=>{ try{ location.reload(); }catch(err){ fatal(err); } });

      els.btnPause.addEventListener('click', ()=>{
        try{
          state.paused = !state.paused;
          els.btnPause.textContent = state.paused ? 'Continuar' : 'Pausar';
          toast(state.paused ? 'Pausado' : 'Continuando...');
        }catch(err){ fatal(err); }
      });

      els.btnAnswer.addEventListener('click', ()=>{ try{ answerSelected(); }catch(err){ fatal(err); } });
      els.btnAskAddress.addEventListener('click', ()=>{ try{ ask('address'); }catch(err){ fatal(err); } });
      els.btnAskDetails.addEventListener('click', ()=>{ try{ ask('details'); }catch(err){ fatal(err); } });
      els.btnAskVictims.addEventListener('click', ()=>{ try{ ask('victims'); }catch(err){ fatal(err); } });
      els.btnGiveInstructions.addEventListener('click', ()=>{ try{ giveInstructions(); }catch(err){ fatal(err); } });
      els.btnMarkPrank.addEventListener('click', ()=>{ try{ markPrank(); }catch(err){ fatal(err); } });
      els.btnEndCall.addEventListener('click', ()=>{ try{ endCall(); }catch(err){ fatal(err); } });
      els.btnHold.addEventListener('click', ()=>{ try{ holdCall(); }catch(err){ fatal(err); } });

      els.queueList.addEventListener('click', (e)=>{
        const item = e.target.closest('.qItem');
        if (!item) return;
        state.selectedQueueId = item.dataset.id;
        toast('Chamada selecionada. Clique em ‚ÄúAtender selecionada‚Äù.');
      });

      // ===== Init =====
      function initScreen(){
        clearTranscript();
        appendLine('sys', 'Carregado. Clique em ‚ÄúIniciar turno‚Äù.', true);
        updateFields();
        renderHUD();
        draw();
      }

      initScreen();
      requestAnimationFrame(loop);
    })();
  </script>
</body>
</html>